
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#FAF7FF; --card:#FFFFFF; --shadow:0 6px 18px rgba(0,0,0,.08); --t:#222; --muted:#667085; --ring:#9BA6FF; --good:#55C595; --warn:#FFB84D; --bad:#FF7A88;}
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; font-family:"Baloo 2","Noto Sans TC", ui-sans-serif, system-ui, -apple-system, "PingFang TC","Microsoft JhengHei", Arial;
    background: radial-gradient(900px 600px at 110% -10%, #FFE9F3 0%, rgba(255,233,243,0) 60%), radial-gradient(900px 600px at -10% -10%, #E9EDFF 0%, rgba(233,237,255,0) 60%), var(--bg); color:var(--t);}
  .wrap{max-width:980px; margin:0 auto; padding:16px 16px 120px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap}
  .title{ display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-radius:16px; box-shadow:var(--shadow);}
  .title h1{font-size:22px; margin:0; font-weight:700}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; z-index:2; position:relative}
  button{border:0; border-radius:14px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition:transform .05s ease}
  button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#7A86FF, #6C79FF); color:#fff}
  .ghost{background:#fff}
  .success{background:linear-gradient(180deg,#75D7A8,#55C595); color:#fff}
  .leveltab{background:#fff}
  .leveltab.active{background:#EEF0FF; border:1px solid #C9CDFF}
  .hint{margin:10px 0 16px; color:var(--muted); font-size:14px}
  .comic{background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:14px; margin:12px 0}
  .scene{font-size:13px; color:#6b7280; margin-bottom:8px}
  .frames{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .frame{background:#f8fafc; border-radius:14px; padding:10px; min-height:68px; position:relative}
  .who{position:absolute; top:-10px; left:10px; font-size:12px; background:#fff; padding:2px 8px; border-radius:999px; box-shadow:var(--shadow)}
  .teacher{border-left:6px solid #ffb3c1} .learner{border-left:6px solid #b7f0d1}
  .actions{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px}
  .pillbtn{text-align:center; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.06); background:#fff; cursor:pointer; box-shadow:var(--shadow); white-space:nowrap; font-size:16px}
  .pillbtn[data-ans="teacher"]{background:linear-gradient(180deg,#ffffff,#ffe6eb)}
  .pillbtn[data-ans="learner"]{background:linear-gradient(180deg,#ffffff,#eafff2)}
  .pillbtn[data-ans="over"]{background:linear-gradient(180deg,#ffffff,#fff3cf)}
  .result-modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:8; background:rgba(0,0,0,.25)}
  .result-card{background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:18px 20px; width:min(92%,820px); text-align:center}
  .result-card h3{margin:0 0 10px} .result-card .nums{font-size:18px; font-weight:800}
  .result-card .btns{display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap}
  .wronglist{margin-top:12px; text-align:left} .wrongitem{background:#fff9fb; border:1px solid #ffd7e0; border-radius:12px; padding:10px; margin:6px 0}
  .wrongitem .why{font-size:13px; color:#374151; background:#f0fff7; border:1px dashed #bfe8d3; border-radius:10px; padding:8px; margin-top:6px}
  .footerbar{position:fixed; left:0; right:0; bottom:0; z-index:7; display:flex; justify-content:center; padding:10px}
  .footerbar .bar{background:rgba(255,255,255,.85); backdrop-filter: blur(6px); border:1px solid rgba(0,0,0,.06); border-radius:16px; padding:8px; display:flex; gap:8px; box-shadow:var(--shadow)}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.15); display:none; align-items:center; justify-content:center; z-index:9}
  .cardhelp{background:#fff; width:min(92%,900px); border-radius:18px; box-shadow:var(--shadow); padding:16px}
  .helpgrid{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
  .helpitem{background:#fff; border-radius:16px; padding:12px; box-shadow:var(--shadow)}
  .helpitem.teacher{background:linear-gradient(180deg,#fff,#ffe6eb)} .helpitem.learner{background:linear-gradient(180deg,#fff,#eafff2)} .helpitem.over{background:linear-gradient(180deg,#fff,#fff3cf)}
  .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:78px; background:#111; color:#fff; padding:10px 14px; border-radius:999px; font-size:14px; display:none; z-index:10}
  canvas#confetti{position:fixed; inset:0; pointer-events:none; z-index:6}
  .music{display:flex; align-items:center; gap:6px; background:#fff; border-radius:999px; padding:8px 10px; box-shadow:var(--shadow)}
  .music input[type="range"]{width:100px}
  .badge{background:#fff; border:2px dashed #a7f3d0; color:#047857; padding:10px 12px; border-radius:14px; cursor:pointer; box-shadow:var(--shadow);}
  .maptag{display:inline-flex; align-items:center; gap:6px; background:#fff; border-radius:12px; padding:8px 10px; border:1px solid #E0E7FF; box-shadow:var(--shadow);}
  .legend{display:flex; gap:8px; flex-wrap:wrap; font-size:13px; margin:8px 0}
  .tag{padding:2px 8px; border-radius:999px; border:1px solid rgba(0,0,0,.08)}
  .tag.t{background:#ffe6eb} .tag.l{background:#eafff2} .tag.o{background:#fff3cf}
  table{width:100%; border-collapse:collapse; font-size:14px} th,td{padding:8px 10px; border-bottom:1px solid #f1f5f9; vertical-align:top}
  th{text-align:left; color:#475569; font-weight:700}
  @media (max-width:700px){ .frames{grid-template-columns:1fr} .pillbtn{font-size:15px; padding:10px 8px} .helpgrid{grid-template-columns:1fr}
    .result-card{width:min(96%, 900px)} }
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="wrap">
  <header>
    <div class="title">
      <span style="font-size:22px">ğŸ“š</span>
      <h1>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³</h1>
    </div>
    <div class="toolbar">
      <button class="leveltab active" data-level="1">é—œå¡1</button>
      <button class="leveltab" data-level="2">é—œå¡2</button>
      <button class="leveltab" data-level="H">èªªæ˜å°ˆå€</button>
      <button class="badge" id="btnReadFirst">ğŸ‘€ é–‹å§‹éŠæˆ²å‰è«‹çœ‹çœ‹æˆ‘</button>
      <div class="music" id="musicBox">
        ğŸµ
        <button class="ghost" id="btnMusic">æ’­æ”¾</button>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.5" title="éŸ³é‡">
      </div>
    </div>
    <div class="toolbar">
      <button class="ghost" id="btnResetTop">é‡ç½®æœ¬é—œ</button>
      <button class="primary" id="btnSubmitTop">é€å‡ºæœ¬é—œ</button>
      <span class="maptag" id="btnMapTop">ğŸ—ºï¸ğŸ¶ è¿·æ€åœ°åœ–</span>
    </div>
  </header>

  <p class="hint" id="intro">é—œå¡1ï¼šè‡¨åºŠè¿·ä½ åŠ‡æœ¬ï¼ˆæ¯æ¬¡éƒ½æœƒ<b>æ´—ç‰Œ</b>ï¼‰ï¼Œè«‹æŠŠä¸‹åˆ—æƒ…å¢ƒåˆ†é¡ã€‚æœªå¸¶ <code>?tid=</code> èˆ‡ <code>&unit=</code> æœƒè«‹ä½ å…ˆè¼¸å…¥ã€‚</p>

  <div id="quiz"></div>
</div>

<div class="footerbar"><div class="bar">
  <button class="ghost" id="btnResetBottom">é‡ç½®æœ¬é—œ</button>
  <button class="primary" id="btnSubmitBottom">é€å‡ºæœ¬é—œ</button>
  <span class="maptag" id="btnMapBottom">ğŸ—ºï¸ğŸ¶ è¿·æ€åœ°åœ–</span>
</div></div>

<div class="modal" id="helpModal">
  <div class="cardhelp">
    <h3 style="margin:0 0 8px">èªªæ˜å°ˆå€</h3>
    <div class="helpgrid">
      <div class="helpitem teacher"><h4 style="margin:0 0 6px">ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ</h4>
        <div style="font-size:14px; color:#374151">ç”±æ•™å¸«ä¸»å°æµç¨‹ï¼Œå­¸å“¡åƒèˆ‡ä½ï¼›ç‚ºæ±‚æ•ˆç‡è€Œæ¸›å°‘ç·´ç¿’èˆ‡å›é¥‹ã€‚</div>
      </div>
      <div class="helpitem learner"><h4 style="margin:0 0 6px">ğŸŒ± å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰</h4>
        <div style="font-size:14px; color:#374151">ä¾å­¸å“¡èƒ½åŠ›è¨­å®šå¯å§”è¨—ä»»å‹™ã€å³æ™‚å›é¥‹èˆ‡æ¼¸é€²æ”¾æ‰‹ï¼Œåœ¨å®‰å…¨æƒ…å¢ƒä¸­æ‰¿æ“”è²¬ä»»ã€‚</div>
      </div>
      <div class="helpitem over"><h4 style="margin:0 0 6px">ğŸ’— éåº¦åŒ…å®¹ï¼ˆä¸å¥åº·ï¼‰</h4>
        <div style="font-size:14px; color:#374151">æ¨¡ç³Šæ¨™æº–æˆ–å›é¿å›é¥‹ï¼ŒçŸ­æœŸçœ‹ä¼¼ä¿è­·ï¼Œé•·æœŸåè€Œé˜»ç¤™å­¸ç¿’èˆ‡å®‰å…¨ã€‚<br>ğŸ‘‰ è§£å¥—ï¼šçµ¦å…·é«”äº‹å¯¦èˆ‡ä¸‹ä¸€æ­¥å»ºè­°ï¼Œä»¥è¡Œç‚ºç‚ºç„¦é»ã€‚</div>
      </div>
    </div>
    <div style="text-align:right; margin-top:10px"><button class="ghost" id="closeHelp">é—œé–‰</button></div>
  </div>
</div>

<div class="result-modal" id="resultModal">
  <div class="result-card">
    <h3>çµæœ</h3>
    <div class="nums">æœ¬é—œç­”å° <b id="ok">0</b> é¡Œã€ç­”éŒ¯ <b id="bad">0</b> é¡Œã€‚</div>
    <div class="wronglist" id="wronglist"></div>
    <div class="btns">
      <button class="ghost" id="closeResult">é—œé–‰</button>
      <button class="primary" id="retry">å†ç©ä¸€æ¬¡</button>
      <button class="primary" id="goL2">å‰å¾€é—œå¡2</button>
      <span class="maptag" id="btnMapFromModal">ğŸ—ºï¸ğŸ¶ è¿·æ€åœ°åœ–</span>
    </div>
  </div>
</div>

<div class="modal" id="mapModal">
  <div class="cardhelp">
    <h3 style="margin:0 0 8px">ğŸ—ºï¸ è¿·æ€åœ°åœ–ï¼ˆåšéŒ¯çš„é¡Œç›®èˆ‡è§£é‡‹ï¼‰</h3>
    <div class="legend">
      <span class="tag t">æ•™å¸«ä¸­å¿ƒ</span>
      <span class="tag l">å­¸å“¡ä¸­å¿ƒ</span>
      <span class="tag o">éåº¦åŒ…å®¹</span>
    </div>
    <div id="mapContent" style="overflow:auto; max-height:60vh"></div>
    <div style="text-align:right; margin-top:10px"><button class="ghost" id="closeMap">é—œé–‰</button></div>
  </div>
</div>

<div class="modal" id="whoModal" style="display:none">
  <div class="cardhelp" style="max-width:520px">
    <h3 style="margin:0 0 8px">è«‹å…ˆè¼¸å…¥è­˜åˆ¥è³‡è¨Š</h3>
    <div style="display:grid; gap:10px">
      <label>æ•™å¸«å§“åï¼ˆå¿…å¡«ï¼‰
        <input id="inTid" class="ghost" style="width:100%; padding:10px; border-radius:10px; border:1px solid #e5e7eb" placeholder="ä¾‹å¦‚ï¼šç‹å°ç¾">
      </label>
      <label>å–®ä½ / éƒ¨é–€ï¼ˆé¸å¡«ï¼‰
        <input id="inUnit" class="ghost" style="width:100%; padding:10px; border-radius:10px; border:1px solid #e5e7eb" placeholder="ä¾‹å¦‚ï¼šå…§å¤–ç§‘éƒ¨ / æ•™å­¸éƒ¨">
      </label>
    </div>
    <div style="text-align:right; margin-top:10px"><button class="primary" id="saveWho">é–‹å§‹</button></div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>
<audio id="bgm" loop></audio>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzfdyabwrsdhxau9k8IoeBEx4wTd_aCAd8hOh3WyCMJBlN9b4EbetSIkvssAZb5rVt_/exec";
const musicSrc = "https://cdn.pixabay.com/download/audio/2023/03/08/audio_2ac7a1b8f9.mp3?filename=cute-background-142356.mp3";

const usp = new URLSearchParams(location.search);
let TID = usp.get('tid') || '';
let UNIT = usp.get('unit') || '';

const LABELS = { teacher:'æ•™å¸«ä¸­å¿ƒ', learner:'å­¸å“¡ä¸­å¿ƒ', over:'éåº¦åŒ…å®¹' };

const BANKS = {
  1: [
    { id:'L1-01', type:'teacher', scene:'äº¤ç­å‰ 5 åˆ†é˜ï¼Œå€¼ç­ç¹å¿™ã€‚', t:'é€™æ¬¡äº¤ç­æ™‚é–“å¾ˆç·Šï¼Œæˆ‘å…ˆèªªå®Œé‡é»ï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒå†è®“ä½ å˜—è©¦ã€‚', s:'å¥½çš„ã€‚', why:'ä»¥æ™‚é–“å£“åŠ›ç‚ºç”±æ”¶å›ç·´ç¿’ï¼Œæœªè¨­è¨ˆä½é¢¨éšªå¯å§”è¨—ç‰‡æ®µï¼ˆå¦‚ç²¾è¦ç‰ˆäº¤ç­ï¼‰ã€‚' },
    { id:'L1-02', type:'teacher', scene:'ç—…æˆ¿ä¾‹è¡Œè™•ç½®ã€‚', t:'é€™å€‹è­·ç†å¾ˆç°¡å–®ï¼Œæˆ‘åšä¸€æ¬¡ï¼Œå°±æ›ä½ ã€‚', s:'äº†è§£ã€‚', why:'ä»æ˜¯ç¤ºç¯„ç‚ºä¸»ï¼Œæ²’æœ‰è¨­è¨ˆè§€å¯Ÿâ€“å›é¥‹â€“å†å˜—è©¦çš„å¾ªç’°ã€‚' },
    { id:'L1-03', type:'teacher', scene:'é€£çºŒå…©å¤©åœ¨ç›¸åŒæ­¥é©Ÿå¡ä½ã€‚', t:'ä½ å·²ç¶“å¡é€™æ®µç¬¬2æ¬¡ï¼Œéƒ½èªè­˜ç—…äººï¼Œæ‡‰è©²å¯ä»¥è‡ªå·±å»çµ¦è—¥å§ã€‚', s:'â€¦', why:'ä»¥ä¸»è§€æ„Ÿè¦ºæ”¾æ‰‹ï¼Œæœªä»¥åˆ†ç´šæ¨™æº–èˆ‡æƒ…å¢ƒé¢¨éšªä¾†åˆ¤å®šã€‚' },
    { id:'L1-04', type:'teacher', scene:'å¸¶æ•™ä¸€é€±å¾Œã€‚', t:'æˆ‘è¦ºå¾—ä¸€é€±ä¹Ÿå·®ä¸å¤šäº†å§ï¼Œå¯ä»¥æ”¾æ‰‹è®“ä»–åšã€‚', s:'', why:'ä»¥æ™‚é–“ç‚ºä¾æ“šæ”¾æ‰‹ï¼Œæœªå°æ‡‰åˆ°å¯é æœŸæƒ…å¢ƒèˆ‡è¡¨ç¾è­‰æ“šã€‚' },
    { id:'L1-05', type:'learner', scene:'æŠ½è¡€ç·´ç¿’ã€‚', t:'å‰›å‰›çœ‹ä½ æŠ½è¡€é‚„ä¸ç†Ÿï¼Œç­‰ä¸€ä¸‹æˆ‘å†åšä¸€æ¬¡é‚Šèªªæ˜ï¼Œä¸‹ä¸€åºŠæ›ä½ æŠ½è¡€ï¼Œæˆ‘æœƒåœ¨æ—é‚Šå¹«ä½ ã€‚', s:'å¥½ï¼Œè¬è¬è€å¸«ã€‚', why:'å…ˆç¤ºç¯„+ç«‹å³ç·´ç¿’+åœ¨æ—ç›£ç£ï¼Œå‰µé€ å®‰å…¨çš„è²¬ä»»åˆ†ç´šã€‚' },
    { id:'L1-06', type:'learner', scene:'äº¤ç­è¨“ç·´ã€‚', t:'ä½ å…ˆç”¨ ISBAR äº¤ç­ä¸€æ¬¡ï¼Œæˆ‘å€‘éŒ„ä¸‹ä¾†ä¹‹å¾Œä¸€èµ·å›é¡§ã€‚', s:'OKã€‚', why:'ä½¿ç”¨çµæ§‹åŒ–å·¥å…·èˆ‡è‡ªæˆ‘å›é¡§ï¼Œå½¢æˆå›é¥‹å¾ªç’°ã€‚' },
    { id:'L1-07', type:'learner', scene:'äº¤ç­å‰ã€‚', t:'æ˜¨å¤©è¨è«–éäº¤ç­ï¼Œä»Šå¤©äº¤ç­å‰æˆ‘å€‘å…ˆç·´ä¸€æ¬¡ï¼Œæ”¾è¼•é¬†ã€‚', s:'å¥½ã€‚', why:'è¦å¾‹åŒ–çš„çŸ­ç·´ï¼Œé™ä½å¯¦æˆ°ç„¦æ…®ä¸¦æå‡è¡¨ç¾ç©©å®šã€‚' },
    { id:'L1-08', type:'learner', scene:'çµ¦è—¥èˆ‡è¡›æ•™ã€‚', t:'æˆ‘çœ‹ä½ çµ¦è—¥å·²ç¶“é †äº†ï¼Œä½†è¡›æ•™æœ‰æ™‚ä¸é †ï¼Œæ‰€ä»¥å°šæœªåˆ¤å®šç¨ç«‹ï¼›æˆ‘å€‘å…ˆæŠŠè¡›æ•™ç·´å¥½ã€‚', s:'æ˜ç™½ã€‚', why:'ä»¥è­‰æ“šåˆ¤å®šç¨ç«‹èˆ‡å¦ï¼Œé‡å°å¼±é …åŠ å¼·å¾Œå†æ”¾æ‰‹ã€‚' },
    { id:'L1-09', type:'over', scene:'å¸¶æ•™å›é¥‹ã€‚', t:'æ€•æ‰“æ“Šä»–çš„ä¿¡å¿ƒï¼Œå°±èªªåšå¾—ä¸éŒ¯å§ã€‚', s:'', why:'å›é¿å›é¥‹æœƒé˜»ç¤™é€²æ­¥ï¼›æ‡‰é‡å°è¡Œç‚ºèˆ‡çµæœçµ¦å…·é«”å»ºè­°ã€‚' }
  ],
  2: [
    { id:'L2-01', type:'over', scene:'æª¢è¨å­¸ç¿’ç‹€æ…‹ã€‚', t:'ä»–å›å»æ²’è¤‡ç¿’ä¹Ÿæ²’é—œä¿‚ï¼Œä¸‹æ¬¡å†èªªã€‚', s:'', why:'æ¨¡ç³Šæ¨™æº–ã€æ”¾ä»»å»¶å®•ï¼Œç„¡åŠ©æ–¼å­¸ç¿’èˆ‡ç—…äººå®‰å…¨ã€‚' },
    { id:'L2-02', type:'over', scene:'åœ˜éšŠé—œä¿‚ã€‚', t:'ç‚ºäº†ä¸–ç•Œå’Œå¹³ï¼ŒéŒ¯èª¤å°±å…ˆä¸æäº†å§ã€‚', s:'', why:'é¿å…è¡çªè€Œä¸è«‡éŒ¯èª¤ï¼Œæœƒè®“é¢¨éšªæŒçºŒã€‚æ‡‰ç”¨äº‹å¯¦èˆ‡å½±éŸ¿ä¾†å›é¥‹ã€‚' },
    { id:'L2-03', type:'over', scene:'é«˜å£“æƒ…å¢ƒã€‚', t:'ä»–å¥½åƒå¾ˆæ€•ï¼Œæˆ‘æ›´æ€•ï¼Œæˆ‘è‡ªå·±åšå§ã€‚', s:'', why:'å‰å¥ªå­¸ç¿’æ©Ÿæœƒã€‚å¯åˆ‡å‡ºå®‰å…¨ç‰‡æ®µåœ¨ç›£ç£ä¸‹å˜—è©¦ã€‚' },
    { id:'L2-04', type:'teacher', scene:'äº¤ç­æ™‚é–“ç·Šã€‚', t:'ä»Šå¤©äº¤ç­å¾ˆè¶•ï¼Œå°±ä¸è¦è®“å­¸å“¡è¬›äº†ã€‚', s:'', why:'æ™‚é–“å£“åŠ›ä¸‹ä»å¯ç”¨ã€Œé‡é»ç‰ˆäº¤ç­ã€ç¶­æŒç·´ç¿’èˆ‡æŠŠé—œã€‚' },
    { id:'L2-05', type:'teacher', scene:'ç¤ºç¯„å¾Œã€‚', t:'é€™æ¬¡æˆ‘å…ˆåšç¤ºç¯„ï¼Œå­¸å“¡çœ‹å°±å¥½ã€‚', s:'', why:'å–®å‘ç¤ºç¯„ï¼›æ‡‰å®‰æ’è§€å¯Ÿé‡é»èˆ‡éš¨å¾Œçš„ä¸Šæ‰‹ç·´ç¿’ã€‚' },
    { id:'L2-06', type:'teacher', scene:'è¦åŠƒç·´ç¿’ã€‚', t:'ç­‰æˆ‘æœ‰ç©ºå†å¸¶ä»–ç·´ã€‚', s:'', why:'ä»¥æ•™å¸«æ™‚é–“ç‚ºä¸­å¿ƒï¼›å»ºè­°å®‰æ’çŸ­æ™‚æ®µå›ºå®šå¾®ç·´ã€‚' },
    { id:'L2-07', type:'teacher', scene:'ä¸»è§€æ”¾æ‰‹ã€‚', t:'æˆ‘è¦ºå¾—ä»–å·®ä¸å¤šäº†ï¼Œå¯ä»¥æ”¾æ‰‹è®“ä»–åšã€‚', s:'', why:'ç¼ºä¹ç­‰ç´šèˆ‡æƒ…å¢ƒå°ç…§çš„å®¢è§€ä¾æ“šã€‚' },
    { id:'L2-08', type:'learner', scene:'æŠ€èƒ½æ”¯æŒã€‚', t:'æŠ½è¡€æŠ€å·§ä¸ç†Ÿï¼Œæˆ‘å€‘ä»Šå¤©è§€å¯Ÿ3æ¬¡ï¼Œæ¯æ¬¡çµ¦ä½ 2é»å»ºè­°ï¼Œç„¶å¾Œè®“ä½ è‡ªå·±åšä¸€æ¬¡ã€‚', s:'äº†è§£ã€‚', why:'å¯è§€å¯Ÿâ†’å›é¥‹â†’å¯¦ä½œï¼Œé¢¨éšªå—æ§çš„æ¼¸é€²æ”¾æ‰‹ã€‚' },
    { id:'L2-09', type:'learner', scene:'çµæ§‹åŒ–äº¤ç­ã€‚', t:'äº¤ç­å¸¸éºæ¼é‡é»ï¼Œæ”¹ç”¨ ISBAR ä¸¦éŒ„éŸ³å›é¡§ã€‚', s:'å¥½ã€‚', why:'ç”¨çµæ§‹åŒ–å·¥å…·æå‡å“è³ªä¸¦å»ºç«‹å›é¡§ä¾‹è¡Œã€‚' },
    { id:'L2-10', type:'learner', scene:'é¢¨éšªèª¿æ•´ã€‚', t:'æ˜¨å¤©å…©æ¬¡é«˜é¢¨éšªéŒ¯èª¤ï¼Œä»Šå¤©æˆ‘æœƒå…¨ç¨‹é™ªä½ åšä¸€æ¬¡å†æ”¾æ¬Šã€‚', s:'å¥½ã€‚', why:'ä¾é¢¨éšªå‹•æ…‹èª¿æ•´ç›£ç£å¼·åº¦ï¼Œå®‰å…¨å„ªå…ˆã€‚' },
    { id:'L2-11', type:'learner', scene:'å¯é æœŸæƒ…å¢ƒã€‚', t:'å¸¸è¦ç—…äººå·²èƒ½ç©©å®šè™•ç†ï¼Œæˆ‘åœ¨æ—å”åŠ©ä½†ä¸ä»‹å…¥ï¼Œç­‰ä½ é †å†ç¨ç«‹ã€‚', s:'OKã€‚', why:'åœ¨å¯é æœŸæƒ…å¢ƒåŠç›£ç£æ”¾æ‰‹ï¼Œæ˜¯åˆ†ç´šå§”è¨—çš„é—œéµã€‚' },
    { id:'L2-12', type:'learner', scene:'è¡›æ•™åŠ å¼·ã€‚', t:'çµ¦è—¥OKï¼Œä½†è¡›æ•™é‚„éœ€åŠ å¼·ï¼Œå…ˆé‡å°é€™éƒ¨åˆ†ç·´ç¿’ã€‚', s:'å¥½ã€‚', why:'æ‹†åˆ†å¼±é …å¼·åŒ–ï¼Œå¾…é”æ¨™å†æˆæ¬Šç¨ç«‹ã€‚' }
  ]
};

let currentLevel = 1;
let answered = new Map();
let startTimes = new Map();
let submitted = false;
let cachedWrongs = [];
const quiz = document.getElementById('quiz');

const bgm = document.getElementById('bgm'); bgm.src = musicSrc; bgm.volume = 0.5;
document.getElementById('vol').addEventListener('input', e => bgm.volume = +e.target.value);
document.getElementById('btnMusic').addEventListener('click', ()=>{ if (bgm.paused){ bgm.play(); document.getElementById('btnMusic').textContent='æš«åœ'; } else { bgm.pause(); document.getElementById('btnMusic').textContent='æ’­æ”¾'; }});

function logAnswer(payload){ try{ fetch(GAS_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}); }catch(e){} }
function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

function renderLevel(lv){
  currentLevel = lv; answered.clear(); startTimes.clear(); submitted=false; cachedWrongs=[];
  document.getElementById('intro').innerHTML = `é—œå¡${lv}ï¼šè‡¨åºŠè¿·ä½ åŠ‡æœ¬ï¼ˆæ¯æ¬¡éƒ½æœƒ<b>æ´—ç‰Œ</b>ï¼‰ï¼Œè«‹æŠŠä¸‹åˆ—æƒ…å¢ƒåˆ†é¡ã€‚`;
  document.getElementById('resultModal').style.display='none';
  quiz.innerHTML='';
  const items = shuffle(BANKS[lv]);
  items.forEach(item=> quiz.appendChild(comicItem(item)) );
  window.scrollTo({top:0, behavior:'smooth'});
}

function comicItem(item){
  const el = document.createElement('div'); el.className='comic'; el.dataset.id=item.id; el.dataset.type=item.type;
  el.innerHTML = `
    <div class="scene">ğŸ“ ${item.scene}</div>
    <div class="frames">
      <div class="frame teacher"><div class="who">è€å¸«</div>${item.t}</div>
      <div class="frame learner"><div class="who">å­¸å“¡</div>${item.s || 'ï¼ˆâ€¦ï¼‰'}</div>
    </div>
    <div class="actions">
      <div class="pillbtn" data-ans="teacher">ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ</div>
      <div class="pillbtn" data-ans="learner">ğŸŒ± å­¸å“¡ä¸­å¿ƒ</div>
      <div class="pillbtn" data-ans="over">ğŸ’— éåº¦åŒ…å®¹</div>
    </div>
  `;
  startTimes.set(item.id, performance.now());
  el.querySelectorAll('.pillbtn').forEach(btn=>{ btn.addEventListener('click',()=>choose(item, btn.dataset.ans, el)); });
  return el;
}

function choose(item, ans, el){
  answered.set(item.id, ans);
  el.querySelectorAll('.pillbtn').forEach(b=>b.style.outline='');
  el.querySelector(`.pillbtn[data-ans="${ans}"]`).style.outline='3px solid var(--ring)';
  const begin = startTimes.get(item.id) || performance.now();
  const elapsed = Math.max(0, Math.round(performance.now() - begin));
  logAnswer({ tid:TID, unit:UNIT, level:currentLevel, item_id:item.id, chosen:ans, truth:item.type, correct:(ans===item.type), used_hint:0, time_ms:elapsed, device_width:innerWidth, user_agent:navigator.userAgent });
}

function submitLevel(){
  const items = BANKS[currentLevel];
  let correct=0; const wrongs=[];
  items.forEach(it=>{
    const ans = answered.get(it.id);
    if(ans===it.type) correct++;
    else wrongs.push({ id:it.id, should:it.type, scene:it.scene, teacher:it.t, why:it.why, chosen: ans||'(æœªä½œç­”)' });
  });
  cachedWrongs = wrongs;
  document.getElementById('ok').textContent=correct;
  document.getElementById('bad').textContent=items.length - correct;
  const box = document.getElementById('wronglist'); box.innerHTML='';
  if(wrongs.length){
    wrongs.forEach(w=>{
      const label = LABELS[w.should];
      const div = document.createElement('div'); div.className='wrongitem';
      div.innerHTML = `<div><b>æ‡‰åˆ†é¡ï¼š</b>${label}ã€€<span style="color:#6b7280">(${w.id})</span></div>
                       <div style="margin-top:6px"><b>æƒ…å¢ƒï¼š</b>${w.scene}</div>
                       <div style="margin-top:6px"><b>è€å¸«ï¼š</b>${w.teacher}</div>
                       <div class="why"><b>ç‚ºä»€éº¼ï¼Ÿ</b> ${w.why}</div>`;
      box.appendChild(div);
    });
  } else {
    box.innerHTML = `<div class="wrongitem" style="text-align:center">å¤ªå¼·äº†ï¼æœ¬é—œå…¨å° ğŸ‰</div>`;
  }
  document.getElementById('resultModal').style.display='flex'; submitted = true;
  logAnswer({ tid:TID, unit:UNIT, level:currentLevel, item_id:'SUMMARY', chosen:correct + '/' + items.length, truth:'-', correct:true, used_hint:0, time_ms:0, device_width:innerWidth, user_agent:navigator.userAgent });
  celebrate();
}

function renderMap(){
  const host = document.getElementById('mapContent'); host.innerHTML='';
  if(!cachedWrongs.length){ host.innerHTML = `<div class="wrongitem">ç›®å‰å°šç„¡éŒ¯é¡Œã€‚å®Œæˆä¸€é—œå¾Œå†ä¾†çœ‹çœ‹åœ°åœ–ï¼</div>`; return; }
  const rows = cachedWrongs.map(w=>{ 
    const correct = LABELS[w.should];
    const mine = w.chosen==='(æœªä½œç­”)' ? 'æœªä½œç­”' : LABELS[w.chosen];
    return `<tr>
      <td><code>${w.id}</code></td>
      <td>${w.scene}</td>
      <td><span class="tag ${w.should==='teacher'?'t': w.should==='learner'?'l':'o'}">${correct}</span></td>
      <td><span class="tag ${w.chosen==='teacher'?'t': w.chosen==='learner'?'l': w.chosen==='over'?'o':''}">${mine}</span></td>
      <td>${w.why}</td>
    </tr>`;
  }).join('');
  host.innerHTML = `<table>
    <thead><tr><th>é¡Œè™Ÿ</th><th>æƒ…å¢ƒ</th><th>æ­£ç¢º</th><th>ä½ çš„é¸æ“‡</th><th>ç‚ºä»€éº¼æ˜¯æ­£è§£ï¼Ÿ / è§£å¥—ç§˜ç¬ˆ</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
  document.getElementById('mapModal').style.display='flex';
}

// tabs & buttons
document.querySelectorAll('.leveltab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.leveltab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const lv = tab.dataset.level;
    if(lv==='H'){ document.getElementById('helpModal').style.display='flex'; }
    else { renderLevel(Number(lv)); }
  });
});
document.getElementById('btnReadFirst').addEventListener('click', ()=> document.getElementById('helpModal').style.display='flex');
document.getElementById('closeHelp').addEventListener('click', ()=>document.getElementById('helpModal').style.display='none');
document.getElementById('btnResetTop').addEventListener('click', ()=>renderLevel(currentLevel));
document.getElementById('btnResetBottom').addEventListener('click', ()=>renderLevel(currentLevel));
document.getElementById('btnSubmitTop').addEventListener('click', submitLevel);
document.getElementById('btnSubmitBottom').addEventListener('click', submitLevel);
document.getElementById('closeResult').addEventListener('click', ()=>document.getElementById('resultModal').style.display='none');
document.getElementById('retry').addEventListener('click', ()=>{ document.getElementById('resultModal').style.display='none'; renderLevel(currentLevel); });
document.getElementById('goL2').addEventListener('click', ()=>{ document.getElementById('resultModal').style.display='none'; document.querySelectorAll('.leveltab').forEach(t=>t.classList.remove('active')); document.querySelector('.leveltab[data-level="2"]').classList.add('active'); renderLevel(2); });
['btnMapTop','btnMapBottom','btnMapFromModal'].forEach(id=> document.getElementById(id).addEventListener('click', renderMap));
document.getElementById('closeMap').addEventListener('click', ()=> document.getElementById('mapModal').style.display='none');

// confetti
const canvas = document.getElementById('confetti'); const ctx = canvas.getContext('2d');
function resize(){ canvas.width = innerWidth; canvas.height = innerHeight } window.addEventListener('resize', resize); resize();
let pieces = [];
function celebrate(){ pieces = Array.from({length:140}, ()=> ({ x: Math.random()*canvas.width, y: -20-Math.random()*40, r: 6+Math.random()*8, vy: 2+Math.random()*3, vx: (Math.random()-.5)*2.2, a: Math.random()*360, col: ['#FFB3C1','#BDE5D2','#FDE49C','#C9C8FF'][Math.floor(Math.random()*4)] })); let t=0; (function tick(){ ctx.clearRect(0,0,canvas.width,canvas.height); pieces.forEach(p=>{ p.y+=p.vy; p.x+=p.vx; p.a+=5; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a*Math.PI/180); ctx.fillStyle=p.col; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore(); }); if((t++)<180) requestAnimationFrame(tick); else ctx.clearRect(0,0,canvas.width,canvas.height); })(); }

function askWhoIfNeeded(){
  if (TID) return renderLevel(1);
  const m = document.getElementById('whoModal'); m.style.display='flex';
  document.getElementById('saveWho').onclick = ()=>{
    TID = (document.getElementById('inTid').value || '').trim();
    UNIT = (document.getElementById('inUnit').value || '').trim();
    if(!TID){ alert('è«‹è¼¸å…¥æ•™å¸«å§“å'); return; }
    m.style.display='none'; renderLevel(1);
  };
}

const bgmEl = document.getElementById('bgm'); bgmEl.src = musicSrc;
askWhoIfNeeded();
</script>
</body>
</html>
