<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>為什麼要有 EPA？｜快思慢想 ✦（漫畫版＋紀錄＋特效）</title>
<style>
  :root{
    --bg:#FAF7FF;
    --card:#FFFFFF;
    --shadow:0 6px 18px rgba(0,0,0,.08);
    --t:#2b2b2b;
    --muted:#667085;
    --ring:#9BA6FF;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial;
    background:
      radial-gradient(900px 600px at 110% -10%, #FFE9F3 0%, rgba(255,233,243,0) 60%),
      radial-gradient(900px 600px at -10% -10%, #E9EDFF 0%, rgba(233,237,255,0) 60%),
      var(--bg);
    color:var(--t);
  }
  .wrap{max-width:980px; margin:0 auto; padding:16px 16px 120px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap}
  .title{ display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-radius:16px; box-shadow:var(--shadow); }
  .title h1{font-size:20px; margin:0; font-weight:700}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; z-index:2; position:relative}
  button{border:0; border-radius:14px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition:transform .05s ease}
  button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#7A86FF, #6C79FF); color:#fff}
  .ghost{background:#fff}
  .leveltab{background:#fff}
  .leveltab.active{background:#EEF0FF; border:1px solid #C9CDFF}
  .hint{margin:10px 0 16px; color:var(--muted); font-size:14px}

  /* Comic card */
  .comic{background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:14px; margin:12px 0}
  .scene{font-size:13px; color:#6b7280; margin-bottom:8px}
  .frames{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .frame{background:#f8fafc; border-radius:14px; padding:10px; min-height:68px; position:relative}
  .who{position:absolute; top:-10px; left:10px; font-size:12px; background:#fff; padding:2px 8px; border-radius:999px; box-shadow:var(--shadow)}
  .teacher{border-left:6px solid #ffb3c1}
  .learner{border-left:6px solid #b7f0d1}
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .pillbtn{flex:1; text-align:center; padding:10px; border-radius:12px; border:1px solid rgba(0,0,0,.06); background:#fff; cursor:pointer; box-shadow:var(--shadow)}
  .pillbtn[data-ans="teacher"]{background:linear-gradient(180deg,#ffffff,#ffe6eb)}
  .pillbtn[data-ans="learner"]{background:linear-gradient(180deg,#ffffff,#eafff2)}
  .pillbtn[data-ans="over"]{background:linear-gradient(180deg,#ffffff,#fff3cf)}

  /* Result modal centered */
  .result-modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:8; background:rgba(0,0,0,.2)}
  .result-card{background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:18px 20px; width:min(92%,520px); text-align:center}
  .result-card h3{margin:0 0 10px}
  .result-card .nums{font-size:18px; font-weight:800}
  .result-card .btns{display:flex; gap:10px; justify-content:center; margin-top:12px}

  /* Footer submit bar */
  .footerbar{position:fixed; left:0; right:0; bottom:0; z-index:7; display:flex; justify-content:center; padding:10px}
  .footerbar .bar{background:rgba(255,255,255,.85); backdrop-filter: blur(6px); border:1px solid rgba(0,0,0,.06); border-radius:16px; padding:8px; display:flex; gap:8px; box-shadow:var(--shadow)}

  /* Help modal */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.15); display:none; align-items:center; justify-content:center; z-index:9}
  .cardhelp{background:#fff; width:min(92%,680px); border-radius:18px; box-shadow:var(--shadow); padding:16px}
  .helpgrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .helpitem{background:#fff; border-radius:16px; padding:12px; box-shadow:var(--shadow)}
  .helpitem.teacher{background:linear-gradient(180deg,#fff,#ffe6eb)}
  .helpitem.learner{background:linear-gradient(180deg,#fff,#eafff2)}
  .lock{opacity:.6; filter:grayscale(.3)}

  .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:78px; background:#111; color:#fff; padding:10px 14px; border-radius:999px; font-size:14px; display:none; z-index:10}

  /* Confetti canvas */
  canvas#confetti{position:fixed; inset:0; pointer-events:none; z-index:6}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="wrap">
  <header>
    <div class="title">
      <span style="font-size:22px">📚</span>
      <h1>為什麼要有 EPA？｜快思慢想 ✦</h1>
    </div>
    <div class="toolbar">
      <button class="leveltab active" data-level="1">關卡1</button>
      <button class="leveltab" data-level="2">關卡2</button>
      <button class="leveltab" data-level="H">說明專區</button>
    </div>
    <div class="toolbar">
      <button class="ghost" id="btnResetTop">重置本關</button>
      <button class="primary" id="btnSubmitTop">送出本關</button>
    </div>
  </header>

  <p class="hint" id="intro">關卡1：臨床迷你劇本，請把下列情境分類。</p>

  <div id="quiz"></div>
</div>

<!-- Footer submit bar -->
<div class="footerbar">
  <div class="bar">
    <button class="ghost" id="btnResetBottom">重置本關</button>
    <button class="primary" id="btnSubmitBottom">送出本關</button>
  </div>
</div>

<!-- Centered result modal -->
<div class="result-modal" id="resultModal">
  <div class="result-card">
    <h3>結果</h3>
    <div class="nums">本關答對 <b id="ok">0</b> 題、答錯 <b id="bad">0</b> 題。</div>
    <div class="btns">
      <button class="ghost" id="closeResult">關閉</button>
      <button class="primary" id="retry">再玩一次</button>
    </div>
  </div>
</div>

<!-- Help modal -->
<div class="modal" id="helpModal">
  <div class="cardhelp">
    <h3 style="margin:0 0 8px">說明卡</h3>
    <div class="helpgrid">
      <div class="helpitem teacher">
        <h4 style="margin:0 0 6px">教師中心</h4>
        <div style="font-size:14px; color:#374151">由教師主導流程，學員參與低；以時間效率為主，練習與回饋較少。</div>
        <ul style="font-size:14px; margin:8px 0 0; padding-left:18px">
          <li>我先說完重點，之後再讓你嘗試。</li>
          <li>我示範一次，你先看。</li>
        </ul>
      </div>
      <div class="helpitem learner">
        <h4 style="margin:0 0 6px">學員中心</h4>
        <div style="font-size:14px; color:#374151">按學員狀態安排練習、即時回饋與漸進放手，在安全情境下承擔責任。</div>
        <ul style="font-size:14px; margin:8px 0 0; padding-left:18px">
          <li>你先做一次，我在旁觀察，結束給兩點建議。</li>
          <li>先練 ISBAR，錄音後一起回顧。</li>
        </ul>
      </div>
    </div>
    <div style="text-align:right; margin-top:10px"><button class="ghost" id="closeHelp">關閉</button></div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxRrGoxGPoZF318CYE9CyZhs69flPQ1TIdB_2ljhVR2VMUxNY07TpXrWgTiJ3iAlayHSQ/exec";
const usp = new URLSearchParams(location.search);
const TID = usp.get('tid') || '';
const GROUP = usp.get('group') || '';
const PRACTICE = usp.get('practice') === '1'; // 1=可先看說明

// 題庫（漫畫分鏡）
const BANKS = {
  1: [
    { id:'L1-01', type:'teacher', scene:'交班前 5 分鐘，值班繁忙。', t:'這次交班時間很緊，我先說完重點，之後有機會再讓你嘗試。', s:'好的。' },
    { id:'L1-02', type:'teacher', scene:'病房例行處置。', t:'這個護理很簡單，我做一次，就換你。', s:'了解。' },
    { id:'L1-03', type:'teacher', scene:'連續兩天在相同步驟卡住。', t:'你已經卡這段第2次，都認識病人，應該可以自己去給藥吧。', s:'…' },
    { id:'L1-04', type:'teacher', scene:'帶教一週後。', t:'我覺得一週也差不多了吧，可以放手讓他做。', s:'' },
    { id:'L1-05', type:'learner', scene:'抽血練習。', t:'剛剛看你抽血還不熟，等一下我再做一次邊說明，下一床換你抽血，我會在旁邊幫你。', s:'好，謝謝老師。' },
    { id:'L1-06', type:'learner', scene:'交班訓練。', t:'你先用 ISBAR 交班一次，我們錄下來之後一起回顧。', s:'OK。' },
    { id:'L1-07', type:'learner', scene:'交班前。', t:'昨天討論過交班，今天交班前我們先練一次，放輕鬆。', s:'好。' },
    { id:'L1-08', type:'learner', scene:'給藥與衛教。', t:'我看你給藥已經順了，但衛教有時不順，所以尚未判定獨立；我們先把衛教練好。', s:'明白。' },
    { id:'L1-09', type:'over', scene:'帶教回饋。', t:'怕打擊他的信心，就說做得不錯吧。', s:'' }
  ],
  2: [
    { id:'L2-01', type:'over', scene:'檢討學習狀態。', t:'他回去沒複習也沒關係，下次再說。', s:'' },
    { id:'L2-02', type:'over', scene:'團隊關係。', t:'為了世界和平，錯誤就先不提了吧。', s:'' },
    { id:'L2-03', type:'over', scene:'高壓情境。', t:'他好像很怕，我更怕，我自己做吧。', s:'' },
    { id:'L2-04', type:'teacher', scene:'交班時間緊。', t:'今天交班很趕，就不要讓學員講了。', s:'' },
    { id:'L2-05', type:'teacher', scene:'示範後。', t:'這次我先做示範，學員看就好。', s:'' },
    { id:'L2-06', type:'teacher', scene:'規劃練習。', t:'等我有空再帶他練。', s:'' },
    { id:'L2-07', type:'teacher', scene:'主觀放手。', t:'我覺得他差不多了，可以放手讓他做。', s:'' },
    { id:'L2-08', type:'learner', scene:'技能支持。', t:'抽血技巧不熟，我們今天觀察3次，每次給你2點建議，然後讓你自己做一次。', s:'了解。' },
    { id:'L2-09', type:'learner', scene:'結構化交班。', t:'交班常遺漏重點，改用 ISBAR 並錄音回顧。', s:'好。' },
    { id:'L2-10', type:'learner', scene:'風險調整。', t:'昨天兩次高風險錯誤，今天我會全程陪你做一次再放權。', s:'好。' },
    { id:'L2-11', type:'learner', scene:'可預期情境。', t:'常規病人已能穩定處理，我在旁協助但不介入，等你順再獨立。', s:'OK。' },
    { id:'L2-12', type:'learner', scene:'衛教加強。', t:'給藥OK，但衛教還需加強，先針對這部分練習。', s:'好。' }
  ]
};

let currentLevel = 1;
let answered = new Map(); // id -> user choice
let submitted = false;
const quiz = document.getElementById('quiz');

function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',900); }

async function logAnswer(payload){ try{ await fetch(GAS_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}); }catch(e){} }

function renderLevel(lv){
  currentLevel = lv; answered.clear(); submitted=false;
  document.getElementById('intro').textContent = `關卡${lv}：臨床迷你劇本，請把下列情境分類。`;
  document.getElementById('resultModal').style.display='none';
  quiz.innerHTML='';
  BANKS[lv].forEach(item=>{ quiz.appendChild(comicItem(item)); });
  window.scrollTo({top:0, behavior:'smooth'});
}

function comicItem(item){
  const el = document.createElement('div'); el.className='comic'; el.dataset.id=item.id; el.dataset.type=item.type;
  el.innerHTML = `
    <div class="scene">📍 ${item.scene}</div>
    <div class="frames">
      <div class="frame teacher"><div class="who">老師</div>${item.t}</div>
      <div class="frame learner"><div class="who">學員</div>${item.s || '（…）'}</div>
    </div>
    <div class="actions">
      <div class="pillbtn" data-ans="teacher">👩‍🏫 教師中心</div>
      <div class="pillbtn" data-ans="learner">🌱 學員中心</div>
      <div class="pillbtn" data-ans="over">💗 過度包容</div>
    </div>
  `;
  el.querySelectorAll('.pillbtn').forEach(btn=>{ btn.addEventListener('click',()=>choose(item, btn.dataset.ans, el)); });
  return el;
}

function choose(item, ans, el){
  answered.set(item.id, ans);
  el.querySelectorAll('.pillbtn').forEach(b=>b.style.outline='');
  el.querySelector(`.pillbtn[data-ans="${ans}"]`).style.outline='3px solid var(--ring)';
  // log per-item
  logAnswer({
    tid:TID, group:GROUP, level:currentLevel, item_id:item.id,
    chosen:ans, correct:(ans===item.type), used_hint:0, time_ms:0,
    device_width:innerWidth, user_agent:navigator.userAgent
  });
  clickTone();
}

function submitLevel(){
  const items = BANKS[currentLevel];
  let correct=0;
  items.forEach(it=>{ if(answered.get(it.id)===it.type) correct++; });
  document.getElementById('ok').textContent=correct;
  document.getElementById('bad').textContent=items.length - correct;
  document.getElementById('resultModal').style.display='flex';
  submitted = true;
  // summary log
  logAnswer({
    tid:TID, group:GROUP, level:currentLevel, item_id:'SUMMARY',
    chosen:correct + '/' + items.length, correct:true, used_hint:0, time_ms:0,
    device_width:innerWidth, user_agent:navigator.userAgent
  });
  toast('已送出');
  celebrate();
  successTone();
}

// tabs
document.querySelectorAll('.leveltab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.leveltab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const lv = tab.dataset.level;
    if(lv==='H'){
      // Help section lock
      const modal = document.getElementById('helpModal');
      if(submitted || PRACTICE) modal.querySelector('.cardhelp').classList.remove('lock');
      else modal.querySelector('.cardhelp').classList.add('lock');
      modal.style.display='flex';
    } else {
      renderLevel(Number(lv));
    }
  });
});

document.getElementById('closeHelp').addEventListener('click', ()=>document.getElementById('helpModal').style.display='none');
document.getElementById('closeResult').addEventListener('click', ()=>document.getElementById('resultModal').style.display='none');
document.getElementById('retry').addEventListener('click', ()=>{ document.getElementById('resultModal').style.display='none'; renderLevel(currentLevel); });

document.getElementById('btnResetTop').addEventListener('click', ()=>renderLevel(currentLevel));
document.getElementById('btnResetBottom').addEventListener('click', ()=>renderLevel(currentLevel));
document.getElementById('btnSubmitTop').addEventListener('click', submitLevel);
document.getElementById('btnSubmitBottom').addEventListener('click', submitLevel);

const canvas = document.getElementById('confetti');
const ctx = canvas.getContext('2d');
function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
window.addEventListener('resize', resize); resize();
let pieces = [];
function celebrate(){
  pieces = Array.from({length:140}, ()=> ({
    x: Math.random()*canvas.width,
    y: -20 - Math.random()*50,
    r: 6+Math.random()*8,
    vy: 2+Math.random()*3,
    vx: (Math.random()-.5)*2.5,
    a: Math.random()*360,
    col: ['#FFB3C1','#BDE5D2','#FDE49C','#C9C8FF'][Math.floor(Math.random()*4)]
  }));
  let t=0;
  (function tick(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pieces.forEach(p=>{ p.y+=p.vy; p.x+=p.vx; p.a+=5;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a*Math.PI/180);
      ctx.fillStyle=p.col; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore();
    });
    if((t++)<180) requestAnimationFrame(tick); else ctx.clearRect(0,0,canvas.width,canvas.height);
  })();
}

// Simple WebAudio tones (無需外部音檔)
let audioCtx;
function ensureAudio(){ if(!audioCtx){ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } }
function tone(freq, dur=0.15, vol=0.06){
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine'; o.frequency.value=freq;
  g.gain.value = vol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  setTimeout(()=>{ o.stop(); }, dur*1000);
}
function clickTone(){ tone(660, 0.06, 0.03); }
function successTone(){
  // 小小升階三音
  setTimeout(()=>tone(523.25,0.12,0.05), 0);
  setTimeout(()=>tone(659.25,0.12,0.05), 120);
  setTimeout(()=>tone(783.99,0.2,0.06), 240);
}

// init
renderLevel(1);
</script>
</body>
</html>
