<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³</title>
<style>
:root{
  --bg:#FFF6F8; --card:#fff; --ink:#1f2937; --muted:#6b7280;
  --brand:#6C79FF; --ok:#21c08b; --warn:#ffb84d; --bad:#ff7a88;
  --pink:#FFE8ED; --green:#E8FFF1; --yellow:#FFF2C6;
  --shadow:0 8px 20px rgba(0,0,0,.06); --radius:18px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:
 radial-gradient(1000px 700px at 85% -10%, #ffe9f3 0, rgba(255,233,243,0) 70%), var(--bg);
 color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Inter","Noto Sans TC","Segoe UI",Roboto,Helvetica,Arial}
.wrap{max-width:900px;margin:0 auto;padding:12px 14px 120px}
.header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.8);backdrop-filter:blur(8px);border-bottom:1px solid rgba(0,0,0,.06)}
.bar{max-width:900px;margin:0 auto;padding:10px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.brand{display:flex;gap:10px;align-items:center;background:var(--card);padding:10px 12px;border-radius:14px;box-shadow:var(--shadow);font-weight:800}
h1{margin:0;font-size:18px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:0;border-radius:12px;padding:10px 14px;background:var(--card);box-shadow:var(--shadow);font-weight:800;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#7A86FF,#6C79FF);color:#fff}
.btn.ghost{background:#fff}
.notice{margin:10px 0 8px;background:#FFF6E6;border:1px dashed #F6C453;color:#7a5600;padding:10px 12px;border-radius:12px;font-weight:700}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06)}
.panel{padding:12px}
.scene{margin:10px 0}
.scene .head{font-weight:800;color:#ef476f;margin-bottom:6px}
.bubble{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:12px;padding:10px;margin:6px 0}
.choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
@media(min-width:640px){.choices{grid-template-columns:repeat(3,1fr)}}
.choice{display:block;text-align:center;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,.06);font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
.choice[data-k="teacher"]{background:linear-gradient(180deg,#fff,#ffe6ea)}
.choice[data-k="learner"]{background:linear-gradient(180deg,#fff,#eafff3)}
.choice[data-k="over"]{background:linear-gradient(180deg,#fff,#fff2da)}
.choice input{display:none}
.choice.active{outline:3px solid #6C79FF}
.footer{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;max-width:920px;width:calc(100% - 16px);z-index:30}
.dock{display:flex;gap:8px;justify-content:flex-end;align-items:center;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border:1px solid rgba(0,0,0,.06);border-radius:16px;box-shadow:var(--shadow);padding:8px}
.pill{padding:8px 12px;border-radius:999px;background:#fff;border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow);font-size:12px;color:#555}
.modal{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);z-index:40;padding:14px;
  overflow:auto; /* é®ç½©å¯æ²å‹• */
}
.sheet{
  background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:14px;max-width:560px;width:100%;
  max-height:calc(100vh - 48px); /* é™é«˜ */
  overflow:auto; /* å…§å®¹å¯æ²å‹• */
}
.sheet h3{margin:6px 0 10px}
.input{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.input input{padding:14px;border:1px solid #e5e7eb;border-radius:12px;font-size:18px} /* æ”¾å¤§å­—é«” */
.small{font-size:12px;color:#6b7280}
.result{display:none;margin-top:10px}
.badlist{display:grid;grid-template-columns:1fr;gap:8px}
.baditem{background:linear-gradient(180deg,#fff,#FFF9FB);border:1px solid #FFE1E6;border-radius:12px;padding:10px}
.baditem .rw{background:#F0FFF7;border:1px dashed #BEE8D2;border-radius:10px;padding:8px;margin-top:6px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111;color:#fff;padding:8px 12px;border-radius:999px;display:none;z-index:60}
/* confetti canvas */
#confetti { position:fixed; inset:0; pointer-events:none; z-index:50; display:none; }
</style>
</head>
<body>
<header class="header">
  <div class="bar">
    <div class="brand">ğŸ“š <h1>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³</h1></div>
    <div class="actions">
      <button class="btn ghost" id="btnL1">é—œå¡ 1</button>
      <button class="btn ghost" id="btnL2">é—œå¡ 2</button>
      <button class="btn primary" id="btnHow">ğŸ‘€ é–‹å§‹éŠæˆ²å‰è«‹çœ‹æˆ‘</button>
      <button class="btn ghost" id="btnAll">ğŸ—ºï¸ å…©é—œåˆ†æ</button>
    </div>
  </div>
</header>

<canvas id="confetti"></canvas>

<div class="wrap">
  <div class="notice">ä»¥ä¸‹å°è©±æƒ…å¢ƒï¼Œä½ è¦ºå¾—æ˜¯ä»¥èª°ç‚ºä¸­å¿ƒå‘¢ï¼Ÿï¼ˆğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ / ğŸŒ± å­¸å“¡ä¸­å¿ƒ / ğŸ’— éåº¦åŒ…å®¹ï¼‰</div>
  <section id="board" class="card panel"></section>

  <section id="resultPanel" class="card panel result">
    <h3>çµæœ</h3>
    <p>æœ¬é—œç­”å° <b id="okn">0</b> é¡Œã€ç­”éŒ¯ <b id="wn">0</b> é¡Œã€‚</p>
    <div id="badlist" class="badlist"></div>
    <div id="afterBtns" style="display:none; margin-top:8px; display:flex; gap:8px;">
      <button class="btn" id="btnGoL2">å‰å¾€é—œå¡ 2</button>
      <button class="btn" id="btnSeeAll">çœ‹å…©é—œéŒ¯èª¤</button>
    </div>
  </section>
</div>

<footer class="footer">
  <div class="dock">
    <span class="pill" id="progress">0 / 0 å·²ä½œç­”</span>
    <button class="btn ghost" id="btnReset">é‡ç½®æœ¬é—œ</button>
    <button class="btn primary" id="btnSubmit">é€å‡ºæœ¬é—œ</button>
  </div>
</footer>

<!-- èº«ä»½è¼¸å…¥ -->
<div id="dlgID" class="modal">
  <div class="sheet">
    <h3>è«‹å…ˆè¼¸å…¥è­˜åˆ¥è³‡è¨Š</h3>
    <div class="input">
      <label>æ•™å¸«å§“åï¼ˆå¿…å¡«ï¼‰</label>
      <input id="inpName" placeholder="ä¾‹å¦‚ï¼šç‹å°ç¾"/>
    </div>
    <div class="input">
      <label>å–®ä½ / éƒ¨é–€ï¼ˆå¿…å¡«ï¼‰</label>
      <input id="inpUnit" placeholder="ä¾‹å¦‚ï¼š11B"/>
      <div class="small">åƒ…ç”¨æ–¼å­¸ç¿’çµ±è¨ˆï¼Œä¸æœƒå°å¤–å…¬é–‹ã€‚</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn primary" id="btnStart">é–‹å§‹</button>
    </div>
  </div>
</div>

<!-- èªªæ˜ -->
<div id="dlgHow" class="modal">
  <div class="sheet">
    <h3>ğŸ‘€ é–‹å§‹å‰è«‹çœ‹æˆ‘</h3>
    <div class="baditem">
      <div><b>ç©æ³•</b></div>
      <div class="rw">è®€æƒ…å¢ƒ â†’ é¸ä¸‰é¡ä¹‹ä¸€ï¼š<b>æ•™å¸«ä¸­å¿ƒ</b> / <b>å­¸å“¡ä¸­å¿ƒ</b> / <b>éåº¦åŒ…å®¹</b>ã€‚é€å‡ºå¾Œæœƒçœ‹åˆ°ã€Œè¿·æ€é»ã€è§£æã€‚</div>
    </div>
    <div class="baditem">
      <div><b>ç²¾ç¥å–Šè©±</b></div>
      <div class="rw">æˆ‘ç›¸ä¿¡æˆ‘æ˜¯<strong>ç¥éšŠå‹</strong>è€å¸«ï¼Œå­¸å¦¹ä¸€å®šèƒ½æ¥ä½æˆ‘å‚³çš„çƒï¼æ”¶å¥½æˆ‘çš„ç™½çœ¼ã€å£“ä½æˆ‘çš„æ·±å‘¼å¸ï¼Œè®“ä»–ç›¸ä¿¡è‡ªå·±é‚„æœ‰æ•‘ï¼ä¸è¦è¡¨éœ²ã€ä¸è¦æ”¾æ£„ï¼Œæˆ‘å€‘éœ€è¦æ–°é®®çš„å¤¥ä¼´ä¸€èµ·ä¸Šç­ã€‚æƒ³æƒ³æˆ‘çš„æ’ç­ã€æƒ³æƒ³æˆ‘çš„ OFF Dayï½ <b>æˆ‘å¯ä»¥ï¼Œä»–ä¹Ÿä¸€å®šå¯ä»¥ï¼</b> ğŸ«¡</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="btnHowClose">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- å…©é—œéŒ¯èª¤å½™æ•´ -->
<div id="dlgAll" class="modal">
  <div class="sheet">
    <h3>å…©å€‹é—œå¡éŒ¯èª¤ï½œå¿«é€Ÿè¤‡ç¿’</h3>
    <div id="allList" class="badlist"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="btnAllClose">é—œé–‰</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">å·²å„²å­˜</div>

<script>
/* ---------- è¨­å®šï¼šæ›æˆä½ æœ€æ–°çš„ Apps Script /exec ---------- */
const GAS_URL = "https://script.google.com/macros/s/AKfycby2IGF6h9U4cxsE6N22ggvOhhyytS5u6v1PX48nMx8zgxZlaZTzsJ_RBTp7Hets4VFbxg/exec";

/* ---------- é¡Œåº« ---------- */
const BANK = {
  1: [
    {id:"L1-01", scene:"äº¤ç­å‰ã€‚", t:"æ˜¨å¤©è¨è«–éäº¤ç­ï¼Œä»Šå¤©äº¤ç­å‰æˆ‘å€‘å…ˆç·´ä¸€æ¬¡ï¼Œæ”¾è¼•é¬†ã€‚", s:"å¥½ã€‚", truth:"learner", why:"ä»¥å­¸å“¡èƒ½åŠ›é…é©ï¼Œå‰µé€ å¯é”æˆçš„ä¼¸å±•ç›®æ¨™ã€‚"},
    {id:"L1-02", scene:"é€£çºŒç…§é¡§ã€‚", t:"ä½ å·²ç¶“å¡é€™æ®µç¬¬ 2 æ¬¡ï¼Œéƒ½èªè­˜ç—…äººï¼Œæ‡‰è©²å¯ä»¥è‡ªå·±å»çµ¦è—¥å§ã€‚", s:"â€¦", truth:"teacher", why:"ä»¥ä¸»è§€æ„Ÿè¦ºæ”¾æ‰‹ï¼Œæœªä¾ç­‰ç´šèˆ‡æƒ…å¢ƒé¢¨éšªåˆ¤æ–·ã€‚"},
    {id:"L1-03", scene:"ç¤ºç¯„èˆ‡æ”¾æ‰‹ã€‚", t:"é€™æ¬¡æˆ‘å…ˆåšç¤ºç¯„ï¼Œä½ çœ‹å°±å¥½ã€‚", s:"â€¦", truth:"teacher", why:"å–®å‘ç¤ºç¯„ï¼›æ‡‰å®‰æ’éš¨å¾Œä¸Šæ‰‹ç·´ç¿’èˆ‡å›é¥‹ã€‚"},
    {id:"L1-04", scene:"äº¤ç­å£“åŠ›ã€‚", t:"ä»Šå¤©äº¤ç­å¾ˆè¶•ï¼Œå°±ä¸è¦è®“å­¸å“¡è¬›äº†ã€‚", s:"â€¦", truth:"teacher", why:"æ™‚é–“å£“åŠ›ä¸‹ä»å¯ç”¨ç²¾è¦ç‰ˆäº¤ç­ï¼Œä¿ç•™ç·´ç¿’èˆ‡æŠŠé—œã€‚"},
    {id:"L1-05", scene:"æŠ½è¡€ç·´ç¿’ã€‚", t:"å‰›å‰›çœ‹ä½ æŠ½è¡€é‚„ä¸ç†Ÿï¼Œç­‰ä¸€ä¸‹æˆ‘å†åšä¸€æ¬¡é‚Šèªªæ˜ï¼Œä¸‹ä¸€åºŠæ›ä½ æŠ½ï¼Œæˆ‘åœ¨æ—å¹«ä½ ã€‚", s:"å¥½ã€‚", truth:"learner", why:"åˆ†æ®µå§”è¨—èˆ‡å³æ™‚å›é¥‹ï¼Œå±¬è²¬ä»»åˆ†ç´šã€‚"},
    {id:"L1-06", scene:"äº¤ç­è¨“ç·´ã€‚", t:"ä½ å…ˆç”¨ ISBAR äº¤ç­ä¸€æ¬¡ï¼Œæˆ‘å€‘éŒ„ä¸‹ä¾†ï¼Œä¹‹å¾Œä¸€èµ·å›é¡§ã€‚", s:"å¥½ï¼", truth:"learner", why:"çµæ§‹åŒ–å·¥å…·ï¼‹è‡ªæˆ‘å›é¡§ï¼Œæå‡å“è³ªã€‚"},
    {id:"L1-07", scene:"äº¤ç­å‰ã€‚", t:"ä½ å…ˆè¬›ç²¾è¦ç‰ˆï¼Œæˆ‘è£œé—œéµä¸¦æ§æ™‚é–“ã€‚", s:"OKï¼", truth:"learner", why:"æ•™å¸«æŠŠé—œé¢¨éšªèˆ‡ç¯€å¥ï¼Œå­¸å“¡ä¿æœ‰ç·´ç¿’ç‰‡æ®µã€‚"},
    {id:"L1-08", scene:"è¡›æ•™å“è³ªã€‚", t:"çµ¦è—¥ OKï¼Œä½†è¡›æ•™éœ€è¦åŠ å¼·ï¼›ç­‰ä¸€ä¸‹æˆ‘å…ˆåšä¸€æ¬¡ä¸¦èªªæ˜ï¼Œä¸‹ä¸€åºŠæ›ä½ ã€‚", s:"å¥½ã€‚", truth:"learner", why:"é‡å°å¼±é …æ‹†è§£ç·´ç¿’ï¼Œé€æ­¥æå‡è‡ªæˆ‘æ•ˆèƒ½ã€‚"},
    {id:"L1-09", scene:"å¸¶æ•™å›é¥‹ã€‚", t:"æ€•æ‰“æ“Šä»–çš„ä¿¡å¿ƒï¼Œå°±èªªåšå¾—ä¸éŒ¯å§ã€‚", s:"â€¦", truth:"over", why:"ä»¥ä¿è­·ç‚ºåè¿´é¿å›é¥‹ï¼Œæ‡‰èšç„¦è¡Œç‚ºèˆ‡ä¸‹ä¸€æ­¥ã€‚"},
  ],
  2: [
    {id:"L2-01", scene:"å­¸ç¿’ç‹€æ…‹ã€‚", t:"æ˜¨å¤©å…©æ¬¡é«˜é¢¨éšªéŒ¯èª¤ï¼Œä»Šå¤©æ”¹å›å…¨ç¨‹ç›£ç£ã€‚", s:"äº†è§£ã€‚", truth:"learner", why:"ä¾é¢¨éšªå‹•æ…‹èª¿æ•´ç›£ç£å¼·åº¦ï¼Œå®‰å…¨å„ªå…ˆã€‚"},
    {id:"L2-02", scene:"åœ˜éšŠé—œä¿‚ã€‚", t:"ç‚ºäº†åœ˜éšŠå’Œå¹³ï¼ŒéŒ¯èª¤å°±å…ˆä¸æäº†ã€‚", s:"â€¦", truth:"over", why:"éœ€è¦ä»¥å®¢è§€äº‹è­‰èˆ‡æ”¹å–„æ­¥é©Ÿæºé€šã€‚"},
    {id:"L2-03", scene:"é«˜å£“æƒ…å¢ƒã€‚", t:"ä»–å¥½åƒå¾ˆæ€•ï¼Œæˆ‘æ›´æ€•â€¦æˆ‘è‡ªå·±åšå§ã€‚", s:"â€¦", truth:"over", why:"å¯åˆ‡å‡ºæœ€å°å®‰å…¨ä»»å‹™ï¼Œåœ¨ç›£ç£ä¸‹å˜—è©¦ã€‚"},
    {id:"L2-04", scene:"äº¤ç­æ™‚é–“ç·Šã€‚", t:"ä»Šå¤©äº¤ç­å¾ˆè¶•ï¼Œå°±ä¸è¦è®“ä½ è¬›äº†ã€‚", s:"â€¦", truth:"teacher", why:"å¯æ¡ç²¾è¦ç‰ˆäº¤ç­ä¸¦è£œé—œéµï¼Œç¶­æŒç·´ç¿’èˆ‡æŠŠé—œã€‚"},
    {id:"L2-05", scene:"ç¤ºç¯„å¾Œã€‚", t:"é€™æ¬¡æˆ‘å…ˆåšç¤ºç¯„ï¼Œä½ çœ‹å°±å¥½ã€‚", s:"å¥½ã€‚", truth:"teacher", why:"ç¤ºç¯„ä¸ç­‰æ–¼ç·´ç¿’ï¼›æ‡‰å®‰æ’è·Ÿåšç‰‡æ®µèˆ‡å›é¥‹ã€‚"},
    {id:"L2-06", scene:"DOPSã€‚", t:"æŠ½è¡€æŠ€å·§ä¸ç†Ÿï¼Œå…ˆç”¨ DOPS é›†ä¸­ç·´ä¸‰æ¬¡ã€‚", s:"å¥½ã€‚", truth:"learner", why:"ç”¨ DOPS é‡å°å–®ä¸€æŠ€èƒ½ç·´ï¼Œæ”¯æ’ EPA ä»»å‹™ã€‚"},
    {id:"L2-07", scene:"è¦åŠƒç·´ç¿’ã€‚", t:"ç­‰æˆ‘æœ‰ç©ºå†å¸¶ä½ ç·´ã€‚", s:"â€¦", truth:"teacher", why:"ä»¥æ•™å¸«æ™‚é–“ç‚ºä¸­å¿ƒï¼›æ‡‰å®‰æ’çŸ­æ™‚æ®µå¾®æ¼”ç·´å»ºç«‹å›é¥‹å¾ªç’°ã€‚"},
    {id:"L2-08", scene:"ä¸»è§€æ”¾æ‰‹ã€‚", t:"æˆ‘è¦ºå¾—å·®ä¸å¤šäº†ï¼Œå¯ä»¥æ”¾æ‰‹è®“ä»–åšã€‚", s:"â€¦", truth:"teacher", why:"æ‡‰ä»¥ç­‰ç´šèˆ‡æƒ…å¢ƒæ¨™æº–ä½è­‰ï¼Œè€Œéæ„Ÿè¦ºã€‚"},
    {id:"L2-09", scene:"çµæ§‹åŒ–äº¤ç­ã€‚", t:"äº¤ç­å¸¸æ¼é‡é»ï¼Œç”¨ ISBAR ç·´ç¿’ä¸¦éŒ„éŸ³å›é¡§ã€‚", s:"æ”¶åˆ°ï¼", truth:"learner", why:"çµæ§‹ï¼‹è‡ªæˆ‘å›é¡§èƒ½æå‡å“è³ªã€‚"},
    {id:"L2-10", scene:"å¯é æœŸæƒ…å¢ƒã€‚", t:"æ­¤ä»»å‹™é›£åº¦é©ä¸­ï¼Œæ­£å¥½æŒ‘æˆ°ä½ çš„ä¸‹ä¸€éšèƒ½åŠ›ã€‚", s:"æƒ³è©¦è©¦ï¼", truth:"learner", why:"ä¼¸å±•ç›®æ¨™ã€å¼·åŒ–è‡ªæˆ‘æ•ˆèƒ½ã€‚"},
    {id:"L2-11", scene:"æŒ‡å°ç­–ç•¥ã€‚", t:"ä½ å…ˆåšä¸€æ¬¡ï¼Œæˆ‘åœ¨æ—å³æ™‚å›é¥‹ï¼Œé‡åˆ°é¢¨éšªæˆ‘æ¥æ‰‹ã€‚", s:"å¥½ï¼", truth:"learner", why:"ç›£ç£å¼·åº¦å¯èª¿ï¼Œä¿å®‰å…¨ä¹Ÿä¿ç·´ç¿’ã€‚"},
    {id:"L2-12", scene:"ä¿è­·å¿ƒæ…‹ã€‚", t:"æ€•ä½ å—æŒ«ï¼Œå°±ä¸èªªå‰›å‰›å“ªè£¡ä¸å¥½ã€‚", s:"â€¦", truth:"over", why:"å›é¿å›é¥‹æœƒé˜»æ–·æˆé•·ï¼Œæ‡‰èšç„¦è¡Œç‚ºèˆ‡å¯æ”¹é€²æ­¥é©Ÿã€‚"},
  ]
};

/* ---------- ç‹€æ…‹ ---------- */
let LEVEL = 1;
let answers = {};         // id -> chosen
let doneLevel = {1:false, 2:false};
let user = {name:"", unit:"", session: "SID-"+Date.now().toString(36)+Math.random().toString(36).slice(2,8)};
let wrongAll = [];        // å…©é—œç´¯ç©éŒ¯é¡Œ

/* ---------- å·¥å…· ---------- */
const $ = s=>document.querySelector(s);
const board = $('#board');
const resultPanel = $('#resultPanel');
const $ok = $('#okn'); const $wn = $('#wn'); const $bad = $('#badlist');
const $after = $('#afterBtns');
const toast = msg => { const t=$('.toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1000); };
const label = k => k==='teacher'?'æ•™å¸«ä¸­å¿ƒ':k==='learner'?'å­¸å“¡ä¸­å¿ƒ':'éåº¦åŒ…å®¹';
const shuffle = a => a.map(x=>[Math.random(),x]).sort((p,q)=>p[0]-q[0]).map(x=>x[1]);

/* ---------- UI ---------- */
function makeCard(q){
  const el=document.createElement('section');
  el.className='scene';
  el.innerHTML = `
    <div class="head">ğŸ“ ${q.scene} <span class="small" style="color:#6b7280">(${q.id})</span></div>
    <div class="bubble">ğŸ‘©â€ğŸ« è€å¸«ï¼š${q.t}</div>
    <div class="bubble">ğŸ‘¤ å­¸å“¡ï¼š${q.s}</div>
    <div class="choices">
      ${['teacher','learner','over'].map(k=>`
        <label class="choice" data-k="${k}">
          <input type="radio" name="${q.id}" value="${k}"/>
          ${k==='teacher'?'ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ':k==='learner'?'ğŸŒ± å­¸å“¡ä¸­å¿ƒ':'ğŸ’— éåº¦åŒ…å®¹'}
        </label>`).join('')}
    </div>`;
  const opts = el.querySelectorAll('.choice');
  opts.forEach(o=>o.addEventListener('click',()=>{
    opts.forEach(x=>x.classList.remove('active'));
    o.classList.add('active');
    const val = o.dataset.k;
    answers[q.id]=val;
    updateProgress();
    // é€é¡Œå›å‚³ï¼ˆå¤±æ•—ä¹Ÿä¸å½±éŸ¿ UIï¼‰
    sendRow({
      timestamp: new Date().toISOString(),
      name:user.name, unit:user.unit, session_id:user.session,
      level: LEVEL, item_id:q.id, truth:q.truth, chosen:val,
      correct: (val===q.truth)?1:0, used_hint:0, time_ms:0,
      device_width: window.innerWidth, user_agent: navigator.userAgent
    });
  }));
  return el;
}

function render(){
  answers = {};
  resultPanel.style.display='none';
  $after.style.display='none';
  board.innerHTML='';
  const items = shuffle(BANK[LEVEL].slice());
  items.forEach(q=> board.appendChild(makeCard(q)));
  updateProgress();
  window.scrollTo({top: document.querySelector('.wrap').offsetTop+10, behavior:'smooth'});
}

function updateProgress(){
  const total = BANK[LEVEL].length;
  const done = Object.keys(answers).length;
  $('#progress').textContent = `${done} / ${total} å·²ä½œç­”`;
}

function submit(){
  const items = BANK[LEVEL];
  const total = items.length;
  if(Object.keys(answers).length<total){ toast('é‚„æœ‰é¡Œç›®æœªä½œç­”å–”'); return; }
  let ok=0; const wrong=[];
  items.forEach(q=>{
    const c = answers[q.id];
    const corr = (c===q.truth);
    if(corr) ok++; else wrong.push({q, chosen:c});
  });
  $ok.textContent = ok; $wn.textContent = total-ok;
  $bad.innerHTML='';
  if(wrong.length===0){
    const div=document.createElement('div'); div.className='bubble'; div.textContent='ğŸ‰ å¤ªå¼·äº†ï¼æœ¬é—œå…¨å°ã€‚';
    $bad.appendChild(div);
  }else{
    wrong.forEach(w=>{
      const div=document.createElement('div'); div.className='baditem';
      div.innerHTML=`
        <div><b>${w.q.scene}</b>ã€€<span class="small" style="color:#6b7280">${w.q.id}</span></div>
        <div class="small">ğŸ‘©â€ğŸ« ${w.q.t}</div>
        <div class="small">ğŸ‘¤ ${w.q.s}</div>
        <div style="margin-top:6px"><b>ä½ çš„ç­”æ¡ˆï¼š</b>${label(w.chosen)}ã€€ï½œã€€<b>æ­£è§£ï¼š</b>${label(w.q.truth)}</div>
        <div class="rw"><b>ç‚ºä»€éº¼ï¼Ÿ</b> ${w.q.why}</div>`;
      $bad.appendChild(div);
    });
  }
  resultPanel.style.display='block';
  // Summaryï¼ˆä¸é˜»å¡ UIï¼‰
  sendRow({
    type:'summary',
    timestamp:new Date().toISOString(),
    name:user.name, unit:user.unit, session_id:user.session,
    level:LEVEL, total:total, correct:ok,
    device_width:window.innerWidth, user_agent:navigator.userAgent
  });

  // è¨˜éŒ„éŒ¯é¡Œåˆ°ç¸½è¡¨
  wrong.forEach(w=> wrongAll.push({level:LEVEL, ...w}));

  // é¡¯ç¤ºå°æµæŒ‰éˆ•
  $after.style.display='flex';
  $('#btnGoL2').style.display = (LEVEL===1 ? 'inline-block':'none');
  $('#btnSeeAll').style.display = (LEVEL===2 ? 'inline-block':'none');

  // æ¨™è¨˜å®Œæˆ
  doneLevel[LEVEL] = true;

  // è‹¥å…©é—œéƒ½å®Œæˆ â†’ ç‘èŠ±ï¼‹æç¤º
  if(doneLevel[1] && doneLevel[2]){
    confettiBoom();
    setTimeout(()=>alert('æ­å–œè€å¸«ï¼Œå®ŒæˆéŠæˆ²ä»»å‹™ï¼'), 400);
  }

  window.scrollTo({top: resultPanel.offsetTop-60, behavior:'smooth'});
}

/* ---------- å…©é—œå½™æ•´ ---------- */
function openAll(){
  const box = $('#allList');
  if(wrongAll.length===0){
    box.innerHTML = `<div class="bubble">å¤ªæ£’å•¦ï¼å…©é—œæ²’æœ‰éŒ¯é¡Œå¯ä»¥æª¢è¨ ğŸ‰</div>`;
  }else{
    box.innerHTML = wrongAll.map(w=>{
      return `<div class="baditem">
        <div><b>Lv${w.level}</b>ï½œ<b>${w.q.scene}</b>ã€€<span class="small" style="color:#6b7280">${w.q.id}</span></div>
        <div class="small">ğŸ‘©â€ğŸ« ${w.q.t}</div>
        <div class="small">ğŸ‘¤ ${w.q.s}</div>
        <div style="margin-top:6px"><b>ä½ çš„ç­”æ¡ˆï¼š</b>${label(w.chosen)}ã€€ï½œã€€<b>æ­£è§£ï¼š</b>${label(w.q.truth)}</div>
        <div class="rw"><b>ç‚ºä»€éº¼ï¼Ÿ</b> ${w.q.why}</div>
      </div>`;
    }).join('');
  }
  document.body.style.overflow = 'hidden';     // é–èƒŒæ™¯
  $('#dlgAll').style.display='flex';
}
function closeAll(){
  $('#dlgAll').style.display='none';
  document.body.style.overflow = '';            // è§£é–èƒŒæ™¯
}

/* ---------- å¾Œå°ï¼šé€å‡ºï¼ˆå…ˆ Beaconï¼Œå‚™æ´ no-cors fetchï¼‰ ---------- */
function sendRow(obj){
  try{
    const payload = JSON.stringify(obj);
    if (navigator.sendBeacon) {
      const blob = new Blob([payload], { type: 'text/plain;charset=UTF-8' });
      navigator.sendBeacon(GAS_URL, blob);
      return;
    }
    fetch(GAS_URL, { method:'POST', mode:'no-cors', body: payload });
  }catch(e){
    // éœé»˜å¿½ç•¥
  }
}

/* ---------- ç‘èŠ± ---------- */
function confettiBoom(){
  const cvs = $('#confetti');
  const ctx = cvs.getContext('2d');
  const W = cvs.width = innerWidth;
  const H = cvs.height = innerHeight;
  cvs.style.display='block';
  const N = 200;
  const P = Array.from({length:N},()=>({
    x:Math.random()*W, y: -20, r:2+Math.random()*4,
    vx:-2+Math.random()*4, vy:2+Math.random()*4,
    c:`hsl(${Math.random()*360},90%,60%)`
  }));
  let t=0;
  (function loop(){
    t++;
    ctx.clearRect(0,0,W,H);
    P.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy; p.vy+=0.06;
      ctx.fillStyle=p.c;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    });
    if(t<240) requestAnimationFrame(loop);
    else cvs.style.display='none';
  })();
}

/* ---------- ç¶å®š ---------- */
window.addEventListener('load', ()=>{
  // èº«ä»½
  const dlg = $('#dlgID'); dlg.style.display='flex'; document.body.style.overflow='hidden';
  $('#btnStart').onclick = ()=>{
    const name = $('#inpName').value.trim();
    const unit  = $('#inpUnit').value.trim();
    if(!name || !unit){ toast('è«‹å®Œæ•´å¡«å¯«å§“åèˆ‡å–®ä½'); return; }
    user.name=name; user.unit=unit;
    dlg.style.display='none'; document.body.style.overflow='';
    render();
    // æ‰“é–‹èªªæ˜
    $('#dlgHow').style.display='flex';
    document.body.style.overflow='hidden';
  };

  // èªªæ˜
  $('#btnHow').onclick = ()=>{
    $('#dlgHow').style.display='flex';
    document.body.style.overflow='hidden';
  };
  $('#btnHowClose').onclick = ()=>{
    $('#dlgHow').style.display='none';
    document.body.style.overflow='';
  };

  // å…©é—œå½™æ•´
  $('#btnAll').onclick = openAll;
  $('#btnAllClose').onclick = closeAll;

  // é—œå¡
  $('#btnL1').onclick = ()=>{ LEVEL=1; render(); };
  $('#btnL2').onclick = ()=>{
    if(!doneLevel[1]) { alert('è«‹å…ˆå®Œæˆç¬¬ä¸€é—œæš–æš–èº«'); return; }
    LEVEL=2; render();
  };
  $('#btnReset').onclick = ()=> render();
  $('#btnSubmit').onclick = ()=> submit();

  // çµæœå€å°æµæŒ‰éˆ•
  $('#btnGoL2').onclick = ()=>{ LEVEL=2; render(); };
  $('#btnSeeAll').onclick = openAll;

  // é»é®ç½©é—œé–‰ï¼ˆæ‰€æœ‰ modalï¼‰
  document.querySelectorAll('.modal').forEach(modal=>{
    modal.addEventListener('click', e=>{
      if(e.target===modal){
        modal.style.display='none';
        document.body.style.overflow='';
      }
    });
  });
});
</script>
</body>
</html>
