<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>為什麼要有 EPA？｜快思慢想</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#FAF7FF; --card:#FFFFFF; --shadow:0 6px 18px rgba(0,0,0,.08); --t:#222; --muted:#667085; --ring:#9BA6FF; --good:#55C595; --warn:#FFB84D; --bad:#FF7A88; --highlight1:#FFD89C; --highlight2:#FF9EC7; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; font-family:"Baloo 2","Noto Sans TC", ui-sans-serif, system-ui, -apple-system, "PingFang TC","Microsoft JhengHei", Arial;
    background: radial-gradient(900px 600px at 110% -10%, #FFE9F3 0%, rgba(255,233,243,0) 60%), radial-gradient(900px 600px at -10% -10%, #E9EDFF 0%, rgba(233,237,255,0) 60%), var(--bg); color:var(--t);}
  .wrap{max-width:980px; margin:0 auto; padding:16px 16px 120px; padding-top:0}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin:2px 0 10px; flex-wrap:wrap}
  .title{ display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-radius:16px; box-shadow:var(--shadow); margin:4px 0}
  .title h1{font-size:22px; margin:0; font-weight:700}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; z-index:2; position:relative; align-items:center}
  button{border:0; border-radius:14px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition:transform .05s ease}
  button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#7A86FF, #6C79FF); color:#fff}
  .ghost{background:#fff}
  .leveltab{background:#fff}
  .leveltab.active{background:#EEF0FF; border:1px solid #C9CDFF}
  .callout{background:linear-gradient(180deg,var(--highlight2), var(--highlight1)); color:#5c1b2a; border:1px solid #ffc6df; box-shadow:0 10px 26px rgba(255,80,140,.25);}
  .callout span{font-weight:800}
  .comic{background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:14px; margin:12px 0}
  .scene{font-size:13px; color:#6b7280; margin-bottom:8px}
  .frames{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .frame{background:#f8fafc; border-radius:14px; padding:10px; min-height:68px; position:relative}
  .who{position:absolute; top:-10px; left:10px; font-size:12px; background:#fff; padding:2px 8px; border-radius:999px; box-shadow:var(--shadow)}
  .teacher{border-left:6px solid #ffb3c1} .learner{border-left:6px solid #b7f0d1}
  .actions{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px}
  .pillbtn{text-align:center; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.06); background:#fff; cursor:pointer; box-shadow:var(--shadow); white-space:nowrap; font-size:16px}
  .pillbtn[data-ans="teacher"]{background:linear-gradient(180deg,#ffffff,#ffe6eb)}
  .pillbtn[data-ans="learner"]{background:linear-gradient(180deg,#ffffff,#eafff2)}
  .pillbtn[data-ans="over"]{background:linear-gradient(180deg,#ffffff,#fff3cf)}
  .result-modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:8; background:rgba(0,0,0,.25)}
  .result-card{background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:0; width:min(92%,860px); max-height:82vh; display:flex; flex-direction:column}
  .result-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #eef2f7; position:sticky; top:0; background:#fff; border-radius:18px 18px 0 0}
  .result-body{padding:16px; overflow:auto}
  .nums{font-size:18px; font-weight:800; text-align:center; margin-bottom:10px}
  .btns{display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap}
  .wronglist{margin-top:12px} .wrongitem{background:#fff9fb; border:1px solid #ffd7e0; border-radius:12px; padding:10px; margin:6px 0}
  .wrongitem .why{font-size:13px; color:#374151; background:#f0fff7; border:1px dashed #bfe8d3; border-radius:10px; padding:8px; margin-top:6px}
  .footerbar{position:fixed; left:0; right:0; bottom:0; z-index:7; display:flex; justify-content:center; padding:10px}
  .footerbar .bar{background:rgba(255,255,255,.85); backdrop-filter: blur(6px); border:1px solid rgba(0,0,0,.06); border-radius:16px; padding:8px; display:flex; gap:8px; box-shadow:var(--shadow)}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.15); display:none; align-items:center; justify-content:center; z-index:9}
  .cardhelp{background:#fff; width:min(92%,900px); border-radius:18px; box-shadow:var(--shadow); padding:16px}
  .helpgrid{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
  .helpitem{background:#fff; border-radius:16px; padding:12px; box-shadow:var(--shadow)}
  .helpitem.teacher{background:linear-gradient(180deg,#fff,#ffe6eb)} .helpitem.learner{background:linear-gradient(180deg,#fff,#eafff2)} .helpitem.over{background:linear-gradient(180deg,#fff,#fff3cf)}
  .maptag{display:inline-flex; align-items:center; gap:6px; background:#fff; border-radius:12px; padding:8px 10px; border:1px solid #E0E7FF; box-shadow:var(--shadow);}
  .legend{display:flex; gap:8px; flex-wrap:wrap; font-size:13px; margin:8px 0}
  .tag{padding:2px 8px; border-radius:999px; border:1px solid rgba(0,0,0,.08)}
  .tag.t{background:#ffe6eb} .tag.l{background:#eafff2} .tag.o{background:#fff3cf}
  table{width:100%; border-collapse:collapse; font-size:14px} th,td{padding:8px 10px; border-bottom:1px solid #f1f5f9; vertical-align:top}
  th{text-align:left; color:#475569; font-weight:700}
  /* guide chip text */
  .play-hint{margin-left:10px; font-size:14px; color:#6b6f7b}
  /* mobile tuning */
  @media (max-width:700px){
    .frames{grid-template-columns:1fr}
    .pillbtn{font-size:15px; padding:10px 8px}
    .helpgrid{grid-template-columns:1fr}
    .result-card{width:min(96%, 900px)}
    .play-hint{display:block; margin:6px 0 0 0; font-size:13px}
  }
  /* Confetti does not occupy layout; hidden until play */
  #confetti{position:fixed; inset:0; width:100%; height:100%; pointer-events:none; display:none;}
  /* Who modal mobile */
  #whoModal .cardhelp{width:92vw; max-width:92vw}
  #whoModal input{font-size:16px; height:42px}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="wrap" id="topAnchor">
  <header>
    <div class="title">
      <span style="font-size:22px">📚</span>
      <h1>為什麼要有 EPA？｜快思慢想</h1>
    </div>
    <div class="toolbar">
      <!-- keep swapped order: tabs + map + music -->
      <button class="leveltab active" data-level="1">關卡1</button>
      <button class="leveltab" data-level="2">關卡2</button>
      <span class="maptag" id="btnMapTop">🗺️🐶 迷思地圖</span>
      <span class="play-hint">👇 小挑戰：看每段對話，直覺選—這段較像 <b>教師中心</b>、<b>學員中心</b>，還是 <b>過度包容</b>？</span>
      <div class="music" id="musicBox" style="display:flex;align-items:center;gap:6px;background:#fff;border-radius:999px;padding:8px 10px;box-shadow:var(--shadow)">
        🎵
        <button class="ghost" id="btnMusic">播放</button>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.2" title="音量" style="width:110px">
      </div>
    </div>
    <div class="toolbar">
      <button class="ghost" id="btnResetTop">重置本關</button>
      <button class="primary" id="btnSubmitTop">送出本關</button>
      <!-- swapped: callout here -->
      <button class="callout" id="btnReadFirst">👀 <span>開始遊戲前請看看我</span></button>
    </div>
  </header>

  <div id="quiz"></div>
</div>

<div class="footerbar"><div class="bar">
  <button class="ghost" id="btnResetBottom">重置本關</button>
  <button class="primary" id="btnSubmitBottom">送出本關</button>
  <span class="maptag" id="btnMapBottom">🗺️🐶 迷思地圖</span>
</div></div>

<div class="modal" id="helpModal">
  <div class="cardhelp">
    <h3 style="margin:0 0 8px">說明專區</h3>
    <div class="helpgrid">
      <div class="helpitem teacher"><h4 style="margin:0 0 6px">👩‍🏫 教師中心</h4>
        <div style="font-size:14px; color:#374151">由教師主導流程，學員參與低；為求效率而減少練習與回饋。</div>
      </div>
      <div class="helpitem learner"><h4 style="margin:0 0 6px">🌱 學員中心（責任分級）</h4>
        <div style="font-size:14px; color:#374151">依學員能力設定可委託任務、即時回饋與漸進放手，在安全情境中承擔責任。</div>
      </div>
      <div class="helpitem over"><h4 style="margin:0 0 6px">💗 過度包容（不健康）</h4>
        <div style="font-size:14px; color:#374151">模糊標準或回避回饋，短期看似保護，長期反而阻礙學習與安全。<br>👉 解套：給具體事實與下一步建議，以行為為焦點。</div>
      </div>
    </div>
    <div style="text-align:right; margin-top:10px"><button class="ghost" id="closeHelp">關閉</button></div>
  </div>
</div>

<div class="result-modal" id="resultModal">
  <div class="result-card">
    <div class="result-head">
      <h3 style="margin:0">結果</h3>
      <button class="ghost" id="closeResultTop">✕</button>
    </div>
    <div class="result-body">
      <div class="nums">本關答對 <b id="ok">0</b> 題、答錯 <b id="bad">0</b> 題。</div>
      <div class="wronglist" id="wronglist"></div>
      <div class="btns">
        <button class="ghost" id="closeResult">返回題目</button>
        <button class="primary" id="retry">再玩一次</button>
        <button class="primary" id="goL2">前往關卡2</button>
        <span class="maptag" id="btnMapFromModal">🗺️🐶 迷思地圖</span>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="mapModal">
  <div class="cardhelp">
    <h3 style="margin:0 0 8px">🗺️ 迷思地圖（做錯的題目與解釋）</h3>
    <div class="legend">
      <span class="tag t">教師中心</span>
      <span class="tag l">學員中心</span>
      <span class="tag o">過度包容</span>
    </div>
    <div id="mapContent" style="overflow:auto; max-height:60vh"></div>
    <div style="text-align:right; margin-top:10px"><button class="ghost" id="closeMap">關閉</button></div>
  </div>
</div>

<div class="modal" id="whoModal">
  <div class="cardhelp" style="max-width:520px">
    <h3 style="margin:0 0 8px">請先輸入識別資訊</h3>
    <div style="display:grid; gap:10px">
      <label>教師姓名（必填）
        <input id="inTid" class="ghost" style="width:100%; padding:10px; border-radius:10px; border:1px solid #e5e7eb" placeholder="例如：勇師" required>
      </label>
      <label>單位 / 部門（必填）
        <input id="inUnit" class="ghost" style="width:100%; padding:10px; border-radius:10px; border:1px solid #e5e7eb" placeholder="例如：11B" required>
      </label>
    </div>
    <div style="text-align:right; margin-top:10px"><button class="primary" id="saveWho">開始</button></div>
  </div>
</div>

<script>
// GAS endpoint
const GAS_URL = %(GAS_URL)r;

// labels & bank
const LABELS = { teacher:'教師中心', learner:'學員中心', over:'過度包容' };
const BANKS = {
  1: [
    { id:'L1-01', type:'teacher', scene:'交班前 5 分鐘，值班繁忙。', t:'這次交班時間很緊，我先說完重點，之後有機會再讓你嘗試。', s:'好的。', why:'以時間壓力為由收回練習，未設計低風險可委託片段（如精要版交班）。' },
    { id:'L1-02', type:'teacher', scene:'病房例行處置。', t:'這個護理很簡單，我做一次，就換你。', s:'了解。', why:'仍是示範為主，沒有設計觀察–回饋–再嘗試的循環。' },
    { id:'L1-03', type:'teacher', scene:'連續照顧同一段的病人，我主觀認為你很熟，不需要再確認。', t:'你已經卡這段第2次，都認識病人，應該可以自己去給藥吧。', s:'…', why:'以主觀感覺放手，未以分級標準與情境風險來判定。' },
    { id:'L1-04', type:'teacher', scene:'帶教一週後。', t:'我覺得一週也差不多了吧，可以放手讓他做。', s:'', why:'以時間為依據放手，未對應到可預期情境與表現證據。' },
    { id:'L1-05', type:'learner', scene:'抽血練習。', t:'剛剛看你抽血還不熟，等一下我再做一次邊說明，下一床換你抽血，我會在旁邊幫你。', s:'好，謝謝老師。', why:'先示範+立即練習+在旁監督，創造安全的責任分級。' },
    { id:'L1-06', type:'learner', scene:'交班訓練。', t:'你先用 ISBAR 交班一次，我們錄下來之後一起回顧。', s:'OK。', why:'使用結構化工具與自我回顧，形成回饋循環。' },
    { id:'L1-07', type:'learner', scene:'交班前。', t:'昨天討論過交班，今天交班前我們先練一次，放輕鬆。', s:'好。', why:'規律化的短練，降低實戰焦慮並提升表現穩定。' },
    { id:'L1-08', type:'learner', scene:'給藥與衛教。', t:'我看你給藥已經順了，但衛教有時不順，所以尚未判定獨立；我們先把衛教練好。', s:'明白。', why:'以證據判定獨立與否，針對弱項加強後再放手。' },
    { id:'L1-09', type:'over', scene:'帶教回饋。', t:'怕打擊他的信心，就說做得不錯吧。', s:'', why:'回避回饋會阻礙進步；應針對行為與結果給具體建議。' }
  ],
  2: [
    { id:'L2-01', type:'over', scene:'檢討學習狀態。', t:'他回去沒複習也沒關係，下次再說。', s:'', why:'模糊標準、放任延宕，無助於學習與病人安全。' },
    { id:'L2-02', type:'over', scene:'團隊關係。', t:'為了世界和平，錯誤就先不提了吧。', s:'', why:'避免衝突而不談錯誤，會讓風險持續。應用事實與影響來回饋。' },
    { id:'L2-03', type:'over', scene:'高壓情境。', t:'他好像很怕，我更怕，我自己做吧。', s:'', why:'剝奪學習機會。可切出安全片段在監督下嘗試。' },
    { id:'L2-04', type:'teacher', scene:'交班時間緊。', t:'今天交班很趕，就不要讓學員講了。', s:'', why:'時間壓力下仍可用「重點版交班」維持練習與把關。' },
    { id:'L2-05', type:'teacher', scene:'示範後。', t:'這次我先做示範，學員看就好。', s:'', why:'單向示範；應安排觀察重點與隨後的上手練習。' },
    { id:'L2-06', type:'teacher', scene:'規劃練習。', t:'等我有空再帶他練。', s:'', why:'以教師時間為中心；建議安排短時段固定微練。' },
    { id:'L2-07', type:'teacher', scene:'主觀放手。', t:'我覺得他差不多了，可以放手讓他做。', s:'', why:'缺乏等級與情境對照的客觀依據。' },
    { id:'L2-08', type:'learner', scene:'技能支持。', t:'抽血技巧不熟，我們今天觀察3次，每次給你2點建議，然後讓你自己做一次。', s:'了解。', why:'可觀察→回饋→實作，風險受控的漸進放手。' },
    { id:'L2-09', type:'learner', scene:'結構化交班。', t:'交班常遺漏重點，改用 ISBAR 並錄音回顧。', s:'好。', why:'用結構化工具提升品質並建立回顧例行。' },
    { id:'L2-10', type:'learner', scene:'風險調整。', t:'昨天兩次高風險錯誤，今天我會全程陪你做一次再放權。', s:'好。', why:'依風險動態調整監督強度，安全優先。' },
    { id:'L2-11', type:'learner', scene:'可預期情境。', t:'常規病人已能穩定處理，我在旁協助但不介入，等你順再獨立。', s:'OK。', why:'在可預期情境半監督放手，是分級委託的關鍵。' },
    { id:'L2-12', type:'learner', scene:'衛教加強。', t:'給藥OK，但衛教還需加強，先針對這部分練習。', s:'好。', why:'拆分弱項強化，待達標再授權獨立。' }
  ]
};

// state
let currentLevel = 1;
let answered = new Map();
let startTimes = new Map();
let cachedWrongs = [];
const quiz = document.getElementById('quiz');

// music (WebAudio, no external fetch)
(function(){
  let AC, master, isPlaying=false, loopTimer=null;
  function note(time, midi, dur=0.22, gain=0.12){
    const f = 440 * Math.pow(2,(midi-69)/12);
    const o = AC.createOscillator(); o.type = 'triangle';
    const g = AC.createGain(); g.gain.value = 0;
    o.frequency.value = f; o.connect(g).connect(master);
    g.gain.setValueAtTime(0, time);
    g.gain.linearRampToValueAtTime(gain, time+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, time+dur);
    o.start(time); o.stop(time+dur+0.05);
  }
  function startCuteLoop(){
    if(isPlaying) return;
    AC = AC || new (window.AudioContext||window.webkitAudioContext)();
    master = master || AC.createGain(); master.connect(AC.destination);
    const volEl = document.getElementById('vol'); master.gain.value = volEl ? Number(volEl.value||0.2) : 0.2;
    const seq = [
      [60,0],[64,0.25],[67,0.5],[72,0.75],
      [67,1.0],[64,1.25],[60,1.5],[64,1.75],
      [65,2.0],[69,2.25],[72,2.5],[76,2.75],
      [72,3.0],[69,3.25],[65,3.5],[69,3.75],
    ];
    const loopDur = 4.0; // seconds per loop (approx 120bpm, 2 bars)
    function schedule(){
      const t0 = AC.currentTime + 0.05;
      seq.forEach(([m, beat]) => note(t0 + beat*0.5, m));
    }
    schedule();
    loopTimer = setInterval(schedule, loopDur*1000);
    isPlaying = true;
  }
  function stopCuteLoop(){ if(loopTimer) clearInterval(loopTimer); loopTimer=null; isPlaying=false; }
  const btn = document.getElementById('btnMusic'); const vol = document.getElementById('vol');
  btn && btn.addEventListener('click', ()=>{ if(!isPlaying){ startCuteLoop(); btn.textContent='暫停'; } else { stopCuteLoop(); btn.textContent='播放'; }});
  vol && vol.addEventListener('input', e=>{ if(master) master.gain.value = Number(e.target.value)});
})();

// utils
function logAnswer(payload){ try{ fetch(GAS_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}); }catch(e){} }
function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

// render
function renderLevel(lv){ currentLevel = lv; answered.clear(); startTimes.clear(); cachedWrongs=[]; document.getElementById('resultModal').style.display='none'; quiz.innerHTML=''; const items = shuffle(BANKS[lv]); items.forEach(item=> quiz.appendChild(comicItem(item)) ); const first = quiz.firstElementChild; const top = document.getElementById('topAnchor'); if(top) top.scrollIntoView({behavior:'instant'}); if(first){ first.scrollIntoView({behavior:'smooth', block:'start'}); } }

function comicItem(item){ const el = document.createElement('div'); el.className='comic'; el.dataset.id=item.id; el.dataset.type=item.type;
  el.innerHTML = `
    <div class="scene">📍 ${item.scene}</div>
    <div class="frames">
      <div class="frame teacher"><div class="who">老師</div>${item.t}</div>
      <div class="frame learner"><div class="who">學員</div>${item.s || '（…）'}</div>
    </div>
    <div class="actions">
      <div class="pillbtn" data-ans="teacher">👩‍🏫 教師中心</div>
      <div class="pillbtn" data-ans="learner">🌱 學員中心</div>
      <div class="pillbtn" data-ans="over">💗 過度包容</div>
    </div>`;
  startTimes.set(item.id, performance.now());
  el.querySelectorAll('.pillbtn').forEach(btn=> btn.addEventListener('click',()=>choose(item, btn.dataset.ans, el)) );
  return el; }

function choose(item, ans, el){ answered.set(item.id, ans); el.querySelectorAll('.pillbtn').forEach(b=>b.style.outline=''); el.querySelector(`.pillbtn[data-ans="${ans}"]`).style.outline='3px solid var(--ring)'; const begin = startTimes.get(item.id) || performance.now(); const elapsed = Math.max(0, Math.round(performance.now() - begin)); logAnswer({ tid:window.__TID, unit:window.__UNIT, level:currentLevel, item_id:item.id, chosen:ans, truth:item.type, correct:(ans===item.type), used_hint:0, time_ms:elapsed, device_width:innerWidth, user_agent:navigator.userAgent }); }

function submitLevel(){ const items = BANKS[currentLevel]; let correct=0; const wrongs=[]; items.forEach(it=>{ const ans = answered.get(it.id); if(ans===it.type) correct++; else wrongs.push({ id:it.id, should:it.type, scene:it.scene, teacher:it.t, why:it.why, chosen: ans||'(未作答)' }); }); cachedWrongs = wrongs; document.getElementById('ok').textContent=correct; document.getElementById('bad').textContent=items.length - correct; const box = document.getElementById('wronglist'); box.innerHTML=''; if(wrongs.length){ wrongs.forEach(w=>{ const label = LABELS[w.should]; const div = document.createElement('div'); div.className='wrongitem'; div.innerHTML = `<div><b>應分類：</b>${label}　<span style="color:#6b7280">(${w.id})</span></div><div style="margin-top:6px"><b>情境：</b>${w.scene}</div><div style="margin-top:6px"><b>老師：</b>${w.teacher}</div><div class="why"><b>為什麼？</b> ${w.why}</div>`; box.appendChild(div); }); } else { box.innerHTML = `<div class="wrongitem" style="text-align:center">太強了！本關全對 🎉</div>`; } document.getElementById('resultModal').style.display='flex'; celebrate(); logAnswer({ tid:window.__TID, unit:window.__UNIT, level:currentLevel, item_id:'SUMMARY', chosen:correct + '/' + items.length, truth:'-', correct:true, used_hint:0, time_ms:0, device_width:innerWidth, user_agent:navigator.userAgent }); }

function renderMap(){ const host = document.getElementById('mapContent'); host.innerHTML=''; if(!cachedWrongs.length){ host.innerHTML = `<div class="wrongitem">目前尚無錯題。完成一關後再來看看地圖！</div>`; document.getElementById('mapModal').style.display='flex'; return; } const rows = cachedWrongs.map(w=>{ const correct = LABELS[w.should]; const mine = w.chosen==='(未作答)' ? '未作答' : LABELS[w.chosen]; const mineCls = w.chosen==='teacher'?'t': w.chosen==='learner'?'l': w.chosen==='over'?'o':''; return `<tr><td><code>${w.id}</code></td><td>${w.scene}</td><td><span class="tag ${w.should==='teacher'?'t': w.should==='learner'?'l':'o'}">${correct}</span></td><td><span class="tag ${mineCls}">${mine}</span></td><td>${w.why}</td></tr>`; }).join(''); host.innerHTML = `<table><thead><tr><th>題號</th><th>情境</th><th>正確</th><th>你的選擇</th><th>為什麼是正解？ / 解套秘笈</th></tr></thead><tbody>${rows}</tbody></table>`; document.getElementById('mapModal').style.display='flex'; }

// tabs & buttons
document.querySelectorAll('.leveltab').forEach(tab=> tab.addEventListener('click', ()=>{ document.querySelectorAll('.leveltab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); renderLevel(Number(tab.dataset.level)); }));
document.getElementById('btnReadFirst').addEventListener('click', ()=> document.getElementById('helpModal').style.display='flex');
document.getElementById('closeHelp').addEventListener('click', ()=>document.getElementById('helpModal').style.display='none');
document.getElementById('btnResetTop').addEventListener('click', ()=>renderLevel(currentLevel));
document.getElementById('btnResetBottom').addEventListener('click', ()=>renderLevel(currentLevel));
document.getElementById('btnSubmitTop').addEventListener('click', submitLevel);
document.getElementById('btnSubmitBottom').addEventListener('click', submitLevel);
document.getElementById('closeResult').addEventListener('click', ()=>document.getElementById('resultModal').style.display='none');
document.getElementById('closeResultTop').addEventListener('click', ()=>document.getElementById('resultModal').style.display='none');
document.getElementById('retry').addEventListener('click', ()=>{ document.getElementById('resultModal').style.display='none'; renderLevel(currentLevel); });
document.getElementById('goL2').addEventListener('click', ()=>{ document.getElementById('resultModal').style.display='none'; document.querySelectorAll('.leveltab').forEach(t=>t.classList.remove('active')); document.querySelector('.leveltab[data-level="2"]').classList.add('active'); renderLevel(2); });
['btnMapTop','btnMapBottom','btnMapFromModal'].forEach(id=> document.getElementById(id).addEventListener('click', renderMap));
document.getElementById('closeMap').addEventListener('click', ()=> document.getElementById('mapModal').style.display='none');

// confetti minimal
const canvas = document.getElementById('confetti'); const ctx = canvas.getContext('2d');
function size(){ canvas.width = innerWidth; canvas.height = innerHeight } window.addEventListener('resize', size); size();
function celebrate(){ canvas.style.display='block'; let pieces = Array.from({length:120}, ()=> ({ x: Math.random()*canvas.width, y: -20-Math.random()*40, r: 6+Math.random()*8, vy: 2+Math.random()*3, vx: (Math.random()-.5)*2.2, a: Math.random()*360, col: ['#FFB3C1','#BDE5D2','#FDE49C','#C9C8FF'][Math.floor(Math.random()*4)] })); let t=0; (function tick(){ ctx.clearRect(0,0,canvas.width,canvas.height); pieces.forEach(p=>{ p.y+=p.vy; p.x+=p.vx; p.a+=5; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a*Math.PI/180); ctx.fillStyle=p.col; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore(); }); if((t++)<180) requestAnimationFrame(tick); else { ctx.clearRect(0,0,canvas.width,canvas.height); canvas.style.display='none'; } })(); }

// who modal (required)
window.__TID = ''; window.__UNIT = '';
window.addEventListener('DOMContentLoaded', ()=>{
  const m = document.getElementById('whoModal');
  m.style.display='flex';
  document.getElementById('saveWho').onclick = ()=>{
    const tid = (document.getElementById('inTid').value || '').trim();
    const unit = (document.getElementById('inUnit').value || '').trim();
    if(!tid){ alert('請輸入教師姓名（例如：勇師）'); return; }
    if(!unit){ alert('請輸入單位或部門（例如：11B）'); return; }
    window.__TID = tid; window.__UNIT = unit;
    m.style.display='none';
    // scroll to top, then render L1
    window.scrollTo({ top: 0, behavior: 'instant' });
    renderLevel(1);
  };
});
</script>
</body>
</html>
