<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>為什麼要有 EPA？｜快思慢想</title>
<style>
:root{
  --bg:#FFF6F8; --card:#fff; --ink:#1f2937; --muted:#6b7280;
  --brand:#6C79FF; --ok:#21c08b; --warn:#ffb84d; --bad:#ff7a88;
  --pink:#FFE8ED; --green:#E8FFF1; --yellow:#FFF2C6;
  --shadow:0 8px 20px rgba(0,0,0,.06); --radius:18px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:
 radial-gradient(1000px 700px at 85% -10%, #ffe9f3 0, rgba(255,233,243,0) 70%), var(--bg);
 color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Inter","Noto Sans TC","Segoe UI",Roboto,Helvetica,Arial}
.wrap{max-width:900px;margin:0 auto;padding:12px 14px 120px}
.header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.8);backdrop-filter:blur(8px);border-bottom:1px solid rgba(0,0,0,.06)}
.bar{max-width:900px;margin:0 auto;padding:10px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.brand{display:flex;gap:10px;align-items:center;background:var(--card);padding:10px 12px;border-radius:14px;box-shadow:var(--shadow);font-weight:800}
h1{margin:0;font-size:18px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:0;border-radius:12px;padding:10px 14px;background:var(--card);box-shadow:var(--shadow);font-weight:800;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#7A86FF,#6C79FF);color:#fff}
.btn.ghost{background:#fff}
.notice{margin:10px 0 8px;background:#FFF6E6;border:1px dashed #F6C453;color:#7a5600;padding:10px 12px;border-radius:12px;font-weight:700}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06)}
.panel{padding:12px}
.scene{margin:10px 0}
.scene .head{font-weight:800;color:#ef476f;margin-bottom:6px}
.bubble{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:12px;padding:10px;margin:6px 0}
.choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
@media(min-width:640px){.choices{grid-template-columns:repeat(3,1fr)}}
.choice{display:block;text-align:center;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,.06);font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
.choice[data-k="teacher"]{background:linear-gradient(180deg,#fff,#ffe6ea)}
.choice[data-k="learner"]{background:linear-gradient(180deg,#fff,#eafff3)}
.choice[data-k="over"]{background:linear-gradient(180deg,#fff,#fff2da)}
.choice input{display:none}
.choice.active{outline:3px solid #6C79FF}
.footer{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;max-width:920px;width:calc(100% - 16px);z-index:30}
.dock{display:flex;gap:8px;justify-content:flex-end;align-items:center;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border:1px solid rgba(0,0,0,.06);border-radius:16px;box-shadow:var(--shadow);padding:8px}
.pill{padding:8px 12px;border-radius:999px;background:#fff;border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow);font-size:12px;color:#555}
.modal{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);z-index:40;padding:14px;
  overflow:auto; /* 遮罩可捲動 */
}
.sheet{
  background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:14px;max-width:560px;width:100%;
  max-height:calc(100vh - 48px); /* 限高 */
  overflow:auto; /* 內容可捲動 */
}
.sheet h3{margin:6px 0 10px}
.input{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.input input{padding:14px;border:1px solid #e5e7eb;border-radius:12px;font-size:18px} /* 放大字體 */
.small{font-size:12px;color:#6b7280}
.result{display:none;margin-top:10px}
.badlist{display:grid;grid-template-columns:1fr;gap:8px}
.baditem{background:linear-gradient(180deg,#fff,#FFF9FB);border:1px solid #FFE1E6;border-radius:12px;padding:10px}
.baditem .rw{background:#F0FFF7;border:1px dashed #BEE8D2;border-radius:10px;padding:8px;margin-top:6px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111;color:#fff;padding:8px 12px;border-radius:999px;display:none;z-index:60}
/* confetti canvas */
#confetti { position:fixed; inset:0; pointer-events:none; z-index:50; display:none; }
</style>
</head>
<body>
<header class="header">
  <div class="bar">
    <div class="brand">📚 <h1>為什麼要有 EPA？｜快思慢想</h1></div>
    <div class="actions">
      <button class="btn ghost" id="btnL1">關卡 1</button>
      <button class="btn ghost" id="btnL2">關卡 2</button>
      <button class="btn primary" id="btnHow">👀 開始遊戲前請看我</button>
      <button class="btn ghost" id="btnAll">🗺️ 兩關分析</button>
    </div>
  </div>
</header>

<canvas id="confetti"></canvas>

<div class="wrap">
  <div class="notice">以下對話情境，你覺得是以誰為中心呢？（👩‍🏫 教師中心 / 🌱 學員中心 / 💗 過度包容）</div>
  <section id="board" class="card panel"></section>

  <section id="resultPanel" class="card panel result">
    <h3>結果</h3>
    <p>本關答對 <b id="okn">0</b> 題、答錯 <b id="wn">0</b> 題。</p>
    <div id="badlist" class="badlist"></div>
    <div id="afterBtns" style="display:none; margin-top:8px; display:flex; gap:8px;">
      <button class="btn" id="btnGoL2">前往關卡 2</button>
      <button class="btn" id="btnSeeAll">看兩關錯誤</button>
    </div>
  </section>
</div>

<footer class="footer">
  <div class="dock">
    <span class="pill" id="progress">0 / 0 已作答</span>
    <button class="btn ghost" id="btnReset">重置本關</button>
    <button class="btn primary" id="btnSubmit">送出本關</button>
  </div>
</footer>

<!-- 身份輸入 -->
<div id="dlgID" class="modal">
  <div class="sheet">
    <h3>請先輸入識別資訊</h3>
    <div class="input">
      <label>教師姓名（必填）</label>
      <input id="inpName" placeholder="例如：王小美"/>
    </div>
    <div class="input">
      <label>單位 / 部門（必填）</label>
      <input id="inpUnit" placeholder="例如：11B"/>
      <div class="small">僅用於學習統計，不會對外公開。</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn primary" id="btnStart">開始</button>
    </div>
  </div>
</div>

<!-- 說明 -->
<div id="dlgHow" class="modal">
  <div class="sheet">
    <h3>👀 開始前請看我</h3>
    <div class="baditem">
      <div><b>玩法</b></div>
      <div class="rw">讀情境 → 選三類之一：<b>教師中心</b> / <b>學員中心</b> / <b>過度包容</b>。送出後會看到「迷思點」解析。</div>
    </div>
    <div class="baditem">
      <div><b>精神喊話</b></div>
      <div class="rw">我相信我是<strong>神隊友</strong>老師，學妹一定能接住我傳的球！收好我的白眼、壓住我的深呼吸，讓他相信自己還有救！不要表露、不要放棄，我們需要新鮮的夥伴一起上班。想想我的排班、想想我的 OFF Day～ <b>我可以，他也一定可以！</b> 🫡</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="btnHowClose">關閉</button>
    </div>
  </div>
</div>

<!-- 兩關錯誤彙整 -->
<div id="dlgAll" class="modal">
  <div class="sheet">
    <h3>兩個關卡錯誤｜快速複習</h3>
    <div id="allList" class="badlist"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="btnAllClose">關閉</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">已儲存</div>

<script>
/* ---------- 設定：換成你最新的 Apps Script /exec ---------- */
const GAS_URL = "https://script.google.com/macros/s/AKfycby2IGF6h9U4cxsE6N22ggvOhhyytS5u6v1PX48nMx8zgxZlaZTzsJ_RBTp7Hets4VFbxg/exec";

/* ---------- 題庫 ---------- */
const BANK = {
  1: [
    {id:"L1-01", scene:"交班前。", t:"昨天討論過交班，今天交班前我們先練一次，放輕鬆。", s:"好。", truth:"learner", why:"以學員能力配適，創造可達成的伸展目標。"},
    {id:"L1-02", scene:"連續照顧。", t:"你已經卡這段第 2 次，都認識病人，應該可以自己去給藥吧。", s:"…", truth:"teacher", why:"以主觀感覺放手，未依等級與情境風險判斷。"},
    {id:"L1-03", scene:"示範與放手。", t:"這次我先做示範，你看就好。", s:"…", truth:"teacher", why:"單向示範；應安排隨後上手練習與回饋。"},
    {id:"L1-04", scene:"交班壓力。", t:"今天交班很趕，就不要讓學員講了。", s:"…", truth:"teacher", why:"時間壓力下仍可用精要版交班，保留練習與把關。"},
    {id:"L1-05", scene:"抽血練習。", t:"剛剛看你抽血還不熟，等一下我再做一次邊說明，下一床換你抽，我在旁幫你。", s:"好。", truth:"learner", why:"分段委託與即時回饋，屬責任分級。"},
    {id:"L1-06", scene:"交班訓練。", t:"你先用 ISBAR 交班一次，我們錄下來，之後一起回顧。", s:"好！", truth:"learner", why:"結構化工具＋自我回顧，提升品質。"},
    {id:"L1-07", scene:"交班前。", t:"你先講精要版，我補關鍵並控時間。", s:"OK！", truth:"learner", why:"教師把關風險與節奏，學員保有練習片段。"},
    {id:"L1-08", scene:"衛教品質。", t:"給藥 OK，但衛教需要加強；等一下我先做一次並說明，下一床換你。", s:"好。", truth:"learner", why:"針對弱項拆解練習，逐步提升自我效能。"},
    {id:"L1-09", scene:"帶教回饋。", t:"怕打擊他的信心，就說做得不錯吧。", s:"…", truth:"over", why:"以保護為名迴避回饋，應聚焦行為與下一步。"},
  ],
  2: [
    {id:"L2-01", scene:"學習狀態。", t:"昨天兩次高風險錯誤，今天改回全程監督。", s:"了解。", truth:"learner", why:"依風險動態調整監督強度，安全優先。"},
    {id:"L2-02", scene:"團隊關係。", t:"為了團隊和平，錯誤就先不提了。", s:"…", truth:"over", why:"需要以客觀事證與改善步驟溝通。"},
    {id:"L2-03", scene:"高壓情境。", t:"他好像很怕，我更怕…我自己做吧。", s:"…", truth:"over", why:"可切出最小安全任務，在監督下嘗試。"},
    {id:"L2-04", scene:"交班時間緊。", t:"今天交班很趕，就不要讓你講了。", s:"…", truth:"teacher", why:"可採精要版交班並補關鍵，維持練習與把關。"},
    {id:"L2-05", scene:"示範後。", t:"這次我先做示範，你看就好。", s:"好。", truth:"teacher", why:"示範不等於練習；應安排跟做片段與回饋。"},
    {id:"L2-06", scene:"DOPS。", t:"抽血技巧不熟，先用 DOPS 集中練三次。", s:"好。", truth:"learner", why:"用 DOPS 針對單一技能練，支撐 EPA 任務。"},
    {id:"L2-07", scene:"規劃練習。", t:"等我有空再帶你練。", s:"…", truth:"teacher", why:"以教師時間為中心；應安排短時段微演練建立回饋循環。"},
    {id:"L2-08", scene:"主觀放手。", t:"我覺得差不多了，可以放手讓他做。", s:"…", truth:"teacher", why:"應以等級與情境標準佐證，而非感覺。"},
    {id:"L2-09", scene:"結構化交班。", t:"交班常漏重點，用 ISBAR 練習並錄音回顧。", s:"收到！", truth:"learner", why:"結構＋自我回顧能提升品質。"},
    {id:"L2-10", scene:"可預期情境。", t:"此任務難度適中，正好挑戰你的下一階能力。", s:"想試試！", truth:"learner", why:"伸展目標、強化自我效能。"},
    {id:"L2-11", scene:"指導策略。", t:"你先做一次，我在旁即時回饋，遇到風險我接手。", s:"好！", truth:"learner", why:"監督強度可調，保安全也保練習。"},
    {id:"L2-12", scene:"保護心態。", t:"怕你受挫，就不說剛剛哪裡不好。", s:"…", truth:"over", why:"回避回饋會阻斷成長，應聚焦行為與可改進步驟。"},
  ]
};

/* ---------- 狀態 ---------- */
let LEVEL = 1;
let answers = {};         // id -> chosen
let doneLevel = {1:false, 2:false};
let user = {name:"", unit:"", session: "SID-"+Date.now().toString(36)+Math.random().toString(36).slice(2,8)};
let wrongAll = [];        // 兩關累積錯題

/* ---------- 工具 ---------- */
const $ = s=>document.querySelector(s);
const board = $('#board');
const resultPanel = $('#resultPanel');
const $ok = $('#okn'); const $wn = $('#wn'); const $bad = $('#badlist');
const $after = $('#afterBtns');
const toast = msg => { const t=$('.toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1000); };
const label = k => k==='teacher'?'教師中心':k==='learner'?'學員中心':'過度包容';
const shuffle = a => a.map(x=>[Math.random(),x]).sort((p,q)=>p[0]-q[0]).map(x=>x[1]);

/* ---------- UI ---------- */
function makeCard(q){
  const el=document.createElement('section');
  el.className='scene';
  el.innerHTML = `
    <div class="head">📍 ${q.scene} <span class="small" style="color:#6b7280">(${q.id})</span></div>
    <div class="bubble">👩‍🏫 老師：${q.t}</div>
    <div class="bubble">👤 學員：${q.s}</div>
    <div class="choices">
      ${['teacher','learner','over'].map(k=>`
        <label class="choice" data-k="${k}">
          <input type="radio" name="${q.id}" value="${k}"/>
          ${k==='teacher'?'👩‍🏫 教師中心':k==='learner'?'🌱 學員中心':'💗 過度包容'}
        </label>`).join('')}
    </div>`;
  const opts = el.querySelectorAll('.choice');
  opts.forEach(o=>o.addEventListener('click',()=>{
    opts.forEach(x=>x.classList.remove('active'));
    o.classList.add('active');
    const val = o.dataset.k;
    answers[q.id]=val;
    updateProgress();
    // 逐題回傳（失敗也不影響 UI）
    sendRow({
      timestamp: new Date().toISOString(),
      name:user.name, unit:user.unit, session_id:user.session,
      level: LEVEL, item_id:q.id, truth:q.truth, chosen:val,
      correct: (val===q.truth)?1:0, used_hint:0, time_ms:0,
      device_width: window.innerWidth, user_agent: navigator.userAgent
    });
  }));
  return el;
}

function render(){
  answers = {};
  resultPanel.style.display='none';
  $after.style.display='none';
  board.innerHTML='';
  const items = shuffle(BANK[LEVEL].slice());
  items.forEach(q=> board.appendChild(makeCard(q)));
  updateProgress();
  window.scrollTo({top: document.querySelector('.wrap').offsetTop+10, behavior:'smooth'});
}

function updateProgress(){
  const total = BANK[LEVEL].length;
  const done = Object.keys(answers).length;
  $('#progress').textContent = `${done} / ${total} 已作答`;
}

function submit(){
  const items = BANK[LEVEL];
  const total = items.length;
  if(Object.keys(answers).length<total){ toast('還有題目未作答喔'); return; }
  let ok=0; const wrong=[];
  items.forEach(q=>{
    const c = answers[q.id];
    const corr = (c===q.truth);
    if(corr) ok++; else wrong.push({q, chosen:c});
  });
  $ok.textContent = ok; $wn.textContent = total-ok;
  $bad.innerHTML='';
  if(wrong.length===0){
    const div=document.createElement('div'); div.className='bubble'; div.textContent='🎉 太強了！本關全對。';
    $bad.appendChild(div);
  }else{
    wrong.forEach(w=>{
      const div=document.createElement('div'); div.className='baditem';
      div.innerHTML=`
        <div><b>${w.q.scene}</b>　<span class="small" style="color:#6b7280">${w.q.id}</span></div>
        <div class="small">👩‍🏫 ${w.q.t}</div>
        <div class="small">👤 ${w.q.s}</div>
        <div style="margin-top:6px"><b>你的答案：</b>${label(w.chosen)}　｜　<b>正解：</b>${label(w.q.truth)}</div>
        <div class="rw"><b>為什麼？</b> ${w.q.why}</div>`;
      $bad.appendChild(div);
    });
  }
  resultPanel.style.display='block';
  // Summary（不阻塞 UI）
  sendRow({
    type:'summary',
    timestamp:new Date().toISOString(),
    name:user.name, unit:user.unit, session_id:user.session,
    level:LEVEL, total:total, correct:ok,
    device_width:window.innerWidth, user_agent:navigator.userAgent
  });

  // 記錄錯題到總表
  wrong.forEach(w=> wrongAll.push({level:LEVEL, ...w}));

  // 顯示導流按鈕
  $after.style.display='flex';
  $('#btnGoL2').style.display = (LEVEL===1 ? 'inline-block':'none');
  $('#btnSeeAll').style.display = (LEVEL===2 ? 'inline-block':'none');

  // 標記完成
  doneLevel[LEVEL] = true;

  // 若兩關都完成 → 灑花＋提示
  if(doneLevel[1] && doneLevel[2]){
    confettiBoom();
    setTimeout(()=>alert('恭喜老師，完成遊戲任務！'), 400);
  }

  window.scrollTo({top: resultPanel.offsetTop-60, behavior:'smooth'});
}

/* ---------- 兩關彙整 ---------- */
function openAll(){
  const box = $('#allList');
  if(wrongAll.length===0){
    box.innerHTML = `<div class="bubble">太棒啦！兩關沒有錯題可以檢討 🎉</div>`;
  }else{
    box.innerHTML = wrongAll.map(w=>{
      return `<div class="baditem">
        <div><b>Lv${w.level}</b>｜<b>${w.q.scene}</b>　<span class="small" style="color:#6b7280">${w.q.id}</span></div>
        <div class="small">👩‍🏫 ${w.q.t}</div>
        <div class="small">👤 ${w.q.s}</div>
        <div style="margin-top:6px"><b>你的答案：</b>${label(w.chosen)}　｜　<b>正解：</b>${label(w.q.truth)}</div>
        <div class="rw"><b>為什麼？</b> ${w.q.why}</div>
      </div>`;
    }).join('');
  }
  document.body.style.overflow = 'hidden';     // 鎖背景
  $('#dlgAll').style.display='flex';
}
function closeAll(){
  $('#dlgAll').style.display='none';
  document.body.style.overflow = '';            // 解鎖背景
}

/* ---------- 後台：送出（先 Beacon，備援 no-cors fetch） ---------- */
function sendRow(obj){
  try{
    const payload = JSON.stringify(obj);
    if (navigator.sendBeacon) {
      const blob = new Blob([payload], { type: 'text/plain;charset=UTF-8' });
      navigator.sendBeacon(GAS_URL, blob);
      return;
    }
    fetch(GAS_URL, { method:'POST', mode:'no-cors', body: payload });
  }catch(e){
    // 靜默忽略
  }
}

/* ---------- 灑花 ---------- */
function confettiBoom(){
  const cvs = $('#confetti');
  const ctx = cvs.getContext('2d');
  const W = cvs.width = innerWidth;
  const H = cvs.height = innerHeight;
  cvs.style.display='block';
  const N = 200;
  const P = Array.from({length:N},()=>({
    x:Math.random()*W, y: -20, r:2+Math.random()*4,
    vx:-2+Math.random()*4, vy:2+Math.random()*4,
    c:`hsl(${Math.random()*360},90%,60%)`
  }));
  let t=0;
  (function loop(){
    t++;
    ctx.clearRect(0,0,W,H);
    P.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy; p.vy+=0.06;
      ctx.fillStyle=p.c;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    });
    if(t<240) requestAnimationFrame(loop);
    else cvs.style.display='none';
  })();
}

/* ---------- 綁定 ---------- */
window.addEventListener('load', ()=>{
  // 身份
  const dlg = $('#dlgID'); dlg.style.display='flex'; document.body.style.overflow='hidden';
  $('#btnStart').onclick = ()=>{
    const name = $('#inpName').value.trim();
    const unit  = $('#inpUnit').value.trim();
    if(!name || !unit){ toast('請完整填寫姓名與單位'); return; }
    user.name=name; user.unit=unit;
    dlg.style.display='none'; document.body.style.overflow='';
    render();
    // 打開說明
    $('#dlgHow').style.display='flex';
    document.body.style.overflow='hidden';
  };

  // 說明
  $('#btnHow').onclick = ()=>{
    $('#dlgHow').style.display='flex';
    document.body.style.overflow='hidden';
  };
  $('#btnHowClose').onclick = ()=>{
    $('#dlgHow').style.display='none';
    document.body.style.overflow='';
  };

  // 兩關彙整
  $('#btnAll').onclick = openAll;
  $('#btnAllClose').onclick = closeAll;

  // 關卡
  $('#btnL1').onclick = ()=>{ LEVEL=1; render(); };
  $('#btnL2').onclick = ()=>{
    if(!doneLevel[1]) { alert('請先完成第一關暖暖身'); return; }
    LEVEL=2; render();
  };
  $('#btnReset').onclick = ()=> render();
  $('#btnSubmit').onclick = ()=> submit();

  // 結果區導流按鈕
  $('#btnGoL2').onclick = ()=>{ LEVEL=2; render(); };
  $('#btnSeeAll').onclick = openAll;

  // 點遮罩關閉（所有 modal）
  document.querySelectorAll('.modal').forEach(modal=>{
    modal.addEventListener('click', e=>{
      if(e.target===modal){
        modal.style.display='none';
        document.body.style.overflow='';
      }
    });
  });
});
</script>
</body>
</html>
