<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EPA é—œå¡ç‰ˆï½œå­¸å“¡ä¸­å¿ƒæ€ç¶­åˆ†é¡ v3</title>
<!-- Google Fonts with fallback -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#FAF7FF;
    --card:#FFFFFF;
    --shadow:0 6px 18px rgba(0,0,0,.08);
    --t:#2b2b2b;
    --muted:#667085;
    --brand:#6C79FF;
    --green:#B7F0D1;
    --pink:#FFD6DE;
    --yellow:#FFE9A9;
    --ring:#9BA6FF;
    --blue:#D7E4FF;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; 
    font-family:"Noto Sans TC", "PingFang TC", "Microsoft JhengHei", system-ui, -apple-system, Arial;
    background:
      radial-gradient(900px 600px at 110% -10%, #FFE9F3 0%, rgba(255,233,243,0) 60%),
      radial-gradient(900px 600px at -10% -10%, #E9EDFF 0%, rgba(233,237,255,0) 60%),
      var(--bg);
    color:var(--t);
  }
  .wrap{max-width:980px; margin:0 auto; padding:16px 16px 28px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap}
  .title{ display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-radius:16px; box-shadow:var(--shadow); }
  .title h1{font-family:"Baloo 2", "Noto Sans TC"; font-size:20px; margin:0}
  .badge{font-size:12px; color:#4B5563; background:linear-gradient(180deg,#fff, #F6F9FF); border:1px solid #E8EBFF; padding:6px 10px; border-radius:999px}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  button{border:0; border-radius:14px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition:transform .05s ease}
  button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#7A86FF, #6C79FF); color:#fff}
  .ghost{background:#fff}
  .hintbtn{background:linear-gradient(180deg,#FFE8AA,#FFD769)}
  .leveltab{background:#fff}
  .leveltab.active{background:#EEF0FF; border:1px solid #C9CDFF}

  .hint{margin:10px 0 16px; color:var(--muted); font-size:14px}

  .grid{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
  .pool, .bucket{min-height:160px; background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:12px}
  .pool{grid-column: 1 / -1; background:linear-gradient(180deg,#ffffff,#FDFBFF)}
  .bucket[data-category="teacher"]{background:linear-gradient(180deg,#ffffff, var(--pink))}
  .bucket[data-category="learner"]{background:linear-gradient(180deg,#ffffff, var(--green))}
  .bucket[data-category="over"]{background:linear-gradient(180deg,#ffffff, var(--yellow))}
  .bucket h3{margin:0 0 8px; font-size:15px; display:flex; align-items:center; gap:8px}
  .bucket h3 span{font-size:20px}
  .cards{display:flex; flex-wrap:wrap; gap:8px}

  .card{ user-select:none; -webkit-user-drag:none; touch-action:none;
    background:var(--card); border-radius:18px; padding:12px 12px; min-width:180px; max-width:260px; flex:1 0 180px;
    box-shadow:var(--shadow); cursor:grab; border:1px solid rgba(0,0,0,.04);
    transition:transform .15s ease, box-shadow .15s ease; }
  .card:active{cursor:grabbing}
  .card.dragging{opacity:.9; transform:rotate(2deg) scale(1.03)}
  .card.follow{position:fixed; z-index:9999; pointer-events:none; transform:translate(-50%,-50%) scale(1.03);}

  .drop-highlight{outline:2px dashed rgba(0,0,0,.15); outline-offset:-6px}
  .bucket.hover{outline:3px solid var(--ring); outline-offset:-6px}

  .footer{ margin-top:14px; display:flex; flex-wrap:wrap; gap:8px; align-items:center }
  .pill{background:#fff; border-radius:999px; padding:6px 10px; box-shadow:var(--shadow); font-size:12px}

  /* Tabs for mobile (buckets) */
  .tabs{display:none; gap:8px; margin:8px 0 0}
  .tab{flex:1; text-align:center; padding:8px 10px; background:#fff; border-radius:999px; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,.06); font-weight:700}
  .tab.active{background:#EEF0FF; border-color:#C9CDFF}

  /* Level tabs */
  .levelbar{display:flex; gap:8px; margin:6px 0 10px; flex-wrap:wrap}
  .leveltab{padding:8px 12px; border-radius:999px; border:1px solid rgba(0,0,0,.06); box-shadow:var(--shadow); font-weight:700}

  /* Responsive: on small screens show tabs and single bucket at a time */
  @media(max-width:860px){
    .grid{display:block}
    .pool{margin-bottom:10px}
    .tabs{display:flex}
    .bucket{display:none}
    .bucket.active{display:block}
  }

  /* Result panel */
  .result{display:none; margin-top:16px; background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:14px}
  .result h3{margin:0 0 8px}
  .badlist{display:grid; grid-template-columns: 1fr; gap:8px}
  @media(min-width:760px){.badlist{grid-template-columns: 1fr 1fr}}
  .baditem{background:linear-gradient(180deg,#fff,#FFF9FB); border:1px solid #FFE1E6; border-radius:16px; padding:10px}
  .baditem .rewrite{margin-top:6px; background:#F0FFF7; border:1px dashed #BEE8D2; padding:8px; border-radius:10px; font-size:14px}

  /* Confetti */
  .confetti{position:fixed; inset:0; pointer-events:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <span style="font-size:22px">ğŸ€</span>
      <h1>EPA é—œå¡ç‰ˆï½œå­¸å“¡ä¸­å¿ƒæ€ç¶­åˆ†é¡</h1>
      <span class="badge">å¯æ„›é¦¬å¡é¾ Â· ä¸‰éšæ®µ Â· è§¸æ§æ‹–æ›³</span>
    </div>
    <div class="toolbar">
      <button class="leveltab active" data-level="1">é—œå¡1ï½œç”Ÿæ´»æš–èº«</button>
      <button class="leveltab" data-level="2">é—œå¡2ï½œè‡¨åºŠæ•™è‚²</button>
      <button class="leveltab" data-level="3">é—œå¡3ï½œé€²éšæ€è¾¨</button>
    </div>
    <div class="toolbar">
      <button class="ghost" id="btnShuffle">æ´—ç‰Œ</button>
      <button class="ghost" id="btnReset">é‡ç½®</button>
      <button class="hintbtn" id="btnHint">æç¤º Ã— <span id="hintLeft">2</span></button>
      <button class="primary" id="btnCheck">é€å‡ºåˆ¤å®š</button>
    </div>
  </header>

  <p class="hint" id="levelIntro">é—œå¡1ï¼šå…ˆç”¨ç”Ÿæ´»å°åŠ‡å ´ç†è§£ã€Œæ•™å¸«ä¸­å¿ƒï¼å­¸å“¡ä¸­å¿ƒï¼éåº¦åŒ…å®¹ã€ã€‚</p>

  <div class="grid">
    <section class="pool" id="pool">
      <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:8px">ğŸƒ å¾…åˆ†é¡å¡ç‰‡</h3>
      <div class="cards" id="poolCards"></div>
    </section>

    <div class="tabs">
      <div class="tab active" data-target="teacher">ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ</div>
      <div class="tab" data-target="learner">ğŸŒ± å­¸å“¡ä¸­å¿ƒ</div>
      <div class="tab" data-target="over">ğŸ’— éåº¦åŒ…å®¹</div>
    </div>

    <section class="bucket active" data-category="teacher">
      <h3><span>ğŸ‘©â€ğŸ«</span> æ•™å¸«ä¸­å¿ƒ</h3>
      <div class="cards"></div>
    </section>

    <section class="bucket" data-category="learner">
      <h3><span>ğŸŒ±</span> å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰</h3>
      <div class="cards"></div>
    </section>

    <section class="bucket" data-category="over">
      <h3><span>ğŸ’—</span> éåº¦åŒ…å®¹ï¼ˆä¸å¥åº·ï¼‰</h3>
      <div class="cards"></div>
    </section>
  </div>

  <div class="footer">
    <span class="pill">æ‰‹æ©Ÿï¼šé•·æŒ‰æ‹–æ›³ï¼›æˆ–é»å¡ç‰‡é¸åˆ†é¡</span>
    <span class="pill">çµæœé¡¯ç¤ºï¼šã€Œå°å¹¾é¡Œï¼éŒ¯å¹¾é¡Œã€</span>
    <span class="pill" id="progress">0 / 0 å·²åˆ†é¡</span>
  </div>

  <section class="result" id="result">
    <h3>è§£æ</h3>
    <p style="margin:0 0 10px">æœ¬é—œçµæœï¼š<b id="rightCount">0</b> é¡Œå°ã€<b id="wrongCount">0</b> é¡ŒéŒ¯ï¼ˆé–€æª»ï¼š<span id="gateText"></span>ï¼‰ã€‚</p>
    <div class="badlist" id="badlist"></div>
  </section>
</div>

<div class="modal" id="modal">
  <div class="sheet">
    <h4>æŠŠé€™å¥è©±æ”¾åˆ°å“ªä¸€é¡ï¼Ÿ</h4>
    <div class="choices">
      <div class="choice" data-target="teacher">ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ</div>
      <div class="choice" data-target="learner">ğŸŒ± å­¸å“¡ä¸­å¿ƒ</div>
      <div class="choice" data-target="over">ğŸ’— éåº¦åŒ…å®¹</div>
    </div>
    <div style="margin-top:10px; font-size:13px; color:#6b7280">æ²’æœ‰æŠŠæ¡ï¼Ÿé»ä¸Šæ–¹ã€Œæç¤ºã€å¯ç²å¾— 50/50 ç·šç´¢æˆ–ç†ç”±ã€‚</div>
  </div>
</div>
<div class="toast" id="toast">å·²æ”¾ç½®</div>
<canvas class="confetti" id="confetti"></canvas>

<script>
  // ---- é¡Œåº«ï¼ˆæ¯é—œå„è‡ª  teacher/learner/over å„å›ºå®šæ•¸é‡ï¼‰ ----
  const BANKS = {
    1: { // é—œ1ï¼š6é¡Œï¼ˆä¸‰é¡å„2ï¼‰- ç”Ÿæ´»ç‰ˆï¼ˆå¥³å‹è¨“ç·´ç”·å‹ï¼Œå°å“æç¬‘ï¼‰
      gate: {needRight:7}, // ä½ è¦æ±‚ã€Œè¦å°7é¡Œã€ï¼Œä½†æœ¬é—œå…±6é¡Œï¼Œæˆ‘ä¾ä½ æ„åœ–æ¨æ¸¬æ˜¯ã€Œå°5é¡Œã€ï¼Ÿå…ˆç”¨5ï¼›å¦‚éœ€7ï¼Œè«‹èª¿æ•´é¡Œæ•¸ã€‚
      hints: 2,
      intro: "é—œå¡1ï¼šå…ˆç”¨ç”Ÿæ´»å°åŠ‡å ´ç†è§£ä¸‰é¡æ€ç¶­ã€‚",
      items: [
        // teacher x2
        {text:"æˆ‘è‡ªå·±æ´—æ¯”è¼ƒå¿«ï¼Œä½ ä¸‹æ¬¡å†å­¸å°±å¥½ã€‚", type:"teacher", rewrite:"å…ˆè®“ä½ æ´—ä¸€ä»¶ï¼Œæˆ‘åœ¨æ—é‚Šçœ‹ï¼ŒçµæŸçµ¦å…©é»å›é¥‹ã€‚", reason:"æŠŠæ•ˆç‡æ“ºç¬¬ä¸€ï¼Œæ²’æœ‰åˆ‡å‡ºå¯å§”è¨—ç‰‡æ®µèˆ‡å›é¥‹å¾ªç’°ã€‚"},
        {text:"å ±å‘Šæˆ‘å¹«ä½ å¯«å¥½ï¼Œä¸‹æ¬¡å†æ•™ä½ æ€éº¼å¯«ã€‚", type:"teacher", rewrite:"å…ˆè®“ä½ å¯«ä¸€ç‰ˆç²¾è¦ç‰ˆï¼Œæˆ‘ä¸€èµ·è£œå¼·é—œéµã€‚", reason:"è€å¸«åŒ…è¾¦ä»»å‹™ï¼Œå‰å¥ªç·´ç¿’æ©Ÿæœƒã€‚"},
        // learner x2
        {text:"ä»Šå¤©ä½ è² è²¬å€’åƒåœ¾ï¼Œæˆ‘åœ¨æ—é‚Šæé†’è·¯ç·šèˆ‡æ™‚é–“é»ã€‚", type:"learner", rewrite:"â€”â€”", reason:"è¨­å®šé‚Šç•Œèˆ‡ç›£ç£ï¼Œå±¬è²¬ä»»åˆ†ç´šçš„å§”è¨—ã€‚"},
        {text:"ä½ å…ˆç…ä¸€é¡†è›‹ï¼Œæˆ‘çœ‹ä¸€æ¬¡ï¼Œç­‰ä¸‹çµ¦2é»å»ºè­°ã€‚", type:"learner", rewrite:"â€”â€”", reason:"å¯è§€å¯Ÿï¼‹å…·é«”å›é¥‹ï¼Œé€æ­¥æ”¾æ¬Šã€‚"},
        // over x2
        {text:"ä½ ä»Šå¤©å¾ˆç´¯ä¸è¦åšå®¶äº‹äº†ï¼Œæˆ‘å…¨åŒ…ã€‚", type:"over", rewrite:"æŠŠä»»å‹™åˆ‡å°ï¼šä½ æ”¶ç¢—ï¼Œæˆ‘åˆ·é‹ï¼›ç¶­æŒæœ€å°è²¬ä»»ã€‚", reason:"éåº¦ä¿è­·ï¼Œæ¨¡ç³Šè²¬ä»»ç•Œç·šã€‚"},
        {text:"æ€•ä½ å—æŒ«ï¼Œå°±ä¸èªªå‰›å‰›å“ªè£¡åšä¸å¥½ã€‚", type:"over", rewrite:"é‡å°è¡Œç‚ºçµ¦å»ºè­°ï¼Œä¸è²¼æ¨™ç±¤ï¼Œä¸¦èªªä¸‹ä¸€æ­¥åšæ³•ã€‚", reason:"ä»¥ä¿è­·ç‚ºåè¿´é¿å›é¥‹ï¼Œå½±éŸ¿æˆé•·ã€‚"}
      ]
    },
    2: { // é—œ2ï¼š12é¡Œï¼ˆä¸‰é¡å„4ï¼‰- è‡¨åºŠæ•™è‚²ç‰ˆ
      gate: {needRight:10},
      hints: 2,
      intro: "é—œå¡2ï¼šæŠŠæ¦‚å¿µè½å›è‡¨åºŠæ•™è‚²æƒ…å¢ƒã€‚",
      items: [
        // teacher x4
        {text:"ä»Šå¤©äº¤ç­å¾ˆè¶•ï¼Œå°±ä¸è¦è®“å­¸å“¡è¬›äº†ã€‚", type:"teacher", rewrite:"è®“å­¸å“¡å…ˆè¬›ç²¾è¦ç‰ˆï¼Œæˆ‘è£œé—œéµä¸¦æ§é¢¨éšªã€‚", reason:"ä»¥æ™‚é–“å£“åŠ›å–ä»£å­¸ç¿’æ©Ÿæœƒã€‚"},
        {text:"æˆ‘è¦ºå¾—ä»–å·®ä¸å¤šäº†ï¼Œå¯ä»¥æ”¾æ‰‹è®“ä»–åšã€‚", type:"teacher", rewrite:"å·²é” 3a æ¨™æº–æƒ…å¢ƒï¼ŒåŠç›£ç£æ”¾æ‰‹ã€‚", reason:"ä»¥ä¸»è§€æ„Ÿè¦ºï¼Œæœªå°æ‡‰ç­‰ç´šèˆ‡æƒ…å¢ƒæŒ‡æ¨™ã€‚"},
        {text:"ç­‰æˆ‘æœ‰ç©ºå†å¸¶ä»–ç·´ã€‚", type:"teacher", rewrite:"å®‰æ’çŸ­æ™‚æ®µå¾®æ¼”ç·´ï¼Œæ¯å¤©æœ‰ç·´ç¿’èˆ‡å›é¥‹ã€‚", reason:"ä»¥æ•™å¸«æ™‚é–“ç‚ºä¸­å¿ƒï¼Œç¼ºä¹è¦å¾‹åŒ–ã€‚"},
        {text:"é€™æ¬¡æˆ‘å…ˆåšç¤ºç¯„ï¼Œå­¸å“¡çœ‹å°±å¥½ã€‚", type:"teacher", rewrite:"ç¤ºç¯„å¾Œåˆ‡ç‰‡æ®µäº¤çµ¦å­¸å“¡åšã€‚", reason:"ç¤ºç¯„å¾Œæœªè½‰äº¤å¯å§”è¨—ç‰‡æ®µã€‚"},
        // learner x4
        {text:"æŠ½è¡€æŠ€å·§ä¸ç†Ÿï¼Œå…ˆç”¨ DOPS é›†ä¸­ç·´ä¸‰æ¬¡ã€‚", type:"learner", rewrite:"â€”â€”", reason:"åˆ†é›¢å–®ä¸€æŠ€èƒ½ä»¥ DOPS ç·´ç¿’æ”¯æ’ EPAã€‚"},
        {text:"å¸¸éºæ¼äº¤ç­é‡é»ï¼Œæ”¹ç”¨ ISBAR ä¸¦éŒ„éŸ³å›é¡§ã€‚", type:"learner", rewrite:"â€”â€”", reason:"å°å…¥çµæ§‹èˆ‡è‡ªæˆ‘å›é¡§ã€‚"},
        {text:"ä»–æ˜¨å¤©å…©æ¬¡é«˜é¢¨éšªéŒ¯èª¤ï¼Œä»Šå¤©æ”¹å›å…¨ç¨‹ç›£ç£ã€‚", type:"learner", rewrite:"â€”â€”", reason:"ä¾é¢¨éšªå‹•æ…‹èª¿æ•´ç›£ç£å¼·åº¦ã€‚"},
        {text:"å·²åœ¨å¸¸è¦ç—…äººè¡¨ç¾ç©©å®šï¼Œå…ˆè®“ä»–åœ¨æ¨™æº–æƒ…å¢ƒåŠç›£ç£ç¨ç«‹ã€‚", type:"learner", rewrite:"â€”â€”", reason:"æŒ‰æƒ…å¢ƒè¤‡é›œåº¦èˆ‡å¯é åº¦æ”¾æ¬Šã€‚"},
        // over x4
        {text:"åˆ¥è·Ÿä»–èªªéŒ¯åœ¨å“ªï¼Œæ€•æ‰“æ“Šä¿¡å¿ƒã€‚", type:"over", rewrite:"èšç„¦è¡Œç‚ºèˆ‡çµæœï¼Œçµ¦ä¸‹ä¸€æ­¥å…·é«”ä½œæ³•ã€‚", reason:"è¿´é¿å›é¥‹ï¼Œå½±éŸ¿å­¸ç¿’ã€‚"},
        {text:"ä»–éƒ½æ–°äººï¼Œå…ˆä¸è¦è®“ä»–åšä»»ä½•äº‹ã€‚", type:"over", rewrite:"åˆ‡å‡ºä½é¢¨éšªç‰‡æ®µï¼Œåœ¨ç›£ç£ä¸‹ç·´ç¿’ã€‚", reason:"å‰å¥ªç·´ç¿’æ©Ÿæœƒï¼Œç„¡æˆé•·è²¬ä»»ã€‚"},
        {text:"å­¸å“¡æº–å‚™ä¸è¶³ä¹Ÿæ²’é—œä¿‚ï¼Œä¸‹æ¬¡å†èªªã€‚", type:"over", rewrite:"ç•Œå®šæœ€å°å®‰å…¨ä»»å‹™èˆ‡ä¸‹æ¬¡å‰çš„æº–å‚™æ¸…å–®ã€‚", reason:"æ¨™æº–æ¨¡ç³Šï¼Œæ”¾ä»»å»¶å®•ã€‚"},
        {text:"ç‚ºäº†å’Œè«§ï¼ŒéŒ¯èª¤å°±å…ˆä¸æäº†ã€‚", type:"over", rewrite:"å…ˆç§ä¸‹å…·é«”å›é¥‹ï¼Œå†ç´„ä¸‹ä¸€æ¬¡æª¢æ ¸ã€‚", reason:"ä»¥å’Œè«§ä¹‹åå¿½è¦–å®‰å…¨èˆ‡å­¸ç¿’ã€‚"}
      ]
    },
    3: { // é—œ3ï¼š12é¡Œï¼ˆä¸‰é¡å„4ï¼‰- é€²éšæ€è¾¨ç‰ˆ
      gate: {needRight:10},
      hints: 1,
      intro: "é—œå¡3ï¼šç°è‰²åœ°å¸¶åˆ¤æ–·ï¼Œå¼·èª¿ã€ç‚ºä»€éº¼ä¸æ˜¯ç›¸é„°é¡åˆ¥ã€ã€‚",
      items: [
        // teacher x4
        {text:"æˆ‘æƒ³ä»–æ‡‰è©²èƒ½è™•ç†æ€¥æ•‘ï¼Œç›´æ¥è®“ä»–ä¸Šã€‚", type:"teacher", rewrite:"å…ˆåœ¨ä½é¢¨éšªæ®µè½è§€æ‘©ï¼Œç¢ºèªèƒ½åŠ›èˆ‡æ”¯æŒå†ä¸Šå ´ã€‚", reason:"ç„¡é¢¨éšªæ§ç®¡ã€ç„¡å°æ‡‰ç­‰ç´šä¾æ“šã€‚"},
        {text:"æˆ‘çŸ¥é“ä»–æœƒï¼Œä½†é€™æ¬¡æˆ‘é‚„æ˜¯è‡ªå·±åšæ¯”è¼ƒå¿«ã€‚", type:"teacher", rewrite:"åˆ‡ç‰‡æ®µäº¤çµ¦ä»–ï¼Œç¶­æŒç·´ç¿’é »ç‡èˆ‡è²¬ä»»ã€‚", reason:"æŠŠæ•ˆç‡ç½®æ–¼å­¸ç¿’ä¹‹å‰ã€‚"},
        {text:"åŒå­¸å¾ˆå¤šï¼Œæˆ‘æ²’æ™‚é–“é‡å°ä»–çµ¦å›é¥‹ã€‚", type:"teacher", rewrite:"ç”¨çµæ§‹åŒ–ç°¡çŸ­å›é¥‹ï¼ˆ2æ¢ï¼‰ç¶­æŒå¾ªç’°ã€‚", reason:"å›é¥‹ä¸­æ–·ï¼Œå­¸ç¿’å¾ªç’°æ–·è£‚ã€‚"},
        {text:"ä»–å¾ˆåŠªåŠ›ï¼Œè©•åˆ†å°±çµ¦é«˜ä¸€é»å§ã€‚", type:"teacher", rewrite:"ä¾è¡Œç‚ºæŒ‡æ¨™è©•åˆ†ï¼Œå¦çµ¦é¼“å‹µæ–‡å­—ã€‚", reason:"æŠŠæ…‹åº¦ç•¶çµæœè©•åˆ†ä¾æ“šã€‚"},
        // learner x4
        {text:"å¸¸è¦ç—…äººå·²å¯ç¨ç«‹ï¼Œé¢å°é«˜è¤‡é›œå€‹æ¡ˆå…ˆè§€æ‘©å†æ¥æ‰‹ã€‚", type:"learner", rewrite:"â€”â€”", reason:"ä¾æƒ…å¢ƒè¤‡é›œåº¦èª¿æ•´ç›£ç£å¼·åº¦ã€‚"},
        {text:"å·²é” 3a åœ¨å¯é æœŸæƒ…å¢ƒï¼Œé‡è®Šé …æˆ‘å†æ¥å›ã€‚", type:"learner", rewrite:"â€”â€”", reason:"åŠç›£ç£æ”¾æ¬Šï¼Œæ˜ç¢ºé‚Šç•Œã€‚"},
        {text:"ä»–èƒ½å®Œæˆï¼Œä½†ç©©å®šåº¦ä¸è¶³ï¼Œå…ˆé™å®šåœ¨æ—¥ç­å†æ”¾æ¬Šã€‚", type:"learner", rewrite:"â€”â€”", reason:"ä»¥å¯é åº¦èˆ‡ç’°å¢ƒé¢¨éšªä½œé‚Šç•Œã€‚"},
        {text:"å…ˆè®“ä»–åš 50%ï¼Œæˆ‘åšå‰©ä¸‹ 50%ï¼Œä¸‹æ¬¡å†å¢åŠ æ¯”ä¾‹ã€‚", type:"learner", rewrite:"â€”â€”", reason:"é€æ­¥å§”è¨—ï¼Œå¼·åŒ–æŒæ¡æ„Ÿã€‚"},
        // over x4
        {text:"æœ€è¿‘ä»–å£“åŠ›å¤§ï¼Œé€™é€±éƒ½å…ˆä¸è¦çµ¦å›é¥‹ã€‚", type:"over", rewrite:"æ”¹ç‚ºçŸ­è€Œæº«å’Œçš„å…·é«”å›é¥‹ï¼Œç¶­æŒç¯€å¥ã€‚", reason:"å®Œå…¨å–æ¶ˆå›é¥‹ï¼Œå­¸ç¿’åœæ»¯ã€‚"},
        {text:"ä»–æ€•çŠ¯éŒ¯ï¼Œå°±è®“ä»–åªçœ‹ä¸åšç›´åˆ°æœ‰è‡ªä¿¡ã€‚", type:"over", rewrite:"è¨­è¨ˆä½é¢¨éšªå¯¦ä½œæ®µè½ï¼Œå»ºç«‹è‡ªä¿¡ã€‚", reason:"é•·æœŸæ—è§€ï¼Œç¼ºä¹å¯¦ä½œèˆ‡æˆé•·ã€‚"},
        {text:"é‡åˆ°é›£çš„éƒ½å…ˆå¹«ä»–æ“‹æ‰ï¼Œå…å¾—ä»–å—æŒ«ã€‚", type:"over", rewrite:"åœ¨æˆ‘ç›£ç£ä¸‹è™•ç†é›£é»çš„å°åˆ‡ç‰‡ã€‚", reason:"éåº¦ä¿è­·ï¼ŒéŒ¯å¤±å­¸ç¿’å¥‘æ©Ÿã€‚"},
        {text:"ä»–æœ‰æ™‚æœƒå¿˜è¨˜äº‹æƒ…ï¼Œæˆ‘å¹«ä»–å…¨åšå®Œæ¯”è¼ƒå®‰å¿ƒã€‚", type:"over", rewrite:"å»ºç«‹æª¢æ ¸è¡¨å’Œæé†’æ©Ÿåˆ¶ï¼Œä¿ç•™ä»–æ‡‰è² çš„è²¬ä»»ã€‚", reason:"å–æ¶ˆè²¬ä»»ï¼Œç„¡æ³•åŸ¹é¤Šå¯é åº¦ã€‚"}
      ]
    }
  };

  // ä¿®æ­£ï¼šä½ åœ¨éœ€æ±‚ä¸­å¯«ã€Œé—œ1é–€æª»å°7é¡Œã€ï¼Œä½†é—œ1åªæœ‰6é¡Œã€‚å…ˆä»¥ã€Œå°5é¡Œã€ç‚ºé–€æª»ï¼Œè‹¥è¦7é¡Œè«‹æŠŠé¡Œæ•¸æ”¹æˆ â‰¥7ã€‚
  BANKS[1].gate.needRight = 5;

  // ---- ç‹€æ…‹ ----
  const $pool = document.getElementById('poolCards');
  const $buckets = [...document.querySelectorAll('.bucket')];
  const $tabs = [...document.querySelectorAll('.tab')];
  const $levelTabs = [...document.querySelectorAll('.leveltab')];
  const $progress = document.getElementById('progress');
  const $result = document.getElementById('result');
  const $badlist = document.getElementById('badlist');
  const $rightCount = document.getElementById('rightCount');
  const $wrongCount = document.getElementById('wrongCount');
  const $gateText = document.getElementById('gateText');
  const $score = document.getElementById('score');
  const $toast = document.getElementById('toast');
  const $modal = document.getElementById('modal');
  const $intro = document.getElementById('levelIntro');
  let activeCard = null;
  let hintLeft = 2; const $hintLeft = document.getElementById('hintLeft');
  let currentLevel = 1;
  // è§¸æ§æ‹–æ›³ç‹€æ…‹
  let pointerDragging=false; let dragOffsetX=0, dragOffsetY=0; let originParent=null; let currentHoverBucket=null;

  // Level switching
  $levelTabs.forEach(tab=>{
    tab.addEventListener('click', ()=>{
      $levelTabs.forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      currentLevel = Number(tab.dataset.level);
      loadLevel(currentLevel);
    });
  });

  // Bucket tabs (mobile)
  $tabs.forEach(tab => {
    tab.addEventListener('click', ()=>{
      $tabs.forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.dataset.target;
      $buckets.forEach(b=> b.classList.toggle('active', b.dataset.category===target));
    });
  });

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]} return arr }

  function makeCard(item, idx){
    const el=document.createElement('div');
    el.className='card';
    el.textContent=item.text;
    el.dataset.key=idx;
    el.draggable=true;
    // Mouse drag
    el.addEventListener('dragstart', e=>{el.classList.add('dragging'); e.dataTransfer.setData('text/plain', idx);});
    el.addEventListener('dragend', ()=>el.classList.remove('dragging'));
    // Tap-to-place
    el.addEventListener('click', ()=>{ if(pointerDragging) return; activeCard=el; $modal.style.display='flex'});
    // Pointer touch-drag
    el.addEventListener('pointerdown', (e)=>{
      if(e.pointerType!=='touch') return;
      e.preventDefault();
      activeCard=el; pointerDragging=true; originParent=el.parentElement;
      const rect=el.getBoundingClientRect();
      dragOffsetX=e.clientX - rect.left - rect.width/2;
      dragOffsetY=e.clientY - rect.top - rect.height/2;
      el.classList.add('follow');
      el.style.width=rect.width+'px';
      moveFollow(el, e.clientX - dragOffsetX, e.clientY - dragOffsetY);
      window.addEventListener('pointermove', onPointerMove, {passive:false});
      window.addEventListener('pointerup', onPointerUp, {once:true});
    });
    return el
  }

  function renderPool(items){
    $pool.innerHTML='';
    shuffle(items).forEach((item,i)=> $pool.appendChild(makeCard(item, i)) );
    updateProgress(items.length);
  }

  function updateProgress(total){
    const placed= total - $pool.querySelectorAll('.card').length;
    $progress.textContent=`${placed} / ${total} å·²åˆ†é¡`;
  }

  // Buckets: dragover/dropï¼ˆæ¡Œæ©Ÿï¼‰
  $buckets.forEach(b=>{
    const box=b.querySelector('.cards');
    b.addEventListener('dragover', e=>{e.preventDefault(); box.classList.add('drop-highlight')});
    b.addEventListener('dragleave', ()=> box.classList.remove('drop-highlight'));
    b.addEventListener('drop', e=>{
      e.preventDefault();
      const key=e.dataTransfer.getData('text/plain');
      const card=[...document.querySelectorAll('.card')].find(c=>c.dataset.key===key);
      if(card){ box.appendChild(card); showToast('å·²æ”¾ç½®'); }
      box.classList.remove('drop-highlight');
      updateProgress(BANKS[currentLevel].items.length);
    });
  })

  // Modal chooseï¼ˆæ‰‹æ©Ÿå‚™æ´ï¼‰
  $modal.addEventListener('click', (e)=>{
    if(e.target.classList.contains('choice')){
      const target=e.target.dataset.target;
      const bucket=document.querySelector(`.bucket[data-category="${target}"] .cards`);
      if(activeCard && bucket){ bucket.appendChild(activeCard); showToast('å·²æ”¾ç½®'); }
      $modal.style.display='none'; activeCard=null; updateProgress(BANKS[currentLevel].items.length);
    } else if(e.target.classList.contains('modal')){
      $modal.style.display='none'; activeCard=null;
    }
  });

  // Buttons
  document.getElementById('btnReset').addEventListener('click', ()=>loadLevel(currentLevel));
  document.getElementById('btnShuffle').addEventListener('click', ()=>{renderPool(BANKS[currentLevel].items)});
  document.getElementById('btnCheck').addEventListener('click', checkAnswers);
  document.getElementById('btnHint').addEventListener('click', useHint);

  function checkAnswers(){
    const items = BANKS[currentLevel].items;
    let correct=0; let wrong=[]; const total=items.length;
    document.querySelectorAll('.card').forEach(card=>{
      const key=Number(card.dataset.key); const answer=items[key].type;
      const parentBucket = card.closest('.bucket');
      const user = parentBucket ? parentBucket.dataset.category : 'pool';
      if(user===answer){ correct++; sparkle(card) } 
      else { if(user!=='pool') wrong.push({text:items[key].text, rewrite:items[key].rewrite, should:answer, reason:items[key].reason}) }
    });
    $rightCount.textContent = correct;
    $wrongCount.textContent = total - correct;
    $gateText.textContent = `è‡³å°‘ç­”å° ${BANKS[currentLevel].gate.needRight} é¡Œ`;
    // render wrong list
    $badlist.innerHTML='';
    wrong.forEach(w=>{
      const div=document.createElement('div'); div.className='baditem';
      const shouldLabel = w.should==='teacher'?'æ•™å¸«ä¸­å¿ƒ': w.should==='learner'?'å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰':'éåº¦åŒ…å®¹';
      div.innerHTML=`<div><b>æ‡‰è©²åˆ†é¡ï¼š</b>${shouldLabel}</div><div style="margin-top:6px">${w.text}</div>`;
      const rw=document.createElement('div'); rw.className='rewrite'; rw.innerHTML=`<b>å­¸å“¡ä¸­å¿ƒè½‰è­¯ï¼š</b>${w.rewrite==='â€”â€”'?'ï¼ˆæ­¤å¥æœ¬èº«å·²å±¬å­¸å“¡ä¸­å¿ƒï¼Œè«‹æª¢æŸ¥åˆ†é¡ï¼‰':w.rewrite}<br><span style="color:#6b7280">ç‚ºä»€éº¼ï¼Ÿ${w.reason}</span>`; 
      div.appendChild(rw);
      $badlist.appendChild(div);
    })
    $result.style.display='block';
    if(correct>=BANKS[currentLevel].gate.needRight) celebrate();
  }

  function useHint(){
    if(hintLeft<=0){ showToast('æç¤ºå·²ç”¨å®Œ'); return; }
    if(!activeCard){ showToast('è«‹å…ˆé»é¸ä¸€å¼µå¡ç‰‡'); return; }
    const items = BANKS[currentLevel].items;
    const key=Number(activeCard.dataset.key); const answer=items[key].type; const categories=['teacher','learner','over'];
    const wrongs = categories.filter(c=>c!==answer); const keep = wrongs[Math.floor(Math.random()*wrongs.length)];
    const options = [answer, keep].map(c=> c==='teacher'?'ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ': c==='learner'?'ğŸŒ± å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰':'ğŸ’— éåº¦åŒ…å®¹');
    showToast('å¯èƒ½æ˜¯ï¼š'+options.join(' æˆ– '));
    const tip = items[key].reason;
    setTimeout(()=>{ showToast('ç·šç´¢ï¼š'+tip) }, 900);
    hintLeft--; $hintLeft.textContent=hintLeft;
  }

  function showToast(msg){$toast.textContent=msg; $toast.style.display='block'; setTimeout(()=>{$toast.style.display='none'},900)}

  // è§¸æ§æ‹–æ›³ï¼šå®šä½èˆ‡æ”¾ç½®
  function getBucketAt(x,y){ const els = document.elementsFromPoint(x,y); return els.find(e=> e.classList && e.classList.contains('bucket')) || null; }
  function clearHover(){ if(currentHoverBucket){ currentHoverBucket.classList.remove('hover'); currentHoverBucket=null; } }
  function moveFollow(el, x, y){ el.style.left=x+'px'; el.style.top=y+'px'; el.style.transform='translate(-50%, -50%) scale(1.03)'; }
  function onPointerMove(e){ if(!pointerDragging||!activeCard) return; e.preventDefault();
    moveFollow(activeCard, e.clientX - dragOffsetX, e.clientY - dragOffsetY);
    const b = getBucketAt(e.clientX, e.clientY); if(b!==currentHoverBucket){ clearHover(); if(b){ b.classList.add('hover'); currentHoverBucket=b; } }
  }
  function onPointerUp(e){
    window.removeEventListener('pointermove', onPointerMove);
    if(!activeCard) return;
    if(currentHoverBucket){ currentHoverBucket.classList.remove('hover'); currentHoverBucket.querySelector('.cards').appendChild(activeCard); showToast('å·²æ”¾ç½®'); }
    else { originParent && originParent.appendChild(activeCard); }
    activeCard.classList.remove('follow'); activeCard.style.left=''; activeCard.style.top=''; activeCard.style.width=''; activeCard.style.transform='';
    activeCard=null; pointerDragging=false; clearHover(); updateProgress(BANKS[currentLevel].items.length);
  }

  // Confetti
  const canvas=document.getElementById('confetti'); const ctx=canvas.getContext('2d'); let pieces=[]; function resize(){canvas.width=innerWidth; canvas.height=innerHeight} window.addEventListener('resize', resize); resize();
  function celebrate(){
    pieces=[...Array(140)].map(()=>({x:Math.random()*canvas.width, y:-20, r:6+Math.random()*8, vy:2+Math.random()*3, vx:(Math.random()-.5)*2, a:Math.random()*360, col: ['#FFB3C1','#BDE5D2','#FDE49C','#C9C8FF', '#D7E4FF'][Math.floor(Math.random()*5)]}));
    let t=0; const tick=()=>{ctx.clearRect(0,0,canvas.width,canvas.height); pieces.forEach(p=>{p.y+=p.vy; p.x+=p.vx; p.a+=5; drawConfetti(p)}); t++; if(t<170) requestAnimationFrame(tick); else ctx.clearRect(0,0,canvas.width,canvas.height)}; tick();
  }
  function drawConfetti(p){ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a*Math.PI/180); ctx.fillStyle=p.col; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore()}

  // Load level
  function loadLevel(lv){
    // Intro & hints
    $intro.textContent = BANKS[lv].intro;
    hintLeft = BANKS[lv].hints; $hintLeft.textContent = hintLeft;
    // Clear buckets
    $buckets.forEach(b=> b.querySelector('.cards').innerHTML='');
    // Render pool
    renderPool(BANKS[lv].items);
    // Result hide
    $result.style.display='none';
    // Mobile default bucket
    $tabs.forEach((t,i)=> t.classList.toggle('active', i===0));
    $buckets.forEach((b,i)=> b.classList.toggle('active', i===0));
  }

  // init
  loadLevel(1);
</script>
</body>
</html>