<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³ âœ¦ï¼ˆè¶…ç›¸å®¹ç‰ˆï¼‰</title>
<style>
  :root{
    --bg:#FAF7FF;
    --card:#FFFFFF;
    --shadow:0 6px 18px rgba(0,0,0,.08);
    --t:#2b2b2b;
    --muted:#667085;
    --green:#B7F0D1;
    --pink:#FFD6DE;
    --yellow:#FFE9A9;
    --ring:#9BA6FF;
    --blue:#D7E4FF;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; 
    font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial;
    background:
      radial-gradient(900px 600px at 110% -10%, #FFE9F3 0%, rgba(255,233,243,0) 60%),
      radial-gradient(900px 600px at -10% -10%, #E9EDFF 0%, rgba(233,237,255,0) 60%),
      var(--bg);
    color:var(--t);
  }
  .wrap{max-width:980px; margin:0 auto; padding:16px 16px 28px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap}
  .title{ display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-radius:16px; box-shadow:var(--shadow); }
  .title h1{font-size:20px; margin:0; font-weight:700}
  .badge{font-size:12px; color:#4B5563; background:linear-gradient(180deg,#fff, #F6F9FF); border:1px solid #E8EBFF; padding:6px 10px; border-radius:999px}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; z-index:2; position:relative}
  button{border:0; border-radius:14px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition:transform .05s ease}
  button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#7A86FF, #6C79FF); color:#fff}
  .ghost{background:#fff}
  .hintbtn{background:linear-gradient(180deg,#FFE8AA,#FFD769)}
  .leveltab{background:#fff}
  .leveltab.active{background:#EEF0FF; border:1px solid #C9CDFF}

  .hint{margin:10px 0 16px; color:var(--muted); font-size:14px}

  .grid{display:grid; grid-template-columns:1fr; gap:12px}
  @media(min-width:860px){.grid{grid-template-columns:1fr 1fr 1fr}}
  .pool, .bucket{min-height:160px; background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:12px}
  .pool{grid-column: 1 / -1; background:linear-gradient(180deg,#ffffff,#FDFBFF)}
  .bucket[data-category="teacher"]{background:linear-gradient(180deg,#ffffff, var(--pink))}
  .bucket[data-category="learner"]{background:linear-gradient(180deg,#ffffff, var(--green))}
  .bucket[data-category="over"]{background:linear-gradient(180deg,#ffffff, var(--yellow))}
  .bucket h3{margin:0 0 8px; font-size:15px; display:flex; align-items:center; gap:8px}
  .bucket h3 span{font-size:20px}
  .cards{display:flex; flex-wrap:wrap; gap:8px}

  .card{
    user-select:none; 
    background:var(--card); border-radius:18px; padding:12px 12px; min-width:180px; max-width:260px; flex:1 0 180px;
    box-shadow:var(--shadow); cursor:pointer; border:1px solid rgba(0,0,0,.04);
    transition:transform .15s ease, box-shadow .15s ease; 
  }
  .card:active{transform:scale(0.98)}

  .footer{ margin-top:14px; display:flex; flex-wrap:wrap; gap:8px; align-items:center }
  .pill{background:#fff; border-radius:999px; padding:6px 10px; box-shadow:var(--shadow); font-size:12px}

  .result{display:none; margin-top:16px; background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:14px}
  .result h3{margin:0 0 8px}
  .badlist{display:grid; grid-template-columns: 1fr; gap:8px}
  @media(min-width:760px){.badlist{grid-template-columns: 1fr 1fr}}
  .baditem{background:linear-gradient(180deg,#fff,#FFF9FB); border:1px solid #FFE1E6; border-radius:16px; padding:10px}
  .baditem .rewrite{margin-top:6px; background:#F0FFF7; border:1px dashed #BEE8D2; padding:8px; border-radius:10px; font-size:14px}

  .summary{display:none; background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:14px}
  .summary h3{margin:0 0 8px}
  table{width:100%; border-collapse:separate; border-spacing:0 6px}
  th, td{padding:8px 10px; font-size:14px; vertical-align:top}
  th{color:#555; text-align:left}
  tr{background:#fff; box-shadow:var(--shadow)}
  tr td:first-child{border-radius:12px 0 0 12px}
  tr td:last-child{border-radius:0 12px 12px 0}
  .tag{font-size:12px; padding:2px 8px; border-radius:999px; display:inline-block}
  .t-teacher{background:var(--pink)}
  .t-learner{background:var(--green)}
  .t-over{background:var(--yellow)}

  /* Modal */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.15); display:none; align-items:flex-end; z-index:5}
  .sheet{background:#fff; border-radius:18px 18px 0 0; padding:12px; box-shadow:0 -10px 30px rgba(0,0,0,.15); width:100%}
  .sheet h4{margin:4px 6px 10px}
  .choices{display:flex; gap:10px}
  .choice{flex:1; padding:12px; border-radius:14px; border:1px solid rgba(0,0,0,.08); display:flex; gap:8px; align-items:center; justify-content:center; cursor:pointer}
  .choice[data-target="teacher"]{background:var(--pink)}
  .choice[data-target="learner"]{background:var(--green)}
  .choice[data-target="over"]{background:var(--yellow)}

  .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111; color:#fff; padding:10px 14px; border-radius:999px; font-size:14px; display:none; z-index:6}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <span style="font-size:22px">âœ¨</span>
      <h1>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³ âœ¦</h1>
      <span class="badge">è¶…ç›¸å®¹ï¼šé»å¡ç‰‡é¸åˆ†é¡ Â· å…©éšæ®µ + ç¸½è¡¨</span>
    </div>
    <div class="toolbar">
      <button class="leveltab active" data-level="1">é—œå¡1ï½œç”Ÿæ´»æš–èº«</button>
      <button class="leveltab" data-level="2">é—œå¡2ï½œè‡¨åºŠæ•™è‚²</button>
      <button class="leveltab" data-level="S">çœ‹çœ‹æ€éº¼å›äº‹</button>
    </div>
    <div class="toolbar">
      <button class="ghost" id="btnShuffle">æ´—ç‰Œ</button>
      <button class="ghost" id="btnReset">é‡ç½®</button>
      <button class="hintbtn" id="btnHint">æç¤º Ã— <span id="hintLeft">2</span></button>
      <button class="primary" id="btnCheck">é€å‡ºåˆ¤å®š</button>
    </div>
  </header>

  <p class="hint" id="levelIntro">é—œå¡1ï¼šç”¨ç”Ÿæ´»å°åŠ‡å ´ï¼ˆå¥³å‹è¨“ç·´ç”·å‹ğŸ˜†ï¼‰ç†è§£ã€Œæ•™å¸«ä¸­å¿ƒï¼å­¸å“¡ä¸­å¿ƒï¼éåº¦åŒ…å®¹ã€ã€‚</p>

  <div id="gameArea">
    <div class="grid">
      <section class="pool" id="pool">
        <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:8px">ğŸƒ å¾…åˆ†é¡å¡ç‰‡</h3>
        <div class="cards" id="poolCards"></div>
      </section>

      <section class="bucket" data-category="teacher">
        <h3><span>ğŸ‘©â€ğŸ«</span> æ•™å¸«ä¸­å¿ƒ</h3>
        <div class="cards"></div>
      </section>

      <section class="bucket" data-category="learner">
        <h3><span>ğŸŒ±</span> å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰</h3>
        <div class="cards"></div>
      </section>

      <section class="bucket" data-category="over">
        <h3><span>ğŸ’—</span> éåº¦åŒ…å®¹ï¼ˆä¸å¥åº·ï¼‰</h3>
        <div class="cards"></div>
      </section>
    </div>

    <div class="footer">
      <span class="pill">æ“ä½œï¼š<b>é»å¡ç‰‡</b> â†’ é¸åˆ†é¡</span>
      <span class="pill">çµæœé¡¯ç¤ºï¼šã€Œå°å¹¾é¡Œï¼éŒ¯å¹¾é¡Œã€</span>
      <span class="pill" id="progress">0 / 0 å·²åˆ†é¡</span>
    </div>

    <section class="result" id="result">
      <h3>è§£æ</h3>
      <p style="margin:0 0 10px">æœ¬é—œçµæœï¼š<b id="rightCount">0</b> é¡Œå°ã€<b id="wrongCount">0</b> é¡ŒéŒ¯ï¼ˆé–€æª»ï¼š<span id="gateText"></span>ï¼‰ã€‚</p>
      <div class="badlist" id="badlist"></div>
    </section>
  </div>

  <section class="summary" id="summaryArea">
    <h3>çœ‹çœ‹æ€éº¼å›äº‹ï½œé—œå¡ 1 + 2 ç¸½è¡¨</h3>
    <p class="hint">å½™æ•´æ‰€æœ‰é¡Œç›®ã€åˆ†é¡èˆ‡ã€Œå­¸å“¡ä¸­å¿ƒè½‰è­¯ï¼ç†ç”±ã€ï¼Œæ–¹ä¾¿å¿«é€Ÿå°ç…§èˆ‡è‡ªå­¸ã€‚</p>
    <div id="summaryTables"></div>
  </section>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="sheet">
    <h4>æŠŠé€™å¥è©±æ”¾åˆ°å“ªä¸€é¡ï¼Ÿ</h4>
    <div class="choices">
      <div class="choice" data-target="teacher">ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ</div>
      <div class="choice" data-target="learner">ğŸŒ± å­¸å“¡ä¸­å¿ƒ</div>
      <div class="choice" data-target="over">ğŸ’— éåº¦åŒ…å®¹</div>
    </div>
    <div style="margin-top:10px; font-size:13px; color:#6b7280">æ²’æœ‰æŠŠæ¡ï¼Ÿé»ä¸Šæ–¹ã€Œæç¤ºã€å¯ç²å¾— 50/50 ç·šç´¢æˆ–ç†ç”±ã€‚</div>
  </div>
</div>
<div class="toast" id="toast">å·²æ”¾ç½®</div>

<script>
(function(){
  // ---- é¡Œåº« ----
  const BANKS = {
    1: {gate:{needRight:7}, hints:2, intro:"é—œå¡1ï¼šç”Ÿæ´»å°åŠ‡å ´ï¼ˆå¥³å‹è¨“ç·´ç”·å‹ğŸ˜†ï¼‰ï¼Œå…ˆææ‡‚ä¸‰é¡æ€ç¶­ã€‚", items:[
      {text:"æˆ‘è‡ªå·±æ´—æ¯”è¼ƒå¿«ï¼Œä½ ä¸‹æ¬¡å†å­¸å°±å¥½ã€‚", type:"teacher", rewrite:"ä½ å…ˆæ´—ä¸€ä»¶ï¼Œæˆ‘åœ¨æ—é‚Šçœ‹ï¼ŒçµæŸçµ¦å…©é»å›é¥‹ã€‚", reason:"æŠŠæ•ˆç‡æ“ºç¬¬ä¸€ï¼Œæ²’æœ‰åˆ‡å‡ºå¯å§”è¨—ç‰‡æ®µèˆ‡å›é¥‹å¾ªç’°ã€‚"},
      {text:"å ±å‘Šæˆ‘å¹«ä½ å¯«å¥½ï¼Œä¸‹æ¬¡å†æ•™ä½ æ€éº¼å¯«ã€‚", type:"teacher", rewrite:"å…ˆè®“ä½ å¯«ä¸€ç‰ˆç²¾è¦ç‰ˆï¼Œæˆ‘ä¸€èµ·è£œå¼·é—œéµã€‚", reason:"åŒ…è¾¦ä»»å‹™ï¼Œå‰å¥ªç·´ç¿’æ©Ÿæœƒã€‚"},
      {text:"æˆ‘å·²ç¶“å¾ˆå¿™äº†ï¼Œç­‰æˆ‘æœ‰ç©ºå†æ•™ä½ åšé£¯ã€‚", type:"teacher", rewrite:"å®‰æ’10åˆ†é˜è¿·ä½ ç·´ç¿’ï¼Œä»Šå¤©å…ˆå­¸æ‰“è›‹èˆ‡é–‹ç«å®‰å…¨ã€‚", reason:"ä»¥æ•™å¸«æ™‚é–“ç‚ºä¸­å¿ƒï¼Œç¼ºä¹è¦å¾‹åŒ–ç·´ç¿’ã€‚"},
      {text:"ä»Šå¤©ä½ è² è²¬å€’åƒåœ¾ï¼Œæˆ‘æé†’è·¯ç·šèˆ‡æ™‚é–“é»ã€‚", type:"learner", rewrite:"â€”â€”", reason:"è¨­å®šé‚Šç•Œèˆ‡ç›£ç£ï¼Œå±¬è²¬ä»»åˆ†ç´šçš„å§”è¨—ã€‚"},
      {text:"ä½ å…ˆç…ä¸€é¡†è›‹ï¼Œæˆ‘çœ‹ä¸€æ¬¡ï¼Œç­‰ä¸‹çµ¦2é»å»ºè­°ã€‚", type:"learner", rewrite:"â€”â€”", reason:"å¯è§€å¯Ÿï¼‹å…·é«”å›é¥‹ï¼Œé€æ­¥æ”¾æ¬Šã€‚"},
      {text:"ä½ å…ˆè¬›ä»Šæ™šçš„ç´„æœƒæµç¨‹ï¼Œæˆ‘å†è£œå……é—œéµã€‚", type:"learner", rewrite:"â€”â€”", reason:"å…ˆè®“å­¸å“¡è¼¸å‡ºï¼Œæ•™å¸«æŠŠé—œç¼ºå£ã€‚"},
      {text:"ä½ ä»Šå¤©å¾ˆç´¯ä¸è¦åšå®¶äº‹äº†ï¼Œæˆ‘å…¨åŒ…ã€‚", type:"over", rewrite:"æŠŠä»»å‹™åˆ‡å°ï¼šä½ æ”¶ç¢—ï¼Œæˆ‘åˆ·é‹ï¼›ç¶­æŒæœ€å°è²¬ä»»ã€‚", reason:"éåº¦ä¿è­·ï¼Œæ¨¡ç³Šè²¬ä»»ç•Œç·šã€‚"},
      {text:"æ€•ä½ å—æŒ«ï¼Œå°±ä¸èªªå‰›å‰›å“ªè£¡åšä¸å¥½ã€‚", type:"over", rewrite:"é‡å°è¡Œç‚ºçµ¦å»ºè­°ï¼Œä¸è²¼æ¨™ç±¤ï¼Œä¸¦èªªä¸‹ä¸€æ­¥ä½œæ³•ã€‚", reason:"ä»¥ä¿è­·ç‚ºåè¿´é¿å›é¥‹ï¼Œå½±éŸ¿æˆé•·ã€‚"},
      {text:"ä½ åªè¦è² è²¬å¯æ„›å°±å¥½ï¼Œå…¶ä»–éƒ½æˆ‘ä¾†ã€‚", type:"over", rewrite:"åˆ‡å‡ºä½é¢¨éšªä»»å‹™è®“ä½ å®Œæˆï¼Œå»ºç«‹å¯é åº¦ã€‚", reason:"å–æ¶ˆè²¬ä»»ï¼Œç„¡æ³•é›éŠèƒ½åŠ›ã€‚"},
    ]},
    2: {gate:{needRight:10}, hints:2, intro:"é—œå¡2ï¼šæŠŠæ¦‚å¿µè½å›è‡¨åºŠæ•™è‚²æƒ…å¢ƒã€‚", items:[
      {text:"ä»Šå¤©äº¤ç­å¾ˆè¶•ï¼Œå°±ä¸è¦è®“å­¸å“¡è¬›äº†ã€‚", type:"teacher", rewrite:"è®“å­¸å“¡å…ˆè¬›ç²¾è¦ç‰ˆï¼Œæˆ‘è£œé—œéµä¸¦æ§é¢¨éšªã€‚", reason:"ä»¥æ™‚é–“å£“åŠ›å–ä»£å­¸ç¿’æ©Ÿæœƒã€‚"},
      {text:"æˆ‘è¦ºå¾—ä»–å·®ä¸å¤šäº†ï¼Œå¯ä»¥æ”¾æ‰‹è®“ä»–åšã€‚", type:"teacher", rewrite:"å·²é” 3a æ¨™æº–æƒ…å¢ƒï¼ŒåŠç›£ç£æ”¾æ‰‹ã€‚", reason:"ä»¥ä¸»è§€æ„Ÿè¦ºï¼Œæœªå°æ‡‰ç­‰ç´šèˆ‡æƒ…å¢ƒæŒ‡æ¨™ã€‚"},
      {text:"ç­‰æˆ‘æœ‰ç©ºå†å¸¶ä»–ç·´ã€‚", type:"teacher", rewrite:"å®‰æ’çŸ­æ™‚æ®µå¾®æ¼”ç·´ï¼Œæ¯å¤©æœ‰ç·´ç¿’èˆ‡å›é¥‹ã€‚", reason:"ä»¥æ•™å¸«æ™‚é–“ç‚ºä¸­å¿ƒï¼Œç¼ºä¹è¦å¾‹åŒ–ã€‚"},
      {text:"é€™æ¬¡æˆ‘å…ˆåšç¤ºç¯„ï¼Œå­¸å“¡çœ‹å°±å¥½ã€‚", type:"teacher", rewrite:"ç¤ºç¯„å¾Œåˆ‡ç‰‡æ®µäº¤çµ¦å­¸å“¡åšã€‚", reason:"ç¤ºç¯„å¾Œæœªè½‰äº¤å¯å§”è¨—ç‰‡æ®µã€‚"},
      {text:"æŠ½è¡€æŠ€å·§ä¸ç†Ÿï¼Œå…ˆç”¨ DOPS é›†ä¸­ç·´ä¸‰æ¬¡ã€‚", type:"learner", rewrite:"â€”â€”", reason:"åˆ†é›¢å–®ä¸€æŠ€èƒ½ä»¥ DOPS ç·´ç¿’æ”¯æ’ EPAã€‚"},
      {text:"å¸¸éºæ¼äº¤ç­é‡é»ï¼Œæ”¹ç”¨ ISBAR ä¸¦éŒ„éŸ³å›é¡§ã€‚", type:"learner", rewrite:"â€”â€”", reason:"å°å…¥çµæ§‹èˆ‡è‡ªæˆ‘å›é¡§ã€‚"},
      {text:"ä»–æ˜¨å¤©å…©æ¬¡é«˜é¢¨éšªéŒ¯èª¤ï¼Œä»Šå¤©æ”¹å›å…¨ç¨‹ç›£ç£ã€‚", type:"learner", rewrite:"â€”â€”", reason:"ä¾é¢¨éšªå‹•æ…‹èª¿æ•´ç›£ç£å¼·åº¦ã€‚"},
      {text:"å·²åœ¨å¸¸è¦ç—…äººè¡¨ç¾ç©©å®šï¼Œå…ˆè®“ä»–åœ¨æ¨™æº–æƒ…å¢ƒåŠç›£ç£ç¨ç«‹ã€‚", type:"learner", rewrite:"â€”â€”", reason:"æŒ‰æƒ…å¢ƒè¤‡é›œåº¦èˆ‡å¯é åº¦æ”¾æ¬Šã€‚"},
      {text:"åˆ¥è·Ÿä»–èªªéŒ¯åœ¨å“ªï¼Œæ€•æ‰“æ“Šä¿¡å¿ƒã€‚", type:"over", rewrite:"èšç„¦è¡Œç‚ºèˆ‡çµæœï¼Œçµ¦ä¸‹ä¸€æ­¥å…·é«”ä½œæ³•ã€‚", reason:"è¿´é¿å›é¥‹ï¼Œå½±éŸ¿å­¸ç¿’ã€‚"},
      {text:"ä»–éƒ½æ–°äººï¼Œå…ˆä¸è¦è®“ä»–åšä»»ä½•äº‹ã€‚", type:"over", rewrite:"åˆ‡å‡ºä½é¢¨éšªç‰‡æ®µï¼Œåœ¨ç›£ç£ä¸‹ç·´ç¿’ã€‚", reason:"å‰å¥ªç·´ç¿’æ©Ÿæœƒï¼Œç„¡æˆé•·è²¬ä»»ã€‚"},
      {text:"å­¸å“¡æº–å‚™ä¸è¶³ä¹Ÿæ²’é—œä¿‚ï¼Œä¸‹æ¬¡å†èªªã€‚", type:"over", rewrite:"ç•Œå®šæœ€å°å®‰å…¨ä»»å‹™èˆ‡ä¸‹æ¬¡å‰çš„æº–å‚™æ¸…å–®ã€‚", reason:"æ¨™æº–æ¨¡ç³Šï¼Œæ”¾ä»»å»¶å®•ã€‚"},
      {text:"ç‚ºäº†å’Œè«§ï¼ŒéŒ¯èª¤å°±å…ˆä¸æäº†ã€‚", type:"over", rewrite:"å…ˆç§ä¸‹å…·é«”å›é¥‹ï¼Œå†ç´„ä¸‹ä¸€æ¬¡æª¢æ ¸ã€‚", reason:"ä»¥å’Œè«§ä¹‹åå¿½è¦–å®‰å…¨èˆ‡å­¸ç¿’ã€‚"},
    ]}
  };

  // ---- DOM ----
  const $pool = document.getElementById('poolCards');
  const $buckets = [...document.querySelectorAll('.bucket')];
  const $progress = document.getElementById('progress');
  const $result = document.getElementById('result');
  const $badlist = document.getElementById('badlist');
  const $rightCount = document.getElementById('rightCount');
  const $wrongCount = document.getElementById('wrongCount');
  const $gateText = document.getElementById('gateText');
  const $intro = document.getElementById('levelIntro');
  const $summaryArea = document.getElementById('summaryArea');
  const $gameArea = document.getElementById('gameArea');
  const $hintLeft = document.getElementById('hintLeft');

  let activeCard = null;
  let currentLevel = 1;
  let hintLeft = 2;

  // ---- Helper ----
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]} return arr }
  function showToast(msg){const $t=document.getElementById('toast'); $t.textContent=msg; $t.style.display='block'; setTimeout(()=>{$t.style.display='none'},900)}

  function renderPool(items){
    $pool.innerHTML='';
    shuffle(items).forEach((item,i)=>{
      const el=document.createElement('div');
      el.className='card';
      el.textContent=item.text;
      el.dataset.key=i;
      $pool.appendChild(el);
    });
    updateProgress(items.length);
  }
  function updateProgress(total){
    const placed= total - $pool.querySelectorAll('.card').length;
    document.getElementById('progress').textContent = `${placed} / ${total} å·²åˆ†é¡`;
  }

  function loadLevel(lv){
    currentLevel = lv;
    const data = BANKS[lv];
    $intro.textContent = data.intro;
    hintLeft = data.hints;
    $hintLeft.textContent = hintLeft;
    $buckets.forEach(b=> b.querySelector('.cards').innerHTML='');
    renderPool(data.items);
    $result.style.display='none';
  }

  // ---- Global click delegation ----
  document.addEventListener('click', function(e){
    const t = e.target;
    // Level tabs
    if(t.classList.contains('leveltab')){
      document.querySelectorAll('.leveltab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const lv = t.dataset.level;
      if(lv==='S'){ $gameArea.style.display='none'; $summaryArea.style.display='block'; buildSummary(); }
      else { $summaryArea.style.display='none'; $gameArea.style.display='block'; loadLevel(Number(lv)); }
      return;
    }
    // Buttons
    if(t.id==='btnShuffle'){ renderPool(BANKS[currentLevel].items); return; }
    if(t.id==='btnReset'){ loadLevel(currentLevel); return; }
    if(t.id==='btnCheck'){ checkAnswers(); return; }
    if(t.id==='btnHint'){ useHint(); return; }

    // Cards -> open modal
    if(t.classList.contains('card')){
      activeCard = t;
      document.getElementById('modal').style.display='flex';
      return;
    }
    // Modal choices
    if(t.classList.contains('choice')){
      const target=t.dataset.target;
      const box = document.querySelector(`.bucket[data-category="${target}"] .cards`);
      if(activeCard && box){ box.appendChild(activeCard); showToast('å·²æ”¾ç½®'); updateProgress(BANKS[currentLevel].items.length); }
      document.getElementById('modal').style.display='none'; activeCard=null;
      return;
    }
    // Close modal when clicking shade
    if(t.id==='modal'){ t.style.display='none'; activeCard=null; return; }
  });

  function checkAnswers(){
    const items = BANKS[currentLevel].items;
    let correct=0; let wrong=[]; const total=items.length;
    document.querySelectorAll('.card').forEach(card=>{
      const key=Number(card.dataset.key); const answer=items[key].type;
      const parentBucket = card.closest('.bucket');
      const user = parentBucket ? parentBucket.dataset.category : 'pool';
      if(user===answer){ correct++; } else { if(user!=='pool') wrong.push({text:items[key].text, rewrite:items[key].rewrite, should:answer, reason:items[key].reason}) }
    });
    $rightCount.textContent = correct;
    $wrongCount.textContent = total - correct;
    $gateText.textContent = `è‡³å°‘ç­”å° ${BANKS[currentLevel].gate.needRight} é¡Œ`;
    $badlist.innerHTML='';
    wrong.forEach(w=>{
      const div=document.createElement('div'); div.className='baditem';
      const shouldLabel = w.should==='teacher'?'æ•™å¸«ä¸­å¿ƒ': w.should==='learner'?'å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰':'éåº¦åŒ…å®¹';
      div.innerHTML=`<div><b>æ‡‰è©²åˆ†é¡ï¼š</b>${shouldLabel}</div><div style="margin-top:6px">${w.text}</div>`;
      const rw=document.createElement('div'); rw.className='rewrite'; rw.innerHTML=`<b>å­¸å“¡ä¸­å¿ƒè½‰è­¯ï¼š</b>${w.rewrite==='â€”â€”'?'ï¼ˆæ­¤å¥æœ¬èº«å·²å±¬å­¸å“¡ä¸­å¿ƒï¼Œè«‹æª¢æŸ¥åˆ†é¡ï¼‰':w.rewrite}<br><span style="color:#6b7280">ç‚ºä»€éº¼ï¼Ÿ${w.reason}</span>`; 
      div.appendChild(rw);
      $badlist.appendChild(div);
    })
    $result.style.display='block';
  }

  function useHint(){
    if(hintLeft<=0){ showToast('æç¤ºå·²ç”¨å®Œ'); return; }
    if(!activeCard){ showToast('è«‹å…ˆé»é¸ä¸€å¼µå¡ç‰‡'); return; }
    const items = BANKS[currentLevel].items;
    const key=Number(activeCard.dataset.key); const answer=items[key].type; const categories=['teacher','learner','over'];
    const wrongs = categories.filter(c=>c!==answer); const keep = wrongs[Math.floor(Math.random()*wrongs.length)];
    const options = [answer, keep].map(c=> c==='teacher'?'ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ': c==='learner'?'ğŸŒ± å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰':'ğŸ’— éåº¦åŒ…å®¹');
    showToast('å¯èƒ½æ˜¯ï¼š'+options.join(' æˆ– '));
    setTimeout(()=>{ showToast('ç·šç´¢ï¼š'+items[key].reason) }, 900);
    hintLeft--; $hintLeft.textContent=hintLeft;
  }

  // Summary builder
  function buildSummary(){
    const box = document.getElementById('summaryTables');
    box.innerHTML='';
    Object.entries(BANKS).forEach(([lv, data])=>{
      const wrap=document.createElement('div'); wrap.style.margin='10px 0 20px';
      wrap.innerHTML=`<h4 style="margin:6px 0;">é—œå¡${lv} ç¸½è¡¨</h4>`;
      const table=document.createElement('table');
      table.innerHTML='<thead><tr><th style="width:26%">èªå¥</th><th style="width:10%">åˆ†é¡</th><th style="width:30%">å­¸å“¡ä¸­å¿ƒè½‰è­¯</th><th>ç†ç”±</th></tr></thead>';
      const tbody=document.createElement('tbody');
      data.items.forEach(it=>{
        const tr=document.createElement('tr');
        const tag = it.type==='teacher' ? '<span class="tag t-teacher">æ•™å¸«ä¸­å¿ƒ</span>' :
                    it.type==='learner' ? '<span class="tag t-learner">å­¸å“¡ä¸­å¿ƒ</span>' :
                    '<span class="tag t-over">éåº¦åŒ…å®¹</span>';
        tr.innerHTML=`<td>${it.text}</td><td>${tag}</td><td>${it.rewrite==='â€”â€”'?'â€”':it.rewrite}</td><td>${it.reason}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrap.appendChild(table);
      box.appendChild(wrap);
    });
  }

  // init
  loadLevel(1);
})();</script>
</body>
</html>