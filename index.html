<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EPA é—œå¡ 1ï½œå­¸å“¡ä¸­å¿ƒæ€ç¶­åˆ†é¡</title>
<style>
  :root{
    --bg:#FFF7F3; /* æŸ”å’Œç±³æ */
    --card:#FFFFFF;
    --shadow:0 6px 18px rgba(0,0,0,.08);
    --t:#222;
    --muted:#667085;
    --brand:#6C79FF; /* é¦¬å¡é¾è—ç´« */
    --good:#55C595; /* é¦¬å¡é¾ç¶  */
    --warn:#FFB84D; /* é¦¬å¡é¾æ©˜ */
    --bad:#FF7A88;  /* é¦¬å¡é¾ç²‰ç´… */
    --yellow:#FFF2C6;
    --green:#E8FFF1;
    --pink:#FFE8ED;
    --blue:#E9EDFF;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Inter Var", ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial;
    background: radial-gradient(1200px 800px at 80% -10%, #FFE9F3 0%, rgba(255,233,243,0) 60%), var(--bg);
    color:var(--t);
  }
  .wrap{max-width:1100px; margin:0 auto; padding:16px 16px 24px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px}
  .title{
    display:flex; align-items:center; gap:12px;
    padding:10px 14px; background:#fff; border-radius:16px; box-shadow:var(--shadow);
  }
  .title h1{font-size:18px; margin:0}
  .badge{font-size:12px; color:#4B5563; background:linear-gradient(180deg,#fff, #F6F9FF); border:1px solid #E8EBFF; padding:6px 10px; border-radius:999px}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  button{border:0; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; box-shadow:var(--shadow); transition:transform .05s ease}
  button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#7A86FF, #6C79FF); color:#fff}
  .ghost{background:#fff}
  .success{background:linear-gradient(180deg,#75D7A8,#55C595); color:#fff}
  .danger{background:linear-gradient(180deg,#FFA0AD,#FF7A88); color:#fff}

  .hint{margin:10px 0 16px; color:var(--muted); font-size:14px}

  .grid{display:grid; grid-template-columns:1fr; gap:12px}
  @media(min-width:860px){.grid{grid-template-columns: 1.1fr 1fr 1fr 1fr}}

  .pool, .bucket{min-height:160px; background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:12px}
  .pool{background:linear-gradient(180deg,#ffffff,#FDFBFF)}

  .bucket{position:relative}
  .bucket[data-category="teacher"]{background:linear-gradient(180deg,#ffffff, var(--pink))}
  .bucket[data-category="learner"]{background:linear-gradient(180deg,#ffffff, var(--green))}
  .bucket[data-category="over"]{background:linear-gradient(180deg,#ffffff, var(--yellow))}

  .bucket h3{margin:0 0 8px; font-size:15px; display:flex; align-items:center; gap:8px}
  .bucket h3 span{font-size:20px}

  .cards{display:flex; flex-wrap:wrap; gap:8px}
  .card{
    user-select:none; -webkit-user-drag:none; touch-action:none;
    background:var(--card); border-radius:14px; padding:12px 12px; min-width:180px; max-width:260px; flex:1 0 180px;
    box-shadow:var(--shadow); cursor:grab; border:1px solid rgba(0,0,0,.04);
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .card:active{cursor:grabbing}
  .card.small{min-width:140px}
  .card .tag{font-size:12px; color:#9CA3AF}
  .card.dragging{opacity:.9; transform:rotate(2deg) scale(1.03)}
  .card.follow{position:fixed; z-index:9999; pointer-events:none; transform:translate(-50%,-50%) scale(1.03);} 

  .drop-highlight{outline:2px dashed rgba(0,0,0,.15); outline-offset:-6px}
  .bucket.hover{outline:3px solid rgba(108,121,255,.35); outline-offset:-6px}

  .footer{
    margin-top:14px; display:flex; flex-wrap:wrap; gap:8px; align-items:center
  }
  .score{font-weight:700}
  .pill{background:#fff; border-radius:999px; padding:6px 10px; box-shadow:var(--shadow); font-size:12px}

  /* Modal for tap-to-place on mobile */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.15); display:none; align-items:flex-end}
  .sheet{background:#fff; border-radius:18px 18px 0 0; padding:12px; box-shadow:0 -10px 30px rgba(0,0,0,.15); width:100%}
  .sheet h4{margin:4px 6px 10px}
  .choices{display:flex; gap:10px}
  .choice{flex:1; padding:12px; border-radius:14px; border:1px solid rgba(0,0,0,.08); display:flex; gap:8px; align-items:center; justify-content:center}
  .choice[data-target="teacher"]{background:var(--pink)}
  .choice[data-target="learner"]{background:var(--green)}
  .choice[data-target="over"]{background:var(--yellow)}

  .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111; color:#fff; padding:10px 14px; border-radius:999px; font-size:14px; display:none}

  /* Result panel */
  .result{display:none; margin-top:16px; background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:14px}
  .result h3{margin:0 0 8px}
  .badlist{display:grid; grid-template-columns: 1fr; gap:8px}
  @media(min-width:760px){.badlist{grid-template-columns: 1fr 1fr}}
  .baditem{background:linear-gradient(180deg,#fff,#FFF9FB); border:1px solid #FFE1E6; border-radius:14px; padding:10px}
  .baditem .rewrite{margin-top:6px; background:#F0FFF7; border:1px dashed #BEE8D2; padding:8px; border-radius:10px; font-size:14px}

  /* Cute confetti */
  .confetti{position:fixed; inset:0; pointer-events:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <span style="font-size:20px">ğŸ¯</span>
      <h1>EPA é—œå¡ 1ï½œæŠŠã€Œæ•™å­¸æ±ºç­–èªå¥ã€åˆ†é¡</h1>
      <span class="badge">Mobile-first Â· æ‹–æ‹‰ or é»é¸æ”¾ç½®</span>
    </div>
    <div class="toolbar">
      <button class="ghost" id="btnShuffle">æ´—ç‰Œ</button>
      <button class="ghost" id="btnReset">é‡ç½®</button>
      <button class="ghost" id="btnHint">æç¤º Ã— <span id="hintLeft">2</span></button>
      <button class="primary" id="btnCheck">é€å‡ºåˆ¤å®š</button>
    </div>
  </header>

  <p class="hint">è«‹æŠŠä¸‹æ–¹å¥å­æ‹–æ”¾åˆ°æ­£ç¢ºçš„é¡åˆ¥ã€‚æç¤ºï¼š<b>å­¸å“¡ä¸­å¿ƒ â‰  ç„¡æ¢ä»¶åŒ…å®¹</b>ï¼Œè€Œæ˜¯ä¾èƒ½åŠ›åˆ†ç´šçš„ã€Œè²¬ä»»å§”è¨—ã€ã€‚</p>

  <div class="grid">
    <section class="pool" id="pool">
      <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:8px">ğŸƒ å¾…åˆ†é¡å¡ç‰‡</h3>
      <div class="cards" id="poolCards"></div>
    </section>

    <section class="bucket" data-category="teacher">
      <h3><span>ğŸ‘©â€ğŸ«</span> æ•™å¸«ä¸­å¿ƒ</h3>
      <div class="cards"></div>
    </section>

    <section class="bucket" data-category="learner">
      <h3><span>ğŸŒ±</span> å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰</h3>
      <div class="cards"></div>
    </section>

    <section class="bucket" data-category="over">
      <h3><span>ğŸ’—</span> éåº¦åŒ…å®¹ï¼ˆä¸å¥åº·ï¼‰</h3>
      <div class="cards"></div>
    </section>
  </div>

  <div class="footer">
    <span class="pill">é•·æŒ‰æ‹–å‹•ï¼Œæˆ–è¼•é»å¡ç‰‡ä»¥é¸æ“‡é¡åˆ¥</span>
    <span class="pill">åŠæ ¼é–€æª»ï¼š80 åˆ†</span>
    <span class="pill" id="progress">0 / 0 å·²åˆ†é¡</span>
  </div>

  <section class="result" id="result">
    <h3>è§£æ</h3>
    <p style="margin:0 0 10px">ä½ çš„åˆ†æ•¸ï¼š<b id="score">0</b> åˆ†ã€‚ä¸‹é¢æ˜¯éœ€è¦èª¿æ•´çš„å¥å­èˆ‡ã€Œå­¸å“¡ä¸­å¿ƒè½‰è­¯ã€ã€‚</p>
    <div class="badlist" id="badlist"></div>
  </section>
</div>

<div class="modal" id="modal">
  <div class="sheet">
    <h4>æŠŠé€™å¥è©±æ”¾åˆ°å“ªä¸€é¡ï¼Ÿ</h4>
    <div class="choices">
      <div class="choice" data-target="teacher">ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ</div>
      <div class="choice" data-target="learner">ğŸŒ± å­¸å“¡ä¸­å¿ƒ</div>
      <div class="choice" data-target="over">ğŸ’— éåº¦åŒ…å®¹</div>
    </div>
    <div style="margin-top:10px; font-size:13px; color:#6b7280">æ²’æœ‰æŠŠæ¡ï¼Ÿé»é¸ä¸Šæ–¹ã€Œæç¤ºã€å¯ç²å¾— 50/50 ç·šç´¢æˆ–èªªæ˜ã€‚</div>
  </div>
</div>
<div class="toast" id="toast">å·²æ”¾ç½®</div>
<canvas class="confetti" id="confetti"></canvas>

<script>
  // ==== é¡Œåº«ï¼ˆ12ï½15 å¥ï¼‰====
  const BANK = [
    {text:"é€™å€‹å·¥ä½œæˆ‘è‡ªå·±åšæ¯”è¼ƒå¿«ï¼Œå­¸å“¡çœ‹æˆ‘å°±å¥½ã€‚", type:"teacher", rewrite:"è®“å­¸å“¡å…ˆåšä¸€æ¬¡ï¼Œæˆ‘åœ¨æ—é‚Šå®‰å…¨ç›£ç£ä¸¦å³æ™‚å›é¥‹ã€‚", reason:"æŠŠæ•ˆç‡æ”¾åœ¨æ•™å¸«èº«ä¸Šï¼›æœªæä¾›å­¸å“¡å¯å§”è¨—çš„ç‰‡æ®µèˆ‡å›é¥‹å¾ªç’°ã€‚"},
    {text:"æˆ‘è¦ºå¾—ä»–å·®ä¸å¤šäº†ï¼Œå¯ä»¥æ”¾æ‰‹è®“ä»–åšã€‚", type:"teacher", rewrite:"ä»–å·²ç¬¦åˆ 3a çš„æ¨™æº–æƒ…å¢ƒï¼Œæˆ‘æœƒåœ¨å¯é æœŸæƒ…å¢ƒä¸‹åŠç›£ç£æ”¾æ‰‹ã€‚", reason:"ä»¥æ•™å¸«ä¸»è§€æ„Ÿè¦ºç‚ºä¾æ“šï¼Œæœªå°æ‡‰å…·é«”ç­‰ç´šèˆ‡æƒ…å¢ƒã€‚"},
    {text:"ç­‰æˆ‘æœ‰ç©ºå†å¸¶ä»–ç·´ã€‚", type:"teacher", rewrite:"å®‰æ’çŸ­æ™‚æ®µå¾®æ¼”ç·´ï¼Œç¢ºä¿æ¯å¤©éƒ½æœ‰ç·´ç¿’èˆ‡å›é¥‹å¾ªç’°ã€‚", reason:"ä»¥æ•™å¸«æ™‚é–“ç‚ºä¸­å¿ƒï¼Œç¼ºä¹è¦å¾‹åŒ–çš„å­¸å“¡ç·´ç¿’å®‰æ’ã€‚"},
    {text:"ä»Šå¤©äº¤ç­å¾ˆè¶•ï¼Œå°±ä¸è¦è®“å­¸å“¡è¬›äº†ã€‚", type:"teacher", rewrite:"è®“å­¸å“¡å…ˆåšç²¾è¦ç‰ˆï¼Œæˆ‘è£œé—œéµä¸¦æ§åˆ¶é¢¨éšªã€‚", reason:"ç”¨æ™‚é–“å£“åŠ›å–ä»£å­¸ç¿’æ©Ÿæœƒï¼›æœªè¨­è¨ˆä½é¢¨éšªçš„å¯å§”è¨—ç‰‡æ®µã€‚"},

    {text:"ä»–å·²èƒ½ä¾æ­¥é©Ÿå®Œæˆï¼Œä½†ä¿¡å¿ƒä¸è¶³ï¼Œçµ¦ä¸€æ¬¡ç¨ç«‹å®Œæˆçš„æ©Ÿæœƒã€‚", type:"learner", rewrite:"â€”â€”", reason:"æ ¹æ“šè¡¨ç¾èª¿æ•´ç›£ç£å¼·åº¦ï¼Œæä¾›å¯æŒæ¡æŒ‘æˆ°ä»¥å¼·åŒ–è‡ªæˆ‘æ•ˆèƒ½ã€‚"},
    {text:"æ­¤ä»»å‹™é›£åº¦é©ä¸­ï¼Œæ­£å¥½æŒ‘æˆ°ä»–çš„ä¸‹ä¸€éšèƒ½åŠ›ã€‚", type:"learner", rewrite:"â€”â€”", reason:"ä»¥å­¸å“¡ç•¶å‰èƒ½åŠ›åšé…é©ï¼Œå‰µé€ å¯é”æˆçš„ä¼¸å±•ç›®æ¨™ã€‚"},
    {text:"æˆ‘å…ˆè§€å¯Ÿä»–åšä¸€æ¬¡ï¼ŒçµæŸå¾Œçµ¦ 2 æ¢å…·é«”å¯æ”¹é€²å»ºè­°ã€‚", type:"learner", rewrite:"â€”â€”", reason:"å¼·èª¿å¯è§€å¯Ÿè¡Œç‚ºèˆ‡å…·é«”å›é¥‹ï¼Œæ”¯æ´æˆé•·å¾ªç’°ã€‚"},
    {text:"è®“å­¸å“¡å…ˆäº¤ç­ï¼Œæˆ‘è² è²¬æŠŠé—œå®‰å…¨èˆ‡æ™‚é–“ã€‚", type:"learner", rewrite:"â€”â€”", reason:"è¨­å®šé‚Šç•Œä¸¦åˆ†æ“”é¢¨éšªï¼Œå±¬è²¬ä»»åˆ†ç´šä¸‹çš„å§”è¨—ã€‚"},

    {text:"ä»–æ²’æº–å‚™ä¹Ÿæ²’é—œä¿‚ï¼Œä¸‹æ¬¡å†èªªã€‚", type:"over", rewrite:"å…ˆç•Œå®šæœ€å°å®‰å…¨ä»»å‹™ï¼Œçµ¦æ˜ç¢ºé æœŸèˆ‡ä¸‹æ¬¡å‰è¦é”åˆ°çš„æº–å‚™ã€‚", reason:"æ¨¡ç³Šæ¨™æº–ã€æ”¾ä»»å»¶å®•ï¼Œç„¡åŠ©æ–¼å­¸ç¿’èˆ‡å®‰å…¨ã€‚"},
    {text:"åˆ¥è·Ÿä»–èªªéŒ¯åœ¨å“ªï¼Œå…å¾—æ‰“æ“Šä¿¡å¿ƒã€‚", type:"over", rewrite:"å›é¥‹èšç„¦åœ¨è¡Œç‚ºèˆ‡çµæœï¼Œé¿å…è²¼æ¨™ç±¤ï¼ŒåŒæ™‚çµ¦ä¸‹ä¸€æ­¥å…·é«”ä½œæ³•ã€‚", reason:"ä»¥ä¿è­·ç‚ºåè¿´é¿å›é¥‹ï¼Œå‰Šå¼±å­¸ç¿’æˆæ•ˆã€‚"},
    {text:"æˆ‘ä¾†è™•ç†å°±å¥½ï¼Œä¸ç”¨éº»ç…©ä»–ã€‚", type:"over", rewrite:"åˆ‡å‡ºå¯å§”è¨—ç‰‡æ®µï¼Œè®“ä»–åœ¨æˆ‘ç›£ç£ä¸‹è² è²¬ä¸€å°æ®µã€‚", reason:"å‰å¥ªç·´ç¿’æ©Ÿæœƒä¸”ç„¡æˆé•·è²¬ä»»ã€‚"},

    {text:"ä»–æŠ½è¡€æŠ€å·§é‚„ä¸ç†Ÿï¼Œå…ˆç”¨ DOPS é›†ä¸­ç·´ç¿’ 3 æ¬¡ã€‚", type:"learner", rewrite:"â€”â€”", reason:"åˆ†é›¢å–®ä¸€æŠ€èƒ½ä»¥ DOPS é‡å°ç·´ï¼Œç”¨æ–¼æ”¯æ’ EPA ä»»å‹™è¡¨ç¾ã€‚"},
    {text:"äº¤ç­å…§å®¹å¸¸éºæ¼é‡é»ï¼Œè®“ä»–ç”¨ ISBAR çµæ§‹ç·´ç¿’ä¸¦éŒ„éŸ³å›é¡§ã€‚", type:"learner", rewrite:"â€”â€”", reason:"å°å…¥çµæ§‹åŒ–å·¥å…·èˆ‡è‡ªæˆ‘å›é¡§ï¼Œæå‡ä»»å‹™å“è³ªã€‚"},
    {text:"æ˜¨å¤©ä»–å‡ºç¾å…©æ¬¡é«˜é¢¨éšªéŒ¯èª¤ï¼Œä»Šå¤©æ”¹å›å…¨ç¨‹ç›£ç£ã€‚", type:"learner", rewrite:"â€”â€”", reason:"ä¾é¢¨éšªå‹•æ…‹èª¿æ•´ç›£ç£å¼·åº¦ï¼Œç¢ºä¿å®‰å…¨ç‚ºå…ˆã€‚"}
  ];

  // ==== ç‹€æ…‹ ====
  const $pool = document.getElementById('poolCards');
  const $buckets = [...document.querySelectorAll('.bucket')];
  const $progress = document.getElementById('progress');
  const $result = document.getElementById('result');
  const $badlist = document.getElementById('badlist');
  const $score = document.getElementById('score');
  const $toast = document.getElementById('toast');
  const $modal = document.getElementById('modal');
  let activeCard = null;
  let hintLeft = 2; const $hintLeft = document.getElementById('hintLeft');
  // è§¸æ§æ‹–æ›³ç‹€æ…‹
  let pointerDragging=false; let dragOffsetX=0, dragOffsetY=0; let originParent=null; let currentHoverBucket=null;

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}
    return arr
  }

  function makeCard(item, idx){
    const el=document.createElement('div');
    el.className='card';
    el.textContent=item.text;
    el.dataset.key=idx;
    el.draggable=true;
    // Mouse drag (æ¡Œæ©Ÿ)
    el.addEventListener('dragstart', e=>{el.classList.add('dragging'); e.dataTransfer.setData('text/plain', idx);});
    el.addEventListener('dragend', ()=>el.classList.remove('dragging'));
    // Tap-to-place (æ‰‹æ©Ÿå‚™æ´)
    el.addEventListener('click', ()=>{ if(pointerDragging) return; activeCard=el; $modal.style.display='flex'});
    // Pointer touch-drag (æ‰‹æ©Ÿä¸»è¦)
    el.addEventListener('pointerdown', (e)=>{
      if(e.pointerType!=='touch') return; // åƒ…åœ¨è§¸æ§å•Ÿç”¨è‡ªè£½æ‹–æ›³
      e.preventDefault();
      activeCard=el; pointerDragging=true; originParent=el.parentElement;
      const rect=el.getBoundingClientRect();
      dragOffsetX=e.clientX - rect.left - rect.width/2;
      dragOffsetY=e.clientY - rect.top - rect.height/2;
      el.classList.add('follow');
      el.style.width=rect.width+'px';
      moveFollow(el, e.clientX - dragOffsetX, e.clientY - dragOffsetY);
      window.addEventListener('pointermove', onPointerMove, {passive:false});
      window.addEventListener('pointerup', onPointerUp, {once:true});
    });
    return el
  }

  function renderPool(){
    $pool.innerHTML='';
    shuffle(BANK).forEach((item,i)=> $pool.appendChild(makeCard(item, i)) );
    updateProgress();
  }

  function updateProgress(){
    const total=BANK.length;
    const placed= total - $pool.querySelectorAll('.card').length;
    $progress.textContent=`${placed} / ${total} å·²åˆ†é¡`;
  }

  // Buckets: dragover/dropï¼ˆæ¡Œæ©Ÿï¼‰
  $buckets.forEach(b=>{
    const box=b.querySelector('.cards');
    b.addEventListener('dragover', e=>{e.preventDefault(); box.classList.add('drop-highlight')});
    b.addEventListener('dragleave', ()=> box.classList.remove('drop-highlight'));
    b.addEventListener('drop', e=>{
      e.preventDefault();
      const key=e.dataTransfer.getData('text/plain');
      const card=[...document.querySelectorAll('.card')].find(c=>c.dataset.key===key);
      if(card){ box.appendChild(card); showToast('å·²æ”¾ç½®'); }
      box.classList.remove('drop-highlight');
      updateProgress();
    });
  })

  // Modal chooseï¼ˆæ‰‹æ©Ÿå‚™æ´ï¼‰
  $modal.addEventListener('click', (e)=>{
    if(e.target.classList.contains('choice')){
      const target=e.target.dataset.target;
      const bucket=document.querySelector(`.bucket[data-category="${target}"] .cards`);
      if(activeCard && bucket){ bucket.appendChild(activeCard); showToast('å·²æ”¾ç½®'); }
      $modal.style.display='none'; activeCard=null; updateProgress();
    } else if(e.target.classList.contains('modal')){
      $modal.style.display='none'; activeCard=null;
    }
  });

  // Buttons
  document.getElementById('btnReset').addEventListener('click', ()=>{renderPool(); $buckets.forEach(b=>b.querySelector('.cards').innerHTML=''); $result.style.display='none';});
  document.getElementById('btnShuffle').addEventListener('click', ()=>{renderPool()});
  document.getElementById('btnCheck').addEventListener('click', checkAnswers);
  document.getElementById('btnHint').addEventListener('click', useHint);

  function checkAnswers(){
    // Compute score
    let correct=0; let wrong=[]; const total=BANK.length; const weight=Math.floor(100/total);
    // scan each card and compare bucket
    document.querySelectorAll('.card').forEach(card=>{
      const key=Number(card.dataset.key); const answer=BANK[key].type;
      const parentBucket = card.closest('.bucket');
      const user = parentBucket ? parentBucket.dataset.category : 'pool';
      if(user===answer){ correct++; sparkle(card) } else { if(user!=='pool') wrong.push({text:BANK[key].text, rewrite:BANK[key].rewrite, should:answer, reason:BANK[key].reason}) }
    })
    const score = Math.round( (correct/total) * 100 );
    $score.textContent=score;
    // render wrong list
    $badlist.innerHTML='';
    wrong.forEach(w=>{
      const div=document.createElement('div'); div.className='baditem';
      const shouldLabel = w.should==='teacher'?'æ•™å¸«ä¸­å¿ƒ': w.should==='learner'?'å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰':'éåº¦åŒ…å®¹';
      div.innerHTML=`<div><b>æ‡‰è©²åˆ†é¡ï¼š</b>${shouldLabel}</div><div style="margin-top:6px">${w.text}</div>`;
      if(w.rewrite && w.rewrite!=='â€”â€”'){
        const rw=document.createElement('div'); rw.className='rewrite'; rw.innerHTML=`<b>å­¸å“¡ä¸­å¿ƒè½‰è­¯ï¼š</b>${w.rewrite}<br><span style="color:#6b7280">ç‚ºä»€éº¼ï¼Ÿ${w.reason}</span>`; div.appendChild(rw);
      } else {
        const rw=document.createElement('div'); rw.className='rewrite'; rw.innerHTML=`<b>ç‚ºä»€éº¼ï¼Ÿ</b>${w.reason}`; div.appendChild(rw);
      }
      $badlist.appendChild(div);
    })
    $result.style.display='block';
    if(score>=80) celebrate();
  }

  function useHint(){
    if(hintLeft<=0){ showToast('æç¤ºå·²ç”¨å®Œ'); return; }
    if(!activeCard){ showToast('è«‹å…ˆé»é¸ä¸€å¼µå¡ç‰‡'); return; }
    const key=Number(activeCard.dataset.key); const answer=BANK[key].type; const categories=['teacher','learner','over'];
    // 50/50: ç•™ä¸‹æ­£ç¢º + ä¸€å€‹éš¨æ©ŸéŒ¯èª¤
    const wrongs = categories.filter(c=>c!==answer); const keep = wrongs[Math.floor(Math.random()*wrongs.length)];
    const options = [answer, keep].map(c=> c==='teacher'?'ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ': c==='learner'?'ğŸŒ± å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰':'ğŸ’— éåº¦åŒ…å®¹');
    showToast('å¯èƒ½æ˜¯ï¼š'+options.join(' æˆ– '));
    // é¡¯ç¤ºç°¡çŸ­èªªæ˜
    const tip = BANK[key].reason;
    setTimeout(()=>{ showToast('ç·šç´¢ï¼š'+tip) }, 900);
    hintLeft--; $hintLeft.textContent=hintLeft;
  }

  function showToast(msg){$toast.textContent=msg; $toast.style.display='block'; setTimeout(()=>{$toast.style.display='none'},700)}

  // è§¸æ§æ‹–æ›³ï¼šå®šä½èˆ‡æ”¾ç½®
  function getBucketAt(x,y){
    const els = document.elementsFromPoint(x,y);
    return els.find(e=> e.classList && e.classList.contains('bucket')) || null;
  }
  function clearHover(){ if(currentHoverBucket){ currentHoverBucket.classList.remove('hover'); currentHoverBucket=null; } }
  function moveFollow(el, x, y){ el.style.left=x+'px'; el.style.top=y+'px'; el.style.transform='translate(-50%, -50%) scale(1.03)'; }
  function onPointerMove(e){ if(!pointerDragging||!activeCard) return; e.preventDefault();
    moveFollow(activeCard, e.clientX - dragOffsetX, e.clientY - dragOffsetY);
    const b = getBucketAt(e.clientX, e.clientY); if(b!==currentHoverBucket){ clearHover(); if(b){ b.classList.add('hover'); currentHoverBucket=b; } }
  }
  function onPointerUp(e){
    window.removeEventListener('pointermove', onPointerMove);
    if(!activeCard) return;
    if(currentHoverBucket){ currentHoverBucket.classList.remove('hover'); currentHoverBucket.querySelector('.cards').appendChild(activeCard); showToast('å·²æ”¾ç½®'); }
    else { originParent && originParent.appendChild(activeCard); }
    activeCard.classList.remove('follow'); activeCard.style.left=''; activeCard.style.top=''; activeCard.style.width=''; activeCard.style.transform='';
    activeCard=null; pointerDragging=false; clearHover(); updateProgress();
  }

  // Confetti celebration
  const canvas=document.getElementById('confetti'); const ctx=canvas.getContext('2d'); let pieces=[]; function resize(){canvas.width=innerWidth; canvas.height=innerHeight} window.addEventListener('resize', resize); resize();
  function celebrate(){
    pieces=[...Array(120)].map(()=>({x:Math.random()*canvas.width, y:-20, r:6+Math.random()*8, vy:2+Math.random()*3, vx:(Math.random()-.5)*2, a:Math.random()*360, col: ['#FFB3C1','#BDE5D2','#FDE49C','#C9C8FF'][Math.floor(Math.random()*4)]}));
    let t=0; const tick=()=>{ctx.clearRect(0,0,canvas.width,canvas.height); pieces.forEach(p=>{p.y+=p.vy; p.x+=p.vx; p.a+=5; drawConfetti(p)}); t++; if(t<160) requestAnimationFrame(tick); else ctx.clearRect(0,0,canvas.width,canvas.height)}; tick();
  }
  function drawConfetti(p){ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a*Math.PI/180); ctx.fillStyle=p.col; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore()}

  // init
  renderPool();
</script>
</body>
</html>
