<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³ âœ¦ï¼ˆæ¼«ç•«ç‰ˆï¼‹å¾Œå°ç´€éŒ„ï¼‰</title>
<style>
  :root{
    --bg:#FAF7FF;
    --card:#FFFFFF;
    --shadow:0 6px 18px rgba(0,0,0,.08);
    --t:#2b2b2b;
    --muted:#667085;
    --green:#B7F0D1;
    --pink:#FFD6DE;
    --yellow:#FFE9A9;
    --ring:#9BA6FF;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial;
    background:
      radial-gradient(900px 600px at 110% -10%, #FFE9F3 0%, rgba(255,233,243,0) 60%),
      radial-gradient(900px 600px at -10% -10%, #E9EDFF 0%, rgba(233,237,255,0) 60%),
      var(--bg);
    color:var(--t);
  }
  .wrap{max-width:980px; margin:0 auto; padding:16px 16px 28px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap}
  .title{ display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-radius:16px; box-shadow:var(--shadow); }
  .title h1{font-size:20px; margin:0; font-weight:700}
  .badge{font-size:12px; color:#4B5563; background:linear-gradient(180deg,#fff, #F6F9FF); border:1px solid #E8EBFF; padding:6px 10px; border-radius:999px}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; z-index:2; position:relative}
  button{border:0; border-radius:14px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition:transform .05s ease}
  button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#7A86FF, #6C79FF); color:#fff}
  .ghost{background:#fff}
  .leveltab{background:#fff}
  .leveltab.active{background:#EEF0FF; border:1px solid #C9CDFF}
  .hint{margin:10px 0 16px; color:var(--muted); font-size:14px}

  /* Comic card */
  .comic{background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:14px; margin:12px 0}
  .scene{font-size:13px; color:#6b7280; margin-bottom:8px}
  .frames{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .frame{background:#f8fafc; border-radius:14px; padding:10px; min-height:68px; position:relative}
  .who{position:absolute; top:-10px; left:10px; font-size:12px; background:#fff; padding:2px 8px; border-radius:999px; box-shadow:var(--shadow)}
  .teacher{border-left:6px solid #ffb3c1}
  .learner{border-left:6px solid #b7f0d1}
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .pillbtn{flex:1; text-align:center; padding:10px; border-radius:12px; border:1px solid rgba(0,0,0,.06); background:#fff; cursor:pointer; box-shadow:var(--shadow)}
  .pillbtn[data-ans="teacher"]{background:linear-gradient(180deg,#ffffff,#ffe6eb)}
  .pillbtn[data-ans="learner"]{background:linear-gradient(180deg,#ffffff,#eafff2)}
  .pillbtn[data-ans="over"]{background:linear-gradient(180deg,#ffffff,#fff3cf)}

  .result{display:none; margin-top:16px; background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:14px}
  .result h3{margin:0 0 8px}

  /* Help modal */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.15); display:none; align-items:center; justify-content:center; z-index:5}
  .cardhelp{background:#fff; width:min(92%,680px); border-radius:18px; box-shadow:var(--shadow); padding:16px}
  .helpgrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .helpitem{background:#fff; border-radius:16px; padding:12px; box-shadow:var(--shadow)}
  .helpitem.teacher{background:linear-gradient(180deg,#fff,#ffe6eb)}
  .helpitem.learner{background:linear-gradient(180deg,#fff,#eafff2)}
  .lock{opacity:.6; filter:grayscale(.3)}

  .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111; color:#fff; padding:10px 14px; border-radius:999px; font-size:14px; display:none; z-index:6}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <span style="font-size:22px">ğŸ“š</span>
      <h1>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³ âœ¦</h1>
      <span class="badge">æ¼«ç•«åˆ†é¡ Â· èªªæ˜å¡ Â· å¾Œå°ç´€éŒ„</span>
    </div>
    <div class="toolbar">
      <button class="leveltab active" data-level="1">é—œå¡1</button>
      <button class="leveltab" data-level="2">é—œå¡2</button>
      <button class="leveltab" data-level="H">èªªæ˜å°ˆå€</button>
    </div>
    <div class="toolbar">
      <button class="ghost" id="btnReset">é‡ç½®æœ¬é—œ</button>
      <button class="primary" id="btnSubmit">é€å‡ºæœ¬é—œ</button>
    </div>
  </header>

  <p class="hint" id="intro">é—œå¡1ï¼šè‡¨åºŠè¿·ä½ åŠ‡æœ¬ï¼Œè«‹æŠŠä¸‹åˆ—æƒ…å¢ƒåˆ†é¡ã€‚</p>

  <div id="quiz"></div>

  <section class="result" id="result">
    <h3>çµæœ</h3>
    <p>æœ¬é—œç­”å° <b id="ok">0</b> é¡Œã€ç­”éŒ¯ <b id="bad">0</b> é¡Œã€‚</p>
  </section>
</div>

<!-- Help modal -->
<div class="modal" id="helpModal">
  <div class="cardhelp">
    <h3 style="margin:0 0 8px">èªªæ˜å¡</h3>
    <div class="helpgrid">
      <div class="helpitem teacher">
        <h4 style="margin:0 0 6px">æ•™å¸«ä¸­å¿ƒ</h4>
        <div style="font-size:14px; color:#374151">ç”±æ•™å¸«ä¸»å°æµç¨‹ï¼Œå­¸å“¡åƒèˆ‡ä½ï¼›ä»¥æ™‚é–“æ•ˆç‡ç‚ºä¸»ï¼Œç·´ç¿’èˆ‡å›é¥‹è¼ƒå°‘ã€‚</div>
        <ul style="font-size:14px; margin:8px 0 0; padding-left:18px">
          <li>æˆ‘å…ˆèªªå®Œé‡é»ï¼Œä¹‹å¾Œå†è®“ä½ å˜—è©¦ã€‚</li>
          <li>æˆ‘ç¤ºç¯„ä¸€æ¬¡ï¼Œä½ å…ˆçœ‹ã€‚</li>
        </ul>
      </div>
      <div class="helpitem learner">
        <h4 style="margin:0 0 6px">å­¸å“¡ä¸­å¿ƒ</h4>
        <div style="font-size:14px; color:#374151">æŒ‰å­¸å“¡ç‹€æ…‹å®‰æ’ç·´ç¿’ã€å³æ™‚å›é¥‹èˆ‡æ¼¸é€²æ”¾æ‰‹ï¼Œåœ¨å®‰å…¨æƒ…å¢ƒä¸‹æ‰¿æ“”è²¬ä»»ã€‚</div>
        <ul style="font-size:14px; margin:8px 0 0; padding-left:18px">
          <li>ä½ å…ˆåšä¸€æ¬¡ï¼Œæˆ‘åœ¨æ—è§€å¯Ÿï¼ŒçµæŸçµ¦å…©é»å»ºè­°ã€‚</li>
          <li>å…ˆç·´ ISBARï¼ŒéŒ„éŸ³å¾Œä¸€èµ·å›é¡§ã€‚</li>
        </ul>
      </div>
    </div>
    <div style="text-align:right; margin-top:10px"><button class="ghost" id="closeHelp">é—œé–‰</button></div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxRrGoxGPoZF318CYE9CyZhs69flPQ1TIdB_2ljhVR2VMUxNY07TpXrWgTiJ3iAlayHSQ/exec";
const usp = new URLSearchParams(location.search);
const TID = usp.get('tid') || '';
const GROUP = usp.get('group') || '';
const PRACTICE = usp.get('practice') === '1'; // 1=å¯å…ˆçœ‹èªªæ˜

// é¡Œåº«ï¼ˆæ¼«ç•«åˆ†é¡ï¼‰
const BANKS = {
  1: [
    { id:'L1-01', type:'teacher', scene:'äº¤ç­å‰ 5 åˆ†é˜ï¼Œå€¼ç­ç¹å¿™ã€‚', t:'é€™æ¬¡äº¤ç­æ™‚é–“å¾ˆç·Šï¼Œæˆ‘å…ˆèªªå®Œé‡é»ï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒå†è®“ä½ å˜—è©¦ã€‚', s:'å¥½çš„ã€‚' },
    { id:'L1-02', type:'teacher', scene:'ç—…æˆ¿ä¾‹è¡Œè™•ç½®ã€‚', t:'é€™å€‹è­·ç†å¾ˆç°¡å–®ï¼Œæˆ‘åšä¸€æ¬¡ï¼Œå°±æ›ä½ ã€‚', s:'äº†è§£ã€‚' },
    { id:'L1-03', type:'teacher', scene:'é€£çºŒå…©å¤©åœ¨ç›¸åŒæ­¥é©Ÿå¡ä½ã€‚', t:'ä½ å·²ç¶“å¡é€™æ®µç¬¬2æ¬¡ï¼Œéƒ½èªè­˜ç—…äººï¼Œæ‡‰è©²å¯ä»¥è‡ªå·±å»çµ¦è—¥å§ã€‚', s:'â€¦' },
    { id:'L1-04', type:'teacher', scene:'å¸¶æ•™ä¸€é€±å¾Œã€‚', t:'æˆ‘è¦ºå¾—ä¸€é€±ä¹Ÿå·®ä¸å¤šäº†å§ï¼Œå¯ä»¥æ”¾æ‰‹è®“ä»–åšã€‚', s:'' },
    { id:'L1-05', type:'learner', scene:'æŠ½è¡€ç·´ç¿’ã€‚', t:'å‰›å‰›çœ‹ä½ æŠ½è¡€é‚„ä¸ç†Ÿï¼Œç­‰ä¸€ä¸‹æˆ‘å†åšä¸€æ¬¡é‚Šèªªæ˜ï¼Œä¸‹ä¸€åºŠæ›ä½ æŠ½è¡€ï¼Œæˆ‘æœƒåœ¨æ—é‚Šå¹«ä½ ã€‚', s:'å¥½ï¼Œè¬è¬è€å¸«ã€‚' },
    { id:'L1-06', type:'learner', scene:'äº¤ç­è¨“ç·´ã€‚', t:'ä½ å…ˆç”¨ ISBAR äº¤ç­ä¸€æ¬¡ï¼Œæˆ‘å€‘éŒ„ä¸‹ä¾†ä¹‹å¾Œä¸€èµ·å›é¡§ã€‚', s:'OKã€‚' },
    { id:'L1-07', type:'learner', scene:'äº¤ç­å‰ã€‚', t:'æ˜¨å¤©è¨è«–éäº¤ç­ï¼Œä»Šå¤©äº¤ç­å‰æˆ‘å€‘å…ˆç·´ä¸€æ¬¡ï¼Œæ”¾è¼•é¬†ã€‚', s:'å¥½ã€‚' },
    { id:'L1-08', type:'learner', scene:'çµ¦è—¥èˆ‡è¡›æ•™ã€‚', t:'æˆ‘çœ‹ä½ çµ¦è—¥å·²ç¶“é †äº†ï¼Œä½†è¡›æ•™æœ‰æ™‚ä¸é †ï¼Œæ‰€ä»¥å°šæœªåˆ¤å®šç¨ç«‹ï¼›æˆ‘å€‘å…ˆæŠŠè¡›æ•™ç·´å¥½ã€‚', s:'æ˜ç™½ã€‚' },
    { id:'L1-09', type:'over', scene:'å¸¶æ•™å›é¥‹ã€‚', t:'æ€•æ‰“æ“Šä»–çš„ä¿¡å¿ƒï¼Œå°±èªªåšå¾—ä¸éŒ¯å§ã€‚', s:'' }
  ],
  2: [
    { id:'L2-01', type:'over', scene:'æª¢è¨å­¸ç¿’ç‹€æ…‹ã€‚', t:'ä»–å›å»æ²’è¤‡ç¿’ä¹Ÿæ²’é—œä¿‚ï¼Œä¸‹æ¬¡å†èªªã€‚', s:'' },
    { id:'L2-02', type:'over', scene:'åœ˜éšŠé—œä¿‚ã€‚', t:'ç‚ºäº†ä¸–ç•Œå’Œå¹³ï¼ŒéŒ¯èª¤å°±å…ˆä¸æäº†å§ã€‚', s:'' },
    { id:'L2-03', type:'over', scene:'é«˜å£“æƒ…å¢ƒã€‚', t:'ä»–å¥½åƒå¾ˆæ€•ï¼Œæˆ‘æ›´æ€•ï¼Œæˆ‘è‡ªå·±åšå§ã€‚', s:'' },
    { id:'L2-04', type:'teacher', scene:'äº¤ç­æ™‚é–“ç·Šã€‚', t:'ä»Šå¤©äº¤ç­å¾ˆè¶•ï¼Œå°±ä¸è¦è®“å­¸å“¡è¬›äº†ã€‚', s:'' },
    { id:'L2-05', type:'teacher', scene:'ç¤ºç¯„å¾Œã€‚', t:'é€™æ¬¡æˆ‘å…ˆåšç¤ºç¯„ï¼Œå­¸å“¡çœ‹å°±å¥½ã€‚', s:'' },
    { id:'L2-06', type:'teacher', scene:'è¦åŠƒç·´ç¿’ã€‚', t:'ç­‰æˆ‘æœ‰ç©ºå†å¸¶ä»–ç·´ã€‚', s:'' },
    { id:'L2-07', type:'teacher', scene:'ä¸»è§€æ”¾æ‰‹ã€‚', t:'æˆ‘è¦ºå¾—ä»–å·®ä¸å¤šäº†ï¼Œå¯ä»¥æ”¾æ‰‹è®“ä»–åšã€‚', s:'' },
    { id:'L2-08', type:'learner', scene:'æŠ€èƒ½æ”¯æŒã€‚', t:'æŠ½è¡€æŠ€å·§ä¸ç†Ÿï¼Œæˆ‘å€‘ä»Šå¤©è§€å¯Ÿ3æ¬¡ï¼Œæ¯æ¬¡çµ¦ä½ 2é»å»ºè­°ï¼Œç„¶å¾Œè®“ä½ è‡ªå·±åšä¸€æ¬¡ã€‚', s:'äº†è§£ã€‚' },
    { id:'L2-09', type:'learner', scene:'çµæ§‹åŒ–äº¤ç­ã€‚', t:'äº¤ç­å¸¸éºæ¼é‡é»ï¼Œæ”¹ç”¨ ISBAR ä¸¦éŒ„éŸ³å›é¡§ã€‚', s:'å¥½ã€‚' },
    { id:'L2-10', type:'learner', scene:'é¢¨éšªèª¿æ•´ã€‚', t:'æ˜¨å¤©å…©æ¬¡é«˜é¢¨éšªéŒ¯èª¤ï¼Œä»Šå¤©æˆ‘æœƒå…¨ç¨‹é™ªä½ åšä¸€æ¬¡å†æ”¾æ¬Šã€‚', s:'å¥½ã€‚' },
    { id:'L2-11', type:'learner', scene:'å¯é æœŸæƒ…å¢ƒã€‚', t:'å¸¸è¦ç—…äººå·²èƒ½ç©©å®šè™•ç†ï¼Œæˆ‘åœ¨æ—å”åŠ©ä½†ä¸ä»‹å…¥ï¼Œç­‰ä½ é †å†ç¨ç«‹ã€‚', s:'OKã€‚' },
    { id:'L2-12', type:'learner', scene:'è¡›æ•™åŠ å¼·ã€‚', t:'çµ¦è—¥OKï¼Œä½†è¡›æ•™é‚„éœ€åŠ å¼·ï¼Œå…ˆé‡å°é€™éƒ¨åˆ†ç·´ç¿’ã€‚', s:'å¥½ã€‚' }
  ]
};

let currentLevel = 1;
let answered = new Map(); // id -> user choice
let submitted = false;
const quiz = document.getElementById('quiz');

function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',900); }

async function logAnswer(payload){ try{ await fetch(GAS_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}); }catch(e){} }

function renderLevel(lv){
  currentLevel = lv; answered.clear(); submitted=false;
  document.getElementById('intro').textContent = `é—œå¡${lv}ï¼šè‡¨åºŠè¿·ä½ åŠ‡æœ¬ï¼Œè«‹æŠŠä¸‹åˆ—æƒ…å¢ƒåˆ†é¡ã€‚`;
  document.getElementById('result').style.display='none';
  quiz.innerHTML='';
  BANKS[lv].forEach(item=>{ quiz.appendChild(comicItem(item)); });
}

function comicItem(item){
  const el = document.createElement('div'); el.className='comic'; el.dataset.id=item.id; el.dataset.type=item.type;
  el.innerHTML = `
    <div class="scene">ğŸ“ ${item.scene}</div>
    <div class="frames">
      <div class="frame teacher"><div class="who">è€å¸«</div>${item.t}</div>
      <div class="frame learner"><div class="who">å­¸å“¡</div>${item.s || 'ï¼ˆâ€¦ï¼‰'}</div>
    </div>
    <div class="actions">
      <div class="pillbtn" data-ans="teacher">ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ</div>
      <div class="pillbtn" data-ans="learner">ğŸŒ± å­¸å“¡ä¸­å¿ƒ</div>
      <div class="pillbtn" data-ans="over">ğŸ’— éåº¦åŒ…å®¹</div>
    </div>
  `;
  el.querySelectorAll('.pillbtn').forEach(btn=>{ btn.addEventListener('click',()=>choose(item, btn.dataset.ans, el)); });
  return el;
}

function choose(item, ans, el){
  answered.set(item.id, ans);
  el.querySelectorAll('.pillbtn').forEach(b=>b.style.outline='');
  el.querySelector(`.pillbtn[data-ans="${ans}"]`).style.outline='3px solid var(--ring)';
  // log per-item
  logAnswer({
    tid:TID, group:GROUP, level:currentLevel, item_id:item.id,
    chosen:ans, correct:(ans===item.type), used_hint:0, time_ms:0,
    device_width:innerWidth, user_agent:navigator.userAgent
  });
}

document.getElementById('btnReset').addEventListener('click', ()=>renderLevel(currentLevel));

document.getElementById('btnSubmit').addEventListener('click', ()=>{
  const items = BANKS[currentLevel];
  let correct=0;
  items.forEach(it=>{ if(answered.get(it.id)===it.type) correct++; });
  document.getElementById('ok').textContent=correct;
  document.getElementById('bad').textContent=items.length - correct;
  document.getElementById('result').style.display='block';
  submitted = true;
  // summary log
  logAnswer({
    tid:TID, group:GROUP, level:currentLevel, item_id:'SUMMARY',
    chosen:correct + '/' + items.length, correct:true, used_hint:0, time_ms:0,
    device_width:innerWidth, user_agent:navigator.userAgent
  });
  toast('å·²é€å‡º');
});

// tabs
document.querySelectorAll('.leveltab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.leveltab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const lv = tab.dataset.level;
    if(lv==='H'){
      // Help section lock
      const modal = document.getElementById('helpModal');
      if(submitted || PRACTICE) modal.querySelector('.cardhelp').classList.remove('lock');
      else modal.querySelector('.cardhelp').classList.add('lock');
      modal.style.display='flex';
    } else {
      renderLevel(Number(lv));
    }
  });
});

document.getElementById('closeHelp').addEventListener('click', ()=>document.getElementById('helpModal').style.display='none');

// init
renderLevel(1);
</script>
</body>
</html>