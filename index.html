<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³ v7</title>
<style>
:root{
  --bg:#FFF6F8;
  --card:#fff;
  --ink:#1f2937;
  --muted:#6b7280;
  --brand:#6C79FF;
  --ok:#21c08b;
  --warn:#ffb84d;
  --bad:#ff7a88;
  --pink:#FFDCE5;
  --green:#EAFBF3;
  --yellow:#FFF6D8;
  --shadow:0 8px 20px rgba(0,0,0,.06);
  --radius:18px;
  --gap:10px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:
 radial-gradient(1000px 700px at 85% -10%, #ffe9f3 0, rgba(255,233,243,0) 70%), var(--bg);
 color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Inter","Noto Sans TC","Segoe UI",Roboto,Helvetica,Arial}
.wrap{max-width:880px;margin:0 auto;padding:10px 14px 80px}
.topbar{display:flex;align-items:center;justify-content:space-between;margin:4px 0 10px;gap:10px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:10px;background:var(--card);padding:10px 12px;border-radius:14px;box-shadow:var(--shadow)}
h1{margin:0;font-size:18px}
.tools{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:0;border-radius:12px;padding:10px 14px;background:var(--card);box-shadow:var(--shadow);font-weight:700;cursor:pointer}
.primary{background:linear-gradient(180deg,#7A86FF,#6C79FF);color:#fff}
.ghost{background:var(--card)}
.badge{font-size:12px;color:#4B5563;background:linear-gradient(180deg,#fff,#F6F9FF);border:1px solid #E8EBFF;padding:6px 10px;border-radius:999px}
.hintbar{margin:6px 0 10px;background:var(--card);border-left:6px solid #6C79FF;border-radius:10px;padding:10px 12px;box-shadow:var(--shadow);font-size:14px}
.stage{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:10px}
.scene{margin:8px 0;background:linear-gradient(180deg,#fff,#fdfdfd);border:1px solid rgba(0,0,0,.05);border-radius:16px;padding:10px}
.scene h3{margin:0 0 6px;font-size:14px;color:#111;display:flex;align-items:center;gap:8px}
.bubble{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:12px;padding:10px;margin:6px 0}
.choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
@media(min-width:560px){.choices{grid-template-columns:repeat(3,1fr)}}
.choice{user-select:none;background:#fff;border-radius:14px;border:1px solid rgba(0,0,0,.06);padding:14px;text-align:center;font-weight:800;box-shadow:var(--shadow);cursor:pointer}
.choice[data-k="teacher"]{background:linear-gradient(180deg,#fff,#ffe9f1)}
.choice[data-k="learner"]{background:linear-gradient(180deg,#fff,#eafbf3)}
.choice[data-k="over"]{background:linear-gradient(180deg,#fff,#fff6d8)}
.choice.active{outline:3px solid #6C79FF}
.footerbar{position:sticky;bottom:10px;left:0;right:0;display:flex;gap:8px;justify-content:center;margin-top:12px}
.pill{background:#fff;border-radius:999px;box-shadow:var(--shadow);padding:10px 14px}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);z-index:50;padding:14px}
.sheet{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:14px;max-width:520px;width:100%}
.sheet h3{margin:6px 0 10px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input[type=text]{width:100%;padding:12px 12px;border:1px solid #e5e7eb;border-radius:12px}
label{font-size:14px;color:#374151}
.small{font-size:12px;color:#6b7280}
.result{display:none;margin-top:8px;background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:12px}
.badlist{display:grid;grid-template-columns:1fr;gap:8px}
.baditem{background:linear-gradient(180deg,#fff,#fff9fc);border:1px solid #ffe1ea;border-radius:12px;padding:10px}
.baditem .rw{background:#f1fafd;border:1px dashed #bfe8ff;border-radius:10px;padding:8px;margin-top:6px}
.toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#111;color:#fff;border-radius:999px;padding:8px 12px;display:none;z-index:60}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand"><span>ğŸ“š</span><h1>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³</h1></div>
    <div class="tools">
      <button class="btn ghost" id="btnL1">é—œå¡1</button>
      <button class="btn ghost" id="btnL2">é—œå¡2</button>
      <button class="btn primary" id="btnHow">ğŸ‘€ é–‹å§‹éŠæˆ²å‰è«‹çœ‹æˆ‘</button>
    </div>
  </div>
  <div class="hintbar">ä»¥ä¸‹å°è©±æƒ…å¢ƒï¼Œä½ è¦ºå¾—æ˜¯ä»¥èª°ç‚ºä¸­å¿ƒå‘¢ï¼Ÿ</div>

  <section class="stage">
    <div id="pool"></div>
    <div class="result" id="result">
      <h3>çµæœ</h3>
      <p>æœ¬é—œç­”å° <b id="okn">0</b> é¡Œã€ç­”éŒ¯ <b id="wn">0</b> é¡Œã€‚</p>
      <div class="badlist" id="badlist"></div>
    </div>
  </section>

  <div class="footerbar">
    <button class="pill" id="btnReset">é‡ç½®æœ¬é—œ</button>
    <button class="pill primary" id="btnSubmit">é€å‡ºæœ¬é—œ</button>
  </div>
</div>

<!-- èº«åˆ†è¼¸å…¥ -->
<div class="modal" id="idModal">
  <div class="sheet">
    <h3>è«‹å…ˆè¼¸å…¥è­˜åˆ¥è³‡è¨Š</h3>
    <div class="row">
      <label>æ•™å¸«å§“åï¼ˆå¿…å¡«ï¼‰</label>
      <input type="text" id="tid" placeholder="ä¾‹å¦‚ï¼šç‹å°ç¾"/>
    </div>
    <div class="row">
      <label>å–®ä½ / éƒ¨é–€ï¼ˆå¿…å¡«ï¼‰</label>
      <input type="text" id="unit" placeholder="ä¾‹å¦‚ï¼š11B"/>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:6px">
      <button class="btn primary" id="btnStart">é–‹å§‹</button>
    </div>
  </div>
</div>

<!-- ç©æ³• -->
<div class="modal" id="howModal"><div class="sheet">
  <h3>ğŸ‘€ æ€éº¼ç©ï¼‹ç²¾ç¥å–Šè©±</h3>
  <p class="small">è®€æƒ…å¢ƒ â†’ é¸ä¸‰é¡ä¹‹ä¸€ï¼šğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒï½œğŸŒ± å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰ï½œğŸ’— éåº¦åŒ…å®¹ï¼ˆä¸å¥åº·ï¼‰ã€‚</p>
  <p class="small">é€å‡ºå¾Œæœƒçœ‹åˆ°è§£æèˆ‡ã€Œå­¸å“¡ä¸­å¿ƒè½‰è­¯ã€ã€‚</p>
  <div class="baditem">
    <div><b>ç²¾ç¥å–Šè©±ï¼š</b></div>
    <div class="rw">æˆ‘ç›¸ä¿¡æˆ‘æ˜¯ä¸€ä½<strong>ç¥éšŠå‹</strong>è€å¸«ï¼Œå­¸å¦¹ä¸€å®šèƒ½æ¥ä½æˆ‘å‚³çš„çƒï¼å‡¡äº‹ç™¼ç”Ÿçš†æ˜¯å¤©åŠ©æˆ‘ä¹Ÿï½<br/>æ”¶å¥½æˆ‘çš„ç™½çœ¼ã€å£“ä½æˆ‘çš„æ·±å‘¼å¸ï¼Œè®“ä»–ç›¸ä¿¡è‡ªå·±é‚„æœ‰æ•‘ï¼<br/>ä¸è¦è¡¨éœ²ã€ä¸è¦æ”¾æ£„ï¼Œæˆ‘å€‘éœ€è¦æ–°é®®çš„å¤¥ä¼´ä¸€èµ·ä¸Šç­ã€‚æƒ³æƒ³æˆ‘çš„æ’ç­ã€æƒ³æƒ³æˆ‘çš„ OFF Dayï½<br/><b>æˆ‘å¯ä»¥ï¼Œä»–ä¹Ÿä¸€å®šå¯ä»¥ï¼</b> ğŸ«¡</div>
  </div>
  <div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn primary" id="btnHowClose">æˆ‘çŸ¥é“äº†</button></div>
</div></div>

<div class="toast" id="toast">å·²å„²å­˜</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzfdyabwrsdhxau9k8IoeBEx4wTd_aCAd8hOh3WyCMJBlN9b4EbetSIkvssAZb5rVt_/exec";

// ===== é¡Œåº«ï¼ˆè‡¨åºŠç‰ˆï¼›ç§»é™¤ç”Ÿæ´»é¡åˆ¥ï¼‰ =====
const BANK_L1 = [
  {id:"L1-01", scene:"äº¤ç­å‰ã€‚", teacher:"æ˜¨å¤©è¨è«–éäº¤ç­ï¼Œä»Šå¤©äº¤ç­å‰æˆ‘å€‘å…ˆç·´ä¸€æ¬¡ï¼Œæ”¾è¼•é¬†ã€‚", student:"å¥½ã€‚", key:"learner",
    why:"çµ¦å¯æŒæ¡çš„æŒ‘æˆ°ï¼Œå…ˆç·´ç¿’å†ä¸Šå ´ã€‚", trans:"æˆ‘å…ˆç¤ºç¯„é‡é»ï¼Œæ¥è‘—ä½ åšï¼Œæˆ‘åœ¨æ—æŠŠé—œæ™‚é–“èˆ‡å®‰å…¨ã€‚"},
  {id:"L1-02", scene:"å¸¶æ•™å›é¥‹ã€‚", teacher:"æ€•æ‰“æ“Šä»–çš„ä¿¡å¿ƒï¼Œå°±èªªåšå¾—ä¸éŒ¯å§ã€‚", student:"ï¼ˆâ€¦ï¼‰", key:"over",
    why:"ä»¥ä¿è­·ç‚ºåé¿å…å›é¥‹ï¼Œç„¡åŠ©æå‡å“è³ªã€‚", trans:"å›é¥‹èšç„¦è¡Œç‚ºèˆ‡çµæœï¼Œæä¾›ä¸‹ä¸€æ­¥å…·é«”åšæ³•ã€‚"},
  {id:"L1-03", scene:"é€£çºŒç…§é¡§ã€‚", teacher:"ä½ å·²ç¶“å¡é€™æ®µç¬¬2æ¬¡ï¼Œéƒ½èªè­˜ç—…äººï¼Œæ‡‰è©²å¯ä»¥è‡ªå·±å»çµ¦è—¥å§ã€‚", student:"â€¦", key:"teacher",
    why:"ä»¥ä¸»è§€æ„Ÿè¦ºæ”¾æ‰‹ï¼Œæœªä»¥åˆ†ç´šæ¨™æº–èˆ‡æƒ…å¢ƒé¢¨éšªåˆ¤å®šã€‚", trans:"å°é½Š 3a çš„æ¨™æº–æƒ…å¢ƒï¼Œå…ˆåœ¨å¯é æœŸå ´æ™¯åŠç›£ç£æ”¾æ‰‹ã€‚"},
  {id:"L1-04", scene:"æŠ½è¡€ç·´ç¿’ã€‚", teacher:"å‰›å‰›çœ‹ä½ æŠ½è¡€é‚„ä¸ç†Ÿï¼Œç­‰ä¸€ä¸‹æˆ‘å†åšä¸€æ¬¡é‚Šèªªæ˜ï¼Œä¸‹ä¸€åºŠæ›ä½ æŠ½è¡€ï¼Œæˆ‘åœ¨æ—é‚Šå¹«ä½ ã€‚", student:"å¥½ï¼Œè¬è¬è€å¸«ã€‚", key:"learner",
    why:"ä¾è¡¨ç¾èª¿æ•´ç›£ç£å¼·åº¦ï¼Œæä¾›å¯æŒæ¡æŒ‘æˆ°ã€‚", trans:"å…ˆå£è¿°æ­¥é©Ÿå†å¯¦ä½œï¼Œæˆ‘æä¾›å³æ™‚å›é¥‹ã€‚"},
  {id:"L1-05", scene:"ç¤ºç¯„å¾Œã€‚", teacher:"é€™æ¬¡æˆ‘å…ˆåšç¤ºç¯„ï¼Œå­¸å“¡çœ‹å°±å¥½ã€‚", student:"â€¦", key:"teacher",
    why:"å–®å‘ç¤ºç¯„ï¼›æ‡‰å®‰æ’ç¤ºç¯„é‡é»èˆ‡éš¨å¾Œçš„ä¸Šæ‰‹ç·´ç¿’ã€‚", trans:"ç¤ºç¯„å¾Œè®“ä½ ç«‹å³åšä¸€æ¬¡ï¼Œæˆ‘åœ¨æ—æé†’é—œéµã€‚"},
  {id:"L1-06", scene:"äº¤ç­å£“åŠ›ã€‚", teacher:"ä»Šå¤©äº¤ç­å¾ˆè¶•ï¼Œå°±ä¸è¦è®“å­¸å“¡è¬›äº†ã€‚", student:"â€¦", key:"teacher",
    why:"æ™‚é–“å£“åŠ›ä¸‹ä»å¯ç”¨ã€é‡é»ç‰ˆäº¤ç­ã€ç¶­æŒç·´ç¿’èˆ‡æŠŠé—œã€‚", trans:"ä½ å…ˆè¬›é‡é»ç‰ˆï¼Œæˆ‘è£œç¼ºæ¼ä¸¦æ§æ™‚é–“èˆ‡é¢¨éšªã€‚"},
  {id:"L1-07", scene:"è¡›æ•™å“è³ªã€‚", teacher:"çµ¦è—¥OKï¼Œä½†è¡›æ•™é‚„éœ€åŠ å¼·ï¼Œå…ˆé‡å°é€™éƒ¨åˆ†ç·´ç¿’ã€‚", student:"å¥½ã€‚", key:"learner",
    why:"é‡å°å¼±é»åˆ‡å‡ºå¯ç·´çš„ç‰‡æ®µï¼Œå±¬å­¸å“¡ä¸­å¿ƒæ”¯æŒã€‚", trans:"å®šç¾©å…©å€‹è¡›æ•™è¦é»ï¼ŒçµæŸå¾Œæˆ‘çµ¦å…©æ¢å…·é«”å»ºè­°ã€‚"},
  {id:"L1-08", scene:"å®‰å…¨äº‹ä»¶å¾Œã€‚", teacher:"æ˜¨å¤©å…©æ¬¡é«˜é¢¨éšªéŒ¯èª¤ï¼Œä»Šå¤©æ”¹å›å…¨ç¨‹ç›£ç£ã€‚", student:"äº†è§£ã€‚", key:"learner",
    why:"ä¾é¢¨éšªå‹•æ…‹èª¿æ•´ç›£ç£å¼·åº¦ï¼Œå®‰å…¨å„ªå…ˆã€‚", trans:"å…ˆè¤‡ç›¤æ˜¨æ—¥éŒ¯èª¤ï¼Œåˆ—å‡ºé˜²å‘†æ¸…å–®å†æ”¾æ‰‹ã€‚"},
  {id:"L1-09", scene:"æº–å‚™ä¸è¶³ã€‚", teacher:"ä»–æ²’æº–å‚™ä¹Ÿæ²’é—œä¿‚ï¼Œä¸‹æ¬¡å†èªªã€‚", student:"â€¦", key:"over",
    why:"æ¨¡ç³Šæ¨™æº–ã€æ”¾ä»»å»¶å®•ã€‚", trans:"ç•Œå®šæœ€å°å®‰å…¨ä»»å‹™èˆ‡ä¸‹æ¬¡å‰å¿…å‚™æ¸…å–®ã€‚"},
];

const BANK_L2 = [
  {id:"L2-01", scene:"äº¤ç­è¨“ç·´ã€‚", teacher:"ä½ å…ˆè©¦ç”¨ ISBAR äº¤ç­ä¸€æ¬¡ï¼Œæˆ‘å€‘éŒ„ä¸‹ä¾†ä¸€èµ·å›é¡§ã€‚", student:"å¥½ã€‚", key:"learner",
    why:"çµæ§‹åŒ–å·¥å…· + è‡ªæˆ‘å›é¡§ï¼Œæå‡å“è³ªã€‚", trans:"éŒ„å®Œæˆ‘çµ¦å…©é»å¼·åŒ–é‡é»ï¼Œä¸‹æ¬¡å†åšä¸€æ¬¡ã€‚"},
  {id:"L2-02", scene:"ç¤ºç¯„èˆ‡æ”¾æ‰‹ã€‚", teacher:"æˆ‘åšä¸€æ¬¡å°±æ›ä½ ã€‚", student:"â€¦", key:"teacher",
    why:"éœ€ç•Œå®šç¤ºç¯„é‡é»èˆ‡æ”¾æ‰‹æƒ…å¢ƒæ¨™æº–ã€‚", trans:"æˆ‘åšé‡é»ç¤ºç¯„ï¼Œæ¥è‘—ä½ åœ¨æ¨™æº–æƒ…å¢ƒæ“ä½œï¼Œæˆ‘åŠç›£ç£ã€‚"},
  {id:"L2-03", scene:"åœ˜éšŠé—œä¿‚ã€‚", teacher:"ç‚ºäº†ä¸–ç•Œå’Œå¹³ï¼ŒéŒ¯èª¤å°±ä¸æäº†ã€‚", student:"â€¦", key:"over",
    why:"é¿å…è¡çªè€Œä¸è«‡éŒ¯èª¤ï¼Œæœƒè®“é¢¨éšªæŒçºŒã€‚", trans:"å›é¡§å…·é«”äº‹è­‰ï¼Œèšç„¦æ”¹é€²é»èˆ‡ä¸‹ä¸€æ­¥ã€‚"},
  {id:"L2-04", scene:"äº¤ç­æ™‚é–“ç·Šã€‚", teacher:"ä»Šå¤©äº¤ç­å¾ˆè¶•ï¼Œå°±ä¸è¦è®“å­¸å“¡è¬›äº†ã€‚", student:"â€¦", key:"teacher",
    why:"æ™‚é–“å£“åŠ›ä¸‹ä»å¯åˆ‡æˆã€é‡é»ç‰ˆäº¤ç­ã€ã€‚", trans:"ä½ è¬›é‡é»ï¼Œæˆ‘æŠŠé—œæ™‚é–“èˆ‡å®‰å…¨ã€‚"},
  {id:"L2-05", scene:"ç¤ºç¯„å¾Œã€‚", teacher:"é€™æ¬¡æˆ‘å…ˆåšç¤ºç¯„ï¼Œå­¸å“¡çœ‹æˆ‘å°±å¥½ã€‚", student:"â€¦", key:"teacher",
    why:"ç¤ºç¯„ä¸ç­‰æ–¼ç·´ç¿’ï¼›æ‡‰å®‰æ’è·Ÿåšç‰‡æ®µèˆ‡å›é¥‹ã€‚", trans:"ç¤ºç¯„å¾Œç«‹å³æ›ä½ åšä¸€æ¬¡ï¼Œæˆ‘åœ¨æ—å›é¥‹å…©é»ã€‚"},
  {id:"L2-06", scene:"DOPSã€‚", teacher:"æŠ½è¡€æŠ€å·§ä¸ç†Ÿï¼Œå…ˆç”¨ DOPS é›†ä¸­ç·´ä¸‰æ¬¡ã€‚", student:"å¥½ã€‚", key:"learner",
    why:"ç”¨ DOPS é‡å°å–®ä¸€æŠ€èƒ½ç·´ï¼Œæ”¯æ’ EPA ä»»å‹™ã€‚", trans:"é€£çºŒä¸‰æ¬¡ï¼Œæ¯æ¬¡å¾Œå³æ™‚å›é¥‹ã€‚"},
  {id:"L2-07", scene:"æ”¾æ‰‹åˆ¤æ–·ã€‚", teacher:"æˆ‘è¦ºå¾—å·®ä¸å¤šäº†ï¼Œè®“ä»–ç¨ç«‹ã€‚", student:"â€¦", key:"teacher",
    why:"ä»¥æ„Ÿè¦ºæ”¾æ‰‹ï¼Œæœªå°é½Šç­‰ç´š/æƒ…å¢ƒã€‚", trans:"ä¾ 3a/3b æ¨™æº–èˆ‡å ´æ™¯åˆ¤å®šï¼Œå…ˆåŠç›£ç£æ”¾æ‰‹ã€‚"},
  {id:"L2-08", scene:"éŒ„éŸ³å›é¡§ã€‚", teacher:"äº¤ç­å¸¸éºæ¼é‡é»ï¼ŒéŒ„éŸ³å›é¡§ä¸€æ¬¡ã€‚", student:"å¥½ã€‚", key:"learner",
    why:"è‡ªæˆ‘å›é¡§é…åˆçµæ§‹åŒ–æ¸…å–®å¯å¼·åŒ–å“è³ªã€‚", trans:"ç”¨æ¸…å–®é€é …æª¢æ ¸ï¼Œä¸‹ä¸€æ¬¡å¯¦ä½œé©—è­‰ã€‚"},
  {id:"L2-09", scene:"ä¿¡å¿ƒä¸è¶³ã€‚", teacher:"ä»–å·²èƒ½ä¾æ­¥é©Ÿå®Œæˆï¼Œä½†ä¿¡å¿ƒä¸è¶³ï¼Œçµ¦ä¸€æ¬¡ç¨ç«‹å®Œæˆæ©Ÿæœƒã€‚", student:"å¥½ã€‚", key:"learner",
    why:"æä¾›å¯æŒæ¡æŒ‘æˆ°ä»¥å¼·åŒ–è‡ªæ•ˆæ„Ÿã€‚", trans:"æˆ‘é ç«¯ç›£ç£ï¼Œä½ å…ˆè©¦ã€‚"},
  {id:"L2-10", scene:"å£“åŠ›å¤§ã€‚", teacher:"æ€•ä½ å—æŒ«ï¼Œå°±ä¸èªªå‰›å‰›å“ªè£¡ä¸å¥½ã€‚", student:"â€¦", key:"over",
    why:"å›é¿å›é¥‹æœƒé˜»æ–·æˆé•·ã€‚", trans:"èšç„¦è¡Œç‚ºèˆ‡çµæœï¼Œæå‡ºå¯èª¿æ•´æ­¥é©Ÿã€‚"},
  {id:"L2-11", scene:"æ™‚é–“å®‰æ’ã€‚", teacher:"ç­‰æˆ‘æœ‰ç©ºå†å¸¶ä»–ç·´ã€‚", student:"â€¦", key:"teacher",
    why:"ä»¥æ•™å¸«æ™‚é–“ç‚ºä¸­å¿ƒï¼Œç¼ºä¹è¦å¾‹å®‰æ’ã€‚", trans:"æ’çŸ­æ™‚æ®µå¾®æ¼”ç·´ï¼Œå»ºç«‹æ¯å¤©çš„ç·´ç¿’å¾ªç’°ã€‚"},
  {id:"L2-12", scene:"ä»»å‹™å§”è¨—ã€‚", teacher:"ä½ å…ˆåšä¸€æ¬¡ï¼Œæˆ‘åœ¨æ—å³æ™‚å›é¥‹ï¼Œé‡åˆ°é¢¨éšªæˆ‘æ¥æ‰‹ã€‚", student:"å¥½ï¼", key:"learner",
    why:"ç›£ç£å¼·åº¦å¯èª¿ï¼Œä¿å®‰å…¨ä¹Ÿä¿ç·´ç¿’ã€‚", trans:"æ¨™æº–æƒ…å¢ƒå…ˆåŠç›£ç£ï¼Œé€æ­¥èµ°å‘ç¨ç«‹ã€‚"},
];

let LEVEL = 1;
let sessionId = Date.now().toString(36)+Math.random().toString(36).slice(2,8);
let identity = {tid:"",unit:""};

const $pool = document.getElementById('pool');
const $result = document.getElementById('result');
const $badlist = document.getElementById('badlist');
const $okn = document.getElementById('okn');
const $wn = document.getElementById('wn');
const $toast = document.getElementById('toast');

document.getElementById('btnL1').onclick=()=>{LEVEL=1; render()}
document.getElementById('btnL2').onclick=()=>{LEVEL=2; render()}
document.getElementById('btnReset').onclick=()=>render();
document.getElementById('btnSubmit').onclick=submitLevel();
function submitLevel(){return ()=>{
  const data = currentBank().map(q=>{
    const sel = document.querySelector(`input[name="${q.id}"]:checked`);
    const chosen = sel? sel.value : "";
    return {id:q.id,chosen,truth:q.key, correct: (chosen===q.key), why:q.why, trans:q.trans, scene:q.scene, t:q.teacher, s:q.student};
  });
  const ok = data.filter(d=>d.correct).length;
  $okn.textContent = ok;
  $wn.textContent = data.length-ok;
  // æ¸²æŸ“è§£æ
  $badlist.innerHTML = "";
  data.filter(d=>!d.correct).forEach(d=>{
    const div=document.createElement('div');
    div.className='baditem';
    div.innerHTML = `<div><b>é¡Œç›®ï¼š</b>${d.scene}</div>
      <div class="small">ğŸ‘©â€ğŸ« è€å¸«ï¼š${d.t}</div>
      <div class="small">ğŸ‘¤ å­¸å“¡ï¼š${d.s}</div>
      <div style="margin-top:6px"><b>ä½ çš„ç­”æ¡ˆï¼š</b>${labelOf(d.chosen)}ã€€ï½œã€€<b>æ­£è§£ï¼š</b>${labelOf(d.truth)}</div>
      <div class="rw"><b>ç‚ºä»€éº¼ï¼Ÿ</b> ${d.why}<br/><b>å­¸å“¡ä¸­å¿ƒè½‰è­¯ï¼š</b> ${d.trans}</div>`;
    $badlist.appendChild(div);
  });
  $result.style.display='block';
  // å‚³ GAS summaryï¼ˆè‹¥è¦é€é¡Œå¯å†æ“´å……ï¼‰
  fetch(GAS_URL, {
    method:'POST', mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      type:'summary',
      tid:identity.tid, unit:identity.unit, session_id:sessionId,
      level: LEVEL, total:data.length, correct: ok,
      time_ms: 0, device_width: window.innerWidth, user_agent:navigator.userAgent
    })
  }).catch(()=>{});
}}

function labelOf(k){
  if(k==='teacher') return 'æ•™å¸«ä¸­å¿ƒ';
  if(k==='learner') return 'å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰';
  if(k==='over') return 'éåº¦åŒ…å®¹ï¼ˆä¸å¥åº·ï¼‰';
  return 'ï¼ˆæœªä½œç­”ï¼‰';
}

function currentBank(){ return LEVEL===1 ? BANK_L1 : BANK_L2 }

function card(q){
  const el=document.createElement('div');
  el.className='scene';
  el.innerHTML = `
    <h3>ğŸ“ ${q.scene}</h3>
    <div class="bubble">ğŸ‘©â€ğŸ« è€å¸«ï¼š${q.teacher}</div>
    <div class="bubble">ğŸ‘¤ å­¸å“¡ï¼š${q.student}</div>
    <div class="choices">
      <label class="choice" data-k="teacher">
        <input type="radio" name="${q.id}" value="teacher" hidden/>
        ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ
      </label>
      <label class="choice" data-k="learner">
        <input type="radio" name="${q.id}" value="learner" hidden/>
        ğŸŒ± å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰
      </label>
      <label class="choice" data-k="over">
        <input type="radio" name="${q.id}" value="over" hidden/>
        ğŸ’— éåº¦åŒ…å®¹ï¼ˆä¸å¥åº·ï¼‰
      </label>
    </div>`;
  el.querySelectorAll('.choice').forEach(ch=>{
    ch.addEventListener('click',()=>{
      el.querySelectorAll('.choice').forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      ch.querySelector('input').checked = true;
    });
  });
  return el;
}

function render(){
  $result.style.display='none';
  $pool.innerHTML='';
  shuffle(currentBank()).forEach(q=> $pool.appendChild(card(q)) );
  toast('å·²åˆ‡æ›åˆ°é—œå¡ '+LEVEL);
  document.scrollingElement.scrollTo({top: document.querySelector('.stage').offsetTop-10, behavior:'smooth'});
}

function shuffle(arr){arr=arr.slice(); for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]} return arr}

function toast(msg){$toast.textContent=msg;$toast.style.display='block';setTimeout(()=>{$toast.style.display='none'},800)}

// èº«åˆ†è¼¸å…¥èˆ‡ç©æ³•
const idModal=document.getElementById('idModal');
const howModal=document.getElementById('howModal');
document.getElementById('btnStart').onclick=()=>{
  const t=document.getElementById('tid').value.trim();
  const u=document.getElementById('unit').value.trim();
  if(!t||!u) return alert('è«‹å…ˆå®Œæˆå§“åèˆ‡å–®ä½');
  identity={tid:t,unit:u};
  idModal.style.display='none';
  render();
  setTimeout(()=> howModal.style.display='flex', 150);
};
document.getElementById('btnHow').onclick=()=> howModal.style.display='flex';
document.getElementById('btnHowClose').onclick=()=> howModal.style.display='none';

// åˆå§‹å½ˆå‡ºèº«ä»½çª—
window.addEventListener('load', ()=>{
  idModal.style.display='flex';
});
</script>
</body>
</html>
