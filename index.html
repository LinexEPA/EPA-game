<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³ï¼ˆv7ï¼‰</title>
<style>
:root{
  --bg:#FFF6FA;
  --panel:#ffffff;
  --ink:#222;
  --muted:#667085;
  --brand:#7c83ff;
  --brand2:#ff7aa2;
  --good:#55C595;
  --warn:#FFB84D;
  --bad:#FF7A88;
  --pink:#FFE8ED;
  --green:#E8FFF1;
  --yellow:#FFF2C6;
  --blue:#E9EDFF;
  --shadow:0 10px 24px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:ui-sans-serif, "Noto Sans TC","PingFang TC","Microsoft JhengHei", system-ui, -apple-system, Arial;
  background:
   radial-gradient(900px 500px at 80% -40%, #FFE3F1 0, rgba(255,227,241,0) 60%),
   radial-gradient(900px 600px at -10% 120%, #E9EDFF 0, rgba(233,237,255,0) 60%),
   var(--bg);
  color:var(--ink);
}
.wrap{max-width:1100px; margin:0 auto; padding:18px 14px 100px}
header{
  display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between; margin-bottom:10px;
}
.title{display:flex; align-items:center; gap:10px; padding:10px 14px; background:var(--panel); border-radius:14px; box-shadow:var(--shadow)}
.title h1{margin:0; font-size:18px}
.badge{font-size:12px; color:#4B5563; background:linear-gradient(180deg,#fff,#F6F9FF); border:1px solid #E8EBFF; padding:6px 10px; border-radius:999px}
.toolbar{display:flex; gap:8px; flex-wrap:wrap}
button{border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition:transform .05s ease}
button:active{transform:translateY(1px)}
.ghost{background:#fff}
.primary{background:linear-gradient(180deg,#7A86FF,#6C79FF); color:#fff}
.pink{background:linear-gradient(180deg,#ff9ec0,#ff7aa2); color:#fff}
.success{background:linear-gradient(180deg,#75D7A8,#55C595); color:#fff}
.danger{background:linear-gradient(180deg,#FFA0AD,#FF7A88); color:#fff}
.info{background:linear-gradient(180deg,#ffd1e2,#ffc6da);}

.banner{
  margin:8px 0 14px; padding:12px 14px; border-radius:14px;
  background:linear-gradient(180deg,#fff,#FFF0F6); display:flex; align-items:center; gap:8px;
  box-shadow:var(--shadow); color:#333;
}
.banner a{color:#6C79FF; text-decoration:none; font-weight:700}

.grid{display:grid; grid-template-columns:1fr; gap:12px}
@media(min-width:880px){ .grid{grid-template-columns:1.1fr 1fr 1fr 1fr} }

.pool, .bucket{min-height:160px; background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:12px}
.pool{background:linear-gradient(180deg,#ffffff,#FDFBFF)}
.bucket{position:relative}
.bucket[data-category="teacher"]{background:linear-gradient(180deg,#ffffff, var(--pink))}
.bucket[data-category="learner"]{background:linear-gradient(180deg,#ffffff, var(--green))}
.bucket[data-category="over"]{background:linear-gradient(180deg,#ffffff, var(--yellow))}

.bucket h3{margin:0 0 8px; font-size:15px; display:flex; align-items:center; gap:8px}
.bucket h3 span{font-size:20px}
.cards{display:flex; flex-wrap:wrap; gap:8px}
.card{
  user-select:none; -webkit-user-drag:none; touch-action:none;
  background:var(--panel); border-radius:14px; padding:12px 12px; min-width:180px; max-width:260px; flex:1 0 180px;
  box-shadow:var(--shadow); cursor:grab; border:1px solid rgba(0,0,0,.04);
  transition:transform .15s ease, box-shadow .15s ease;
}
.card.small{min-width:140px}
.card.dragging{opacity:.9; transform:rotate(2deg) scale(1.03)}
.card.follow{position:fixed; z-index:9999; pointer-events:none; transform:translate(-50%,-50%) scale(1.03);} 
.drop-highlight{outline:2px dashed rgba(0,0,0,.15); outline-offset:-6px}
.bucket.hover{outline:3px solid rgba(108,121,255,.35); outline-offset:-6px}

.footer{margin-top:14px; display:flex; flex-wrap:wrap; gap:8px; align-items:center}
.pill{background:#fff; border-radius:999px; padding:6px 10px; box-shadow:var(--shadow); font-size:12px}
#progress{font-weight:700}

.result, .modal, .sheet{display:none}
.result{margin-top:16px; background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:14px}
.result h3{margin:0 0 8px}
.badlist{display:grid; grid-template-columns: 1fr; gap:8px}
@media(min-width:760px){.badlist{grid-template-columns: 1fr 1fr}}
.baditem{background:linear-gradient(180deg,#fff,#FFF9FB); border:1px solid #FFE1E6; border-radius:14px; padding:10px}
.baditem .rewrite{margin-top:6px; background:#F0FFF7; border:1px dashed #BEE8D2; padding:8px; border-radius:10px; font-size:14px}

.modal{position:fixed; inset:0; background:rgba(0,0,0,.2); align-items:flex-end; justify-content:center; z-index:9998}
.sheet{background:#fff; border-radius:18px 18px 0 0; padding:16px; box-shadow:0 -10px 30px rgba(0,0,0,.15); width:100%}
.sheet h4{margin:4px 6px 10px}
.choices{display:flex; gap:10px}
.choice{flex:1; padding:12px; border-radius:14px; border:1px solid rgba(0,0,0,.08); display:flex; gap:8px; align-items:center; justify-content:center}
.choice[data-target="teacher"]{background:var(--pink)}
.choice[data-target="learner"]{background:var(--green)}
.choice[data-target="over"]{background:var(--yellow)}

.toast{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111; color:#fff; padding:10px 14px; border-radius:999px; font-size:14px; display:none; z-index:9999}
.confetti{position:fixed; inset:0; pointer-events:none; z-index:9997}

#idGate{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.85); z-index:10000}
#idCard{background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:18px; width:min(560px,92vw)}
#idCard h2{margin:0 0 12px}
.input{display:flex; flex-direction:column; gap:6px; margin:10px 0}
.input input{padding:10px 12px; border-radius:12px; border:1px solid #E5E7EB; font-size:16px}
.row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between}

#how{display:none; position:fixed; inset:0; background:rgba(0,0,0,.3); align-items:center; justify-content:center; z-index:9999}
.howcard{background:#fff; padding:18px; border-radius:16px; width:min(700px,95vw); box-shadow:var(--shadow)}
.howcard h3{margin:0 0 8px}
.howcard ul{margin:8px 0 0 20px}
</style>
</head>
<body>
<div id="idGate">
  <div id="idCard">
    <h2>è«‹å…ˆè¼¸å…¥è­˜åˆ¥è³‡è¨Š</h2>
    <div class="row">
      <div class="input" style="flex:1 1 260px">
        <label>æ•™å¸«å§“åï¼ˆå¿…å¡«ï¼‰</label>
        <input id="tid" placeholder="ä¾‹å¦‚ï¼šç‹å°ç¾"/>
      </div>
      <div class="input" style="flex:1 1 220px">
        <label>å–®ä½ / éƒ¨é–€ï¼ˆå¿…å¡«ï¼‰</label>
        <input id="unit" placeholder="ä¾‹å¦‚ï¼š11B"/>
      </div>
    </div>
    <div class="row">
      <div class="pill" style="background:#F3F4FF">æ­¡è¿åŠ å…¥ï¼Œå¡«å¯«å¾Œé»ã€Œé–‹å§‹ã€ï¼šä»Šå¤©ä¸€èµ·ç”¨ã€Œæƒ…å¢ƒåˆ†é¡ã€æ„Ÿå— EPA çš„æ€è·¯ï¼</div>
      <button id="btnStart" class="primary">é–‹å§‹</button>
    </div>
  </div>
</div>

<div id="how">
  <div class="howcard">
    <h3>ğŸ‘€ éŠæˆ²æ€éº¼ç©ï¼Ÿï¼ˆ30 ç§’ï¼‰</h3>
    <ul>
      <li>æŠŠæ¯å¼µå°è©±å¡ç‰‡æ‹–åˆ°æ­£ç¢ºçš„é¡åˆ¥ï¼š<b>æ•™å¸«ä¸­å¿ƒ</b>ã€<b>å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰</b>ã€<b>éåº¦åŒ…å®¹ï¼ˆä¸å¥åº·ï¼‰</b>ã€‚</li>
      <li>æ‰‹æ©Ÿå¯ã€Œé»å¡ç‰‡ã€â†’ é¸é¡åˆ¥ï¼›æˆ–é•·æŒ‰æ‹–æ›³ã€‚</li>
      <li>é€å‡ºå¾Œæœƒé¡¯ç¤ºè§£æèˆ‡ã€Œè¿·æ€åœ°åœ–ã€ï¼Œå¹«ä½ çœ‹æ‡‚ç‚ºä»€éº¼ã€‚</li>
      <li>æ¯é—œé”æ¨™æœƒç‘èŠ± ğŸ‰ï¼Œä¸¦æŠŠçµæœè¨˜éŒ„åˆ°ä½ çš„å„€è¡¨æ¿ã€‚</li>
    </ul>
    <div class="row" style="margin-top:10px">
      <div class="pill">ç²¾ç¥å–Šè©±ï¼š<br/>æˆ‘ç›¸ä¿¡æˆ‘æ˜¯ä¸€ä½ç¥éšŠå‹è€å¸«ï¼Œå­¸å¦¹ä¸€å®šèƒ½æ¥ä½æˆ‘å‚³çš„çƒï¼å‡¡äº‹ç™¼ç”Ÿçš†æ˜¯å¤©åŠ©æˆ‘ä¹Ÿï½æ”¶å¥½æˆ‘çš„ç™½çœ¼ã€å£“ä½æˆ‘çš„æ·±å‘¼å¸ï¼Œè®“ä»–ç›¸ä¿¡è‡ªå·±é‚„æœ‰æ•‘ï¼ä¸è¦æ”¾æ£„ï¼Œæˆ‘å€‘éœ€è¦æ–°é®®å¤¥ä¼´ä¸€èµ·ä¸Šç­ã€‚æƒ³æƒ³æˆ‘çš„æ’ç­ã€æƒ³æƒ³æˆ‘çš„ OFF Dayï½æˆ‘å¯ä»¥ï¼Œä»–ä¹Ÿä¸€å®šå¯ä»¥ï¼</div>
      <button class="primary" onclick="closeHow()">æˆ‘æº–å‚™å¥½äº† ğŸ’ª</button>
    </div>
  </div>
</div>

<canvas class="confetti" id="confetti"></canvas>
<div class="toast" id="toast">å·²æ”¾ç½®</div>

<div class="wrap">
  <header>
    <div class="title">
      <span style="font-size:20px">ğŸ“š</span>
      <h1>ç‚ºä»€éº¼è¦æœ‰ EPAï¼Ÿï½œå¿«æ€æ…¢æƒ³</h1>
      <span class="badge">å¯æ„›é¦¬å¡é¾ Â· å…©éšæ®µéŠæˆ² + çµ±è¨ˆ Â· è§¸æ§æ‹–æ›³ / é»é¸</span>
    </div>
    <div class="toolbar">
      <button class="ghost" id="btnL1">é—œå¡1</button>
      <button class="ghost" id="btnL2">é—œå¡2</button>
      <button class="pink" id="btnHow">é–‹å§‹éŠæˆ²å‰è«‹çœ‹æˆ‘</button>
      <button class="ghost" id="btnReset">é‡ç½®æœ¬é—œ</button>
      <button class="primary" id="btnCheck">é€å‡ºæœ¬é—œ</button>
      <button class="ghost" id="btnMap">ğŸ—ºï¸ğŸ¶ è¿·æ€åœ°åœ–</button>
    </div>
  </header>

  <div class="banner" id="guideBanner">
    <b>ğŸ‘€ ä»¥ä¸‹å°è©±æƒ…å¢ƒï¼Œä½ è¦ºå¾—æ˜¯ä»¥èª°ç‚ºä¸­å¿ƒå‘¢ï¼Ÿ</b>
    <span class="pill">ä¸ç¢ºå®šï¼Ÿé»å³ä¸Šæ–¹ã€Œé–‹å§‹éŠæˆ²å‰è«‹çœ‹æˆ‘ã€</span>
  </div>

  <div class="grid">
    <section class="pool" id="pool">
      <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:8px">ğŸƒ å¾…åˆ†é¡å¡ç‰‡</h3>
      <div class="cards" id="poolCards"></div>
    </section>

    <section class="bucket" data-category="teacher">
      <h3><span>ğŸ‘©â€ğŸ«</span> æ•™å¸«ä¸­å¿ƒ</h3>
      <div class="cards"></div>
    </section>

    <section class="bucket" data-category="learner">
      <h3><span>ğŸŒ±</span> å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰</h3>
      <div class="cards"></div>
    </section>

    <section class="bucket" data-category="over">
      <h3><span>ğŸ’—</span> éåº¦åŒ…å®¹ï¼ˆä¸å¥åº·ï¼‰</h3>
      <div class="cards"></div>
    </section>
  </div>

  <div class="footer">
    <span class="pill">æ‰‹æ©Ÿï¼šé•·æŒ‰æ‹–æ›³ï¼Œæˆ–é»å¡ç‰‡é¸åˆ†é¡</span>
    <span class="pill" id="hintRemain">æç¤ºï¼šæœ¬é—œå¯ç”¨ Ã— <b>2</b></span>
    <span class="pill" id="progress">0 / 0 å·²åˆ†é¡</span>
  </div>

  <section class="result" id="result">
    <h3>çµæœèˆ‡è§£æ</h3>
    <p style="margin:0 0 10px">æœ¬é—œåˆ†æ•¸ï¼š<b id="score">0</b> åˆ†ã€‚ä¸‹æ–¹æ˜¯éœ€è¦ä¿®æ­£çš„é¡Œç›®èˆ‡èªªæ˜ã€‚</p>
    <div class="badlist" id="badlist"></div>
    <div class="row" style="margin-top:10px">
      <button class="ghost" id="btnAgain">å†ç©ä¸€æ¬¡</button>
      <button class="primary" id="btnToL2">å‰å¾€é—œå¡2</button>
    </div>
  </section>
</div>

<!-- Mobile choice modal -->
<div class="modal" id="modal">
  <div class="sheet">
    <h4>æŠŠé€™å¥è©±æ”¾åˆ°å“ªä¸€é¡ï¼Ÿ</h4>
    <div class="choices">
      <div class="choice" data-target="teacher">ğŸ‘©â€ğŸ« æ•™å¸«ä¸­å¿ƒ</div>
      <div class="choice" data-target="learner">ğŸŒ± å­¸å“¡ä¸­å¿ƒ</div>
      <div class="choice" data-target="over">ğŸ’— éåº¦åŒ…å®¹</div>
    </div>
    <div style="margin-top:10px; font-size:13px; color:#6b7280">æ²’æœ‰æŠŠæ¡ï¼Ÿæœ¬é—œå¯ä½¿ç”¨ã€Œæç¤ºã€æœƒçµ¦ 50/50 ç·šç´¢èˆ‡ä¸€æ®µèªªæ˜ã€‚</div>
  </div>
</div>

<script>
/*** ====== è¨­å®š ====== ***/
const GAS_URL = "https://script.google.com/macros/s/AKfycbzfdyabwrsdhxau9k8IoeBEx4wTd_aCAd8hOh3WyCMJBlN9b4EbetSIkvssAZb5rVt_/exec";

// é¡Œåº«ï¼ˆå…©é—œï¼‰
const LEVELS = {
 L1: {
  hint: 2,
  pass: 7,
  items: [
    {id:"L1-01", text:"ä½ ä»Šå¤©å¾ˆç´¯ä¸è¦åšå®¶äº‹äº†ï¼Œæˆ‘å…¨åŒ…ã€‚", type:"over", reason:"æ¨¡ç³Šæ¨™æº–ã€æ”¾ä»»å»¶å®•ï¼Œç„¡åŠ©æ–¼å­¸ç¿’èˆ‡å®‰å…¨ã€‚", rewrite:"å…ˆç•Œå®šæœ€å°å®‰å…¨ä»»å‹™ï¼Œçµ¦æ˜ç¢ºé æœŸèˆ‡ä¸‹æ¬¡å‰è¦é”åˆ°çš„æº–å‚™ã€‚"},
    {id:"L1-02", text:"ä½ å…ˆè¬›ä»Šæ™šçš„ç´„æœƒæµç¨‹ï¼Œæˆ‘å†è£œå……é—œéµã€‚", type:"learner", reason:"å¼·èª¿å¯è§€å¯Ÿè¡Œç‚ºèˆ‡å…·é«”å›é¥‹ï¼Œæ”¯æ´æˆé•·å¾ªç’°ã€‚"},
    {id:"L1-03", text:"é€™æ¬¡æˆ‘å…ˆç¤ºç¯„ï¼Œå­¸å“¡çœ‹å°±å¥½ã€‚", type:"teacher", reason:"ä»¥æ•™å¸«æ•ˆç‡ç‚ºä¸­å¿ƒï¼›æœªæä¾›å¯å§”è¨—ç‰‡æ®µèˆ‡å›é¥‹å¾ªç’°ã€‚", rewrite:"åˆ‡å‡ºä½é¢¨éšªç‰‡æ®µè®“å­¸å“¡åšï¼Œæˆ‘åœ¨æ—é‚Šå³æ™‚å›é¥‹ã€‚"},
    {id:"L1-04", text:"æ€•ä½ å—æŒ«ï¼Œå°±ä¸èªªå‰›å‰›å“ªè£¡åšå¾—ä¸å¥½ã€‚", type:"over", reason:"ä»¥ä¿è­·ç‚ºåè¿´é¿å›é¥‹ï¼Œå‰Šå¼±å­¸ç¿’æˆæ•ˆã€‚", rewrite:"å›é¥‹èšç„¦åœ¨è¡Œç‚ºèˆ‡çµæœï¼Œä¸¦çµ¦ä¸‹ä¸€æ­¥å…·é«”ä½œæ³•ã€‚"},
    {id:"L1-05", text:"ä»Šå¤©äº¤ç­å¾ˆè¶•ï¼Œå°±ä¸è¦è®“å­¸å“¡è¬›äº†ã€‚", type:"teacher", reason:"ç”¨æ™‚é–“å£“åŠ›å–ä»£å­¸ç¿’æ©Ÿæœƒï¼›æœªè¨­è¨ˆä½é¢¨éšªçš„å¯å§”è¨—ç‰‡æ®µã€‚", rewrite:"è®“å­¸å“¡å…ˆåšç²¾è¦ç‰ˆï¼Œæˆ‘è£œé—œéµä¸¦æ§åˆ¶é¢¨éšªã€‚"},
    {id:"L1-06", text:"ä½ åªè¦è² è²¬å¯æ„›å°±å¥½ï¼Œå…¶ä»–æˆ‘ä¾†ã€‚", type:"over", reason:"å‰å¥ªç·´ç¿’æ©Ÿæœƒä¸”ç„¡æˆé•·è²¬ä»»ã€‚", rewrite:"åˆ‡å‡ºå¯å§”è¨—ç‰‡æ®µï¼Œè®“ä»–åœ¨æˆ‘ç›£ç£ä¸‹è² è²¬ä¸€å°æ®µã€‚"},
    {id:"L1-07", text:"ä»–å·²èƒ½ä¾æ­¥é©Ÿå®Œæˆï¼Œä½†ä¿¡å¿ƒä¸è¶³ï¼Œçµ¦ä¸€æ¬¡ç¨ç«‹å®Œæˆçš„æ©Ÿæœƒã€‚", type:"learner", reason:"ä¾è¡¨ç¾èª¿æ•´ç›£ç£å¼·åº¦ï¼Œæä¾›å¯æŒæ¡æŒ‘æˆ°ã€‚"},
    {id:"L1-08", text:"ä»–æŠ½è¡€æŠ€å·§é‚„ä¸ç†Ÿï¼Œå…ˆç”¨ DOPS é›†ä¸­ç·´ä¸‰æ¬¡ã€‚", type:"learner", reason:"ä»¥ DOPS å¼·åŒ–å–®ä¸€æŠ€èƒ½ï¼Œç”¨æ–¼æ”¯æ’ EPA ä»»å‹™è¡¨ç¾ã€‚"},
    {id:"L1-09", text:"æˆ‘è¦ºå¾—å·®ä¸å¤šäº†ï¼Œå¯ä»¥æ”¾æ‰‹è®“ä»–åšã€‚", type:"teacher", reason:"ä»¥ä¸»è§€æ„Ÿè¦ºæ”¾æ‰‹ï¼Œæœªä»¥åˆ†ç´šæ¨™æº–èˆ‡æƒ…å¢ƒé¢¨éšªåˆ¤å®šã€‚", rewrite:"æ”¹ç‚ºï¼šç¬¦åˆ 3a æ¨™æº–æƒ…å¢ƒï¼Œå†åœ¨åŠç›£ç£ä¸‹æ”¾æ‰‹ã€‚"},
  ]
 },
 L2: {
  hint: 2,
  pass: 10,
  items: [
    {id:"L2-01", text:"å‰›çœ‹ä½ æŠ½è¡€é‚„ä¸ç†Ÿï¼Œç­‰ä¸€ä¸‹æˆ‘å†åšä¸€æ¬¡é‚Šèªªæ˜ï¼Œä¸‹ä¸€åºŠæ›ä½ æŠ½ï¼Œæˆ‘æœƒåœ¨æ—é‚Šå¹«ä½ ã€‚", type:"learner", reason:"åˆ†æ®µå§”è¨—èˆ‡å³æ™‚å›é¥‹ã€‚"},
    {id:"L2-02", text:"æ˜¨å¤©å…©æ¬¡é«˜é¢¨éšªéŒ¯èª¤ï¼Œä»Šå¤©æ”¹å›å…¨ç¨‹ç›£ç£ã€‚", type:"learner", reason:"ä¾é¢¨éšªå‹•æ…‹èª¿æ•´ç›£ç£å¼·åº¦ï¼Œç¢ºä¿å®‰å…¨ç‚ºå…ˆã€‚"},
    {id:"L2-03", text:"ç‚ºäº†åœ˜éšŠå’Œå¹³ï¼ŒéŒ¯èª¤å°±å…ˆä¸æäº†ã€‚", type:"over", reason:"éŒ¯èª¤ä¸è¢«é‡æ¸…ï¼Œæœƒè®“é¢¨éšªæŒçºŒã€‚", rewrite:"æ¡è¡Œä¸‰æ˜æ²»å›é¥‹ + å…·é«”äº‹å¯¦ã€‚"},
    {id:"L2-04", text:"äº¤ç­æ™‚é–“ç·Šï¼Œä»Šå¤©å°±ä¸è¦è®“å­¸å“¡è¬›äº†ã€‚", type:"teacher", reason:"ä»¥æ™‚é–“ç‚ºç”±å‰å¥ªå­¸ç¿’æ©Ÿæœƒã€‚", rewrite:"è®“å­¸å“¡å…ˆåšé‡é»ç‰ˆï¼Œæˆ‘è£œå……é—œéµã€‚"},
    {id:"L2-05", text:"é€™æ¬¡æˆ‘å…ˆåšç¤ºç¯„ï¼Œå­¸å“¡çœ‹å°±å¥½ã€‚", type:"teacher", reason:"å–®å‘ç¤ºç¯„ï¼›æ‡‰å®‰æ’æ“¦èº«ç·´ç¿’èˆ‡é€æ­¥ä¸Šæ‰‹ç·´ç¿’ã€‚"},
    {id:"L2-06", text:"ä»–éƒ½æ–°äººï¼Œå…ˆä¸è¦è®“ä»–åšä»»ä½•äº‹ã€‚", type:"over", reason:"ç„¡ç·´ç¿’èˆ‡æˆé•·è²¬ä»»ã€‚", rewrite:"åˆ‡å‡ºå¯å§”è¨—ç‰‡æ®µï¼Œåœ¨ç›£ç£ä¸‹å˜—è©¦ã€‚"},
    {id:"L2-07", text:"å·²åœ¨å¸¸è¦ç—…äººè¡¨ç¾ç©©å®šï¼Œå…ˆè®“ä»–åœ¨æ¨™æº–æƒ…å¢ƒåŠç›£ç£ç¨ç«‹ã€‚", type:"learner", reason:"å°æ‡‰ç­‰ç´šæƒ…å¢ƒæ”¾æ‰‹ã€‚"},
    {id:"L2-08", text:"äº¤ç­å…§å®¹å¸¸éºæ¼é‡é»ï¼Œè®“ä»–ç”¨ ISBAR çµæ§‹ç·´ç¿’ä¸¦éŒ„éŸ³å›é¡§ã€‚", type:"learner", reason:"çµæ§‹åŒ–å·¥å…· + è‡ªæˆ‘å›é¡§ã€‚"},
    {id:"L2-09", text:"ä»Šå¤©äº¤ç­å¾ˆè¶•ï¼Œå°±æˆ‘ä¾†è¬›ã€‚", type:"teacher", reason:"åŒ L2-04ã€‚"},
    {id:"L2-10", text:"æ€•æ‰“æ“Šä¿¡å¿ƒï¼Œå°±èªªåšå¾—ä¸éŒ¯å§ã€‚", type:"over", reason:"ä»¥ä¿è­·ç‚ºåè¿´é¿å›é¥‹ã€‚", rewrite:"å®¢è§€æè¿° + ä¸‹ä¸€æ­¥ã€‚"},
    {id:"L2-11", text:"æˆ‘ä¾†è™•ç†å°±å¥½ï¼Œä¸ç”¨éº»ç…©ä»–ã€‚", type:"over", reason:"å‰å¥ªç·´ç¿’æ©Ÿæœƒã€‚"},
    {id:"L2-12", text:"æˆ‘æœƒå…ˆè§€å¯Ÿä¸€æ¬¡ï¼ŒçµæŸçµ¦ 2 æ¢å…·é«”å»ºè­°ã€‚", type:"learner", reason:"å…·é«”å¯è¡Œå›é¥‹ã€‚"},
  ]
 }
};

// ç‹€æ…‹
let current = 'L1';
let hintLeft = LEVELS[current].hint;
let activeCard = null;
let pointerDragging=false; let dragOffsetX=0, dragOffsetY=0; let originParent=null; let currentHoverBucket=null;
let sessionId = Date.now()+"-"+Math.random().toString(36).slice(2,8);
let TID=null, UNIT=null;

// DOM
const $pool = document.getElementById('poolCards');
const $buckets = [...document.querySelectorAll('.bucket')];
const $progress = document.getElementById('progress');
const $result = document.getElementById('result');
const $badlist = document.getElementById('badlist');
const $score = document.getElementById('score');
const $toast = document.getElementById('toast');
const $modal = document.getElementById('modal');
const $hintRemain = document.getElementById('hintRemain');

// æº–å‚™
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

function makeCard(item){
  const el=document.createElement('div');
  el.className='card';
  el.textContent=item.text;
  el.dataset.key=item.id;
  el.draggable=true;
  // Mouse drag
  el.addEventListener('dragstart', e=>{el.classList.add('dragging'); e.dataTransfer.setData('text/plain', item.id);});
  el.addEventListener('dragend', ()=>el.classList.remove('dragging'));
  // Tap-to-place
  el.addEventListener('click', ()=>{ if(pointerDragging) return; activeCard=el; $modal.style.display='flex'});
  // Pointer touch-drag
  el.addEventListener('pointerdown', (e)=>{
    if(e.pointerType!=='touch') return;
    e.preventDefault();
    activeCard=el; pointerDragging=true; originParent=el.parentElement;
    const rect=el.getBoundingClientRect();
    dragOffsetX=e.clientX - rect.left - rect.width/2;
    dragOffsetY=e.clientY - rect.top - rect.height/2;
    el.classList.add('follow');
    el.style.width=rect.width+'px';
    moveFollow(el, e.clientX - dragOffsetX, e.clientY - dragOffsetY);
    window.addEventListener('pointermove', onPointerMove, {passive:false});
    window.addEventListener('pointerup', onPointerUp, {once:true});
  });
  return el;
}
function renderPool(){
  const bank=[...LEVELS[current].items];
  shuffle(bank);
  $pool.innerHTML='';
  bank.forEach(it=> $pool.appendChild(makeCard(it)) );
  // æ¸…ç©ºæ¡¶
  $buckets.forEach(b=> b.querySelector('.cards').innerHTML='');
  hintLeft = LEVELS[current].hint; $hintRemain.innerHTML=`æç¤ºï¼šæœ¬é—œå¯ç”¨ Ã— <b>${hintLeft}</b>`;
  updateProgress();
  $result.style.display='none';
}
function updateProgress(){
  const total=LEVELS[current].items.length;
  const placed= total - $pool.querySelectorAll('.card').length;
  $progress.textContent=`${placed} / ${total} å·²åˆ†é¡`;
}

$buckets.forEach(b=>{
  const box=b.querySelector('.cards');
  b.addEventListener('dragover', e=>{e.preventDefault(); box.classList.add('drop-highlight')});
  b.addEventListener('dragleave', ()=> box.classList.remove('drop-highlight'));
  b.addEventListener('drop', e=>{
    e.preventDefault();
    const key=e.dataTransfer.getData('text/plain');
    const card=[...document.querySelectorAll('.card')].find(c=>c.dataset.key===key);
    if(card){ box.appendChild(card); showToast('å·²æ”¾ç½®'); }
    box.classList.remove('drop-highlight');
    updateProgress();
  });
});

$modal.addEventListener('click', (e)=>{
  if(e.target.classList.contains('choice')){
    const target=e.target.dataset.target;
    const bucket=document.querySelector(`.bucket[data-category="${target}"] .cards`);
    if(activeCard && bucket){ bucket.appendChild(activeCard); showToast('å·²æ”¾ç½®'); }
    $modal.style.display='none'; activeCard=null; updateProgress();
  } else if(e.target.id==='modal'){ $modal.style.display='none'; activeCard=null; }
});

function showToast(msg){$toast.textContent=msg; $toast.style.display='block'; setTimeout(()=>{$toast.style.display='none'},900)}

function getBucketAt(x,y){
  const els = document.elementsFromPoint(x,y);
  return els.find(e=> e.classList && e.classList.contains('bucket')) || null;
}
function clearHover(){ if(currentHoverBucket){ currentHoverBucket.classList.remove('hover'); currentHoverBucket=null; } }
function moveFollow(el, x, y){ el.style.left=x+'px'; el.style.top=y+'px'; el.style.transform='translate(-50%, -50%) scale(1.03)'; }
function onPointerMove(e){ if(!pointerDragging||!activeCard) return; e.preventDefault();
  moveFollow(activeCard, e.clientX - dragOffsetX, e.clientY - dragOffsetY);
  const b = getBucketAt(e.clientX, e.clientY); if(b!==currentHoverBucket){ clearHover(); if(b){ b.classList.add('hover'); currentHoverBucket=b; } }
}
function onPointerUp(e){
  window.removeEventListener('pointermove', onPointerMove);
  if(!activeCard) return;
  if(currentHoverBucket){ currentHoverBucket.classList.remove('hover'); currentHoverBucket.querySelector('.cards').appendChild(activeCard); showToast('å·²æ”¾ç½®'); }
  else { originParent && originParent.appendChild(activeCard); }
  activeCard.classList.remove('follow'); activeCard.style.left=''; activeCard.style.top=''; activeCard.style.width=''; activeCard.style.transform='';
  activeCard=null; pointerDragging=false; clearHover(); updateProgress();
}

// æª¢æŸ¥
function checkAnswers(){
  let correct=0; let wrong=[]; const total=LEVELS[current].items.length;
  const map = Object.fromEntries(LEVELS[current].items.map(it=>[it.id,it]));
  document.querySelectorAll('.card').forEach(card=>{
    const key=card.dataset.key; const answer=map[key].type;
    const parentBucket = card.closest('.bucket');
    const user = parentBucket ? parentBucket.dataset.category : 'pool';
    if(user===answer){ correct++; sparkle(card) } 
    else { if(user!=='pool') wrong.push({item:map[key], user}) }
  });
  const score = Math.round( (correct/total) * 100 );
  $score.textContent=score;
  $badlist.innerHTML='';
  wrong.forEach(w=>{
    const div=document.createElement('div'); div.className='baditem';
    const shouldLabel = w.item.type==='teacher'?'æ•™å¸«ä¸­å¿ƒ': w.item.type==='learner'?'å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰':'éåº¦åŒ…å®¹ï¼ˆä¸å¥åº·ï¼‰';
    const userLabel = w.user==='teacher'?'æ•™å¸«ä¸­å¿ƒ': w.user==='learner'?'å­¸å“¡ä¸­å¿ƒï¼ˆè²¬ä»»åˆ†ç´šï¼‰':'éåº¦åŒ…å®¹ï¼ˆä¸å¥åº·ï¼‰';
    div.innerHTML=`<div><b>ä½ çš„ç­”æ¡ˆï¼š</b>${userLabel}ã€€ï¼ã€€<b>æ­£è§£ï¼š</b>${shouldLabel}</div><div style="margin-top:6px">${w.item.text}</div>`;
    const rw=document.createElement('div'); rw.className='rewrite';
    rw.innerHTML= (w.item.rewrite? `<b>å­¸å“¡ä¸­å¿ƒè½‰è­¯ï¼š</b>${w.item.rewrite}<br>` : '') + `<span style="color:#6b7280"><b>ç‚ºä»€éº¼ï¼Ÿ</b> ${w.item.reason||'â€”'}</span>`;
    div.appendChild(rw);
    $badlist.appendChild(div);
  })
  $result.style.display='block';
  // é€šé—œ
  if( (current==='L1' && correct>=LEVELS.L1.pass) || (current==='L2' && correct>=LEVELS.L2.pass) ){ celebrate(); }

  // ç´€éŒ„ï¼šsummary + æ¯é¡Œ
  logSummary(score, correct, total);
}
async function logSummary(score, correct, total){
  try{
    const payload={
      tid:TID, unit:UNIT, level: current==='L1'?1:2,
      result:`${correct}/${total}`, correct_rate:(correct/total).toFixed(2),
      time_ms: 0,
      device_width: window.innerWidth||0,
      user_agent: navigator.userAgent,
      session_id: sessionId,
      type:'summary'
    };
    await fetch(GAS_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  }catch(e){ console.warn(e) }
}

// å½©èŠ±
const canvas=document.getElementById('confetti'); const ctx=canvas.getContext('2d'); function resize(){canvas.width=innerWidth; canvas.height=innerHeight} window.addEventListener('resize', resize); resize();
function celebrate(){
  const pieces=[...Array(140)].map(()=>({x:Math.random()*canvas.width, y:-20, r:6+Math.random()*8, vy:2+Math.random()*3, vx:(Math.random()-.5)*2, a:Math.random()*360, col: ['#FFB3C1','#BDE5D2','#FDE49C','#C9C8FF'][Math.floor(Math.random()*4)]}));
  let t=0; (function tick(){ctx.clearRect(0,0,canvas.width,canvas.height); pieces.forEach(p=>{p.y+=p.vy; p.x+=p.vx; p.a+=5; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a*Math.PI/180); ctx.fillStyle=p.col; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore()}); t++; if(t<180) requestAnimationFrame(tick); else ctx.clearRect(0,0,canvas.width,canvas.height)})();
}
function sparkle(el){ /* çœç•¥ï¼šåƒ…åˆ†æ•¸è¨ˆç®—ç”¨ */ }

// UI ç¶å®š
document.getElementById('btnCheck').addEventListener('click', checkAnswers);
document.getElementById('btnReset').addEventListener('click', renderPool);
document.getElementById('btnAgain').addEventListener('click', renderPool);
document.getElementById('btnToL2').addEventListener('click', ()=>{ current='L2'; renderPool(); });
document.getElementById('btnL1').addEventListener('click', ()=>{ current='L1'; renderPool(); });
document.getElementById('btnL2').addEventListener('click', ()=>{ current='L2'; renderPool(); });
document.getElementById('btnMap').addEventListener('click', ()=>{ document.getElementById('how').style.display='flex'; });
document.getElementById('btnHow').addEventListener('click', ()=>{ document.getElementById('how').style.display='flex'; });
function closeHow(){ document.getElementById('how').style.display='none'; }
window.closeHow = closeHow;

// èº«ä»½ gate
document.getElementById('btnStart').addEventListener('click', ()=>{
  const t=document.getElementById('tid').value.trim();
  const u=document.getElementById('unit').value.trim();
  if(!t || !u){ alert('è«‹å¡«å¯«å§“åèˆ‡å–®ä½'); return }
  TID=t; UNIT=u;
  document.getElementById('idGate').style.display='none';
  renderPool();
});
// åˆæ¬¡è¼‰å…¥ï¼šç›´æ¥é¡¯ç¤º gateï¼›ç•«é¢ä¸æœƒæœ‰é ‚éƒ¨ç©ºç™½éœ€è¦ä¸‹æ»‘
renderPool(); // å…ˆç®—å‡ºé€²åº¦èˆ‡ç‰ˆä½ï¼ˆæœƒè¢« gate è“‹ä½ï¼‰
</script>
</body>
</html>
